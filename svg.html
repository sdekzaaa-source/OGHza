<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Item Manager - Muji Style</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer.min.js"></script>

    <style>
        :root {
            /* --- Muji Palette --- */
            --bg-body: #f7f7f2;         /* Creamy White background */
            --bg-sidebar: #ebe9e1;      /* Warm Beige sidebar */
            --bg-card: #ffffff;         /* Pure White cards */
            --bg-input: #f2f2ed;        /* Light input background */
            
            --primary: #8c7b70;         /* Muted Earth/Wood */
            --primary-hover: #6d5e53;
            --secondary: #a8a29e;       /* Stone Gray */
            
            --text-main: #4a4540;       /* Soft Dark Gray/Brown */
            --text-muted: #9ca3af;
            
            --danger: #ef4444;          
            --success: #65a30d;         
            --warning: #d97706;         
            
            --border-color: #e5e5e5;
            
            --sidebar-width: 260px;
            --header-h: 64px;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 14px;
            overflow-x: hidden;
            display: flex;
            height: 100vh;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .w-full { width: 100%; }

        /* --- LOGIN --- */
        #login-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(247, 247, 242, 0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 12px;
            border: 1px solid var(--border-color); text-align: center; width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .login-title { font-size: 20px; margin-bottom: 20px; color: var(--primary); letter-spacing: 2px; font-weight: 600; }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: var(--bg-input); border: 1px solid var(--border-color);
            border-radius: 6px; color: var(--text-main); text-align: center; font-size: 16px;
        }
        .login-input:focus { border-color: var(--primary); background: white; }
        .login-btn {
            width: 100%; padding: 12px; background: var(--primary); color: white; border: none;
            border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .login-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }

        .blur-content { filter: blur(4px); pointer-events: none; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); background: var(--bg-sidebar);
            border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column;
            position: fixed; top: 0; bottom: 0; left: 0; z-index: 50;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 25px 20px; text-align: center; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .sidebar-header h2 { margin: 0; font-size: 18px; color: var(--text-main); font-weight: 500; letter-spacing: 1px; }

        .header-controls {
            display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px;
        }
        .version-tag { font-size: 10px; color: var(--text-muted); background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; }
        
        .lang-toggle { display: flex; gap: 4px; }
        .btn-lang {
            background: transparent; border: 1px solid #d1d5db; color: var(--text-muted);
            padding: 3px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; transition: 0.2s;
        }
        .btn-lang.active { background: var(--primary); color: white; border-color: var(--primary); }

        .menu-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .menu-group { margin-bottom: 25px; }
        .menu-label { 
            padding: 0 10px 8px; font-size: 11px; color: var(--text-muted); font-weight: 600; letter-spacing: 1px; 
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.03); margin-bottom: 5px;
        }
        .btn-add-cat { cursor: pointer; font-size: 16px; color: var(--primary); }
        .btn-add-cat:hover { transform: scale(1.1); }

        .menu-item {
            padding: 10px 12px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: space-between;
            border-radius: 6px; margin-bottom: 4px; color: var(--text-main); font-size: 14px;
        }
        .menu-item:hover { background: rgba(255,255,255,0.5); }
        .menu-item.active { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.03); color: var(--primary); font-weight: 500; }
        .menu-item.drag-over-cat { background: #e0f2fe; color: #0284c7; }
        .nav-icon { width: 24px; text-align: center; margin-right: 8px; display: inline-block; }
        
        .btn-del-cat {
            opacity: 0; font-size: 14px; color: var(--text-muted); cursor: pointer; padding: 2px 6px; border-radius: 4px;
            transition: 0.2s;
        }
        .menu-item:hover .btn-del-cat { opacity: 1; }
        .btn-del-cat:hover { background: #fee2e2; color: var(--danger); }

        .sidebar-footer { padding: 15px; background: rgba(0,0,0,0.02); display: flex; gap: 8px; border-top: 1px solid rgba(0,0,0,0.05); }
        .footer-btn {
            flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer;
            font-size: 12px; font-weight: 600; transition: 0.2s; color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-push { background: var(--success); }
        .btn-pull { background: var(--secondary); }
        .footer-btn:hover { filter: brightness(0.95); transform: translateY(-1px); }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1; margin-left: var(--sidebar-width); padding: 30px 40px;
            transition: all 0.3s; width: calc(100% - var(--sidebar-width));
        }

        .section-title {
            margin-bottom: 25px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-color); padding-bottom: 15px;
        }
        .section-title h1 { margin: 0; font-size: 24px; color: var(--text-main); font-weight: 400; }

        /* --- GRID --- */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px; width: 100%;
        }

        .item-card {
            background: var(--bg-card); border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid transparent;
            transition: all 0.2s; cursor: grab; height: 100%; position: relative;
        }
        .item-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); border-color: #e5e5e5; }
        .item-card:active { cursor: grabbing; }

        .svg-display {
            height: 140px; width: 100%; display: flex; align-items: center; justify-content: center;
            margin-bottom: 10px; overflow: hidden; border-radius: 8px; background: #fafafa;
        }
        .svg-display svg { width: 100%; height: 100%; object-fit: contain; }
        .svg-display.flipped { transform: scaleX(-1); }

        .item-card h3 { 
            margin: 0 0 10px 0; font-size: 14px; color: var(--text-main); text-align: center; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; font-weight: 500;
        }

        .btn-row { display: flex; gap: 6px; width: 100%; margin-top: auto; justify-content: center; }
        .btn-icon {
            border: 1px solid #f0f0f0; background: white; color: var(--text-muted);
            width: 30px; height: 30px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 12px;
        }
        .btn-icon:hover { background: #f9fafb; color: var(--primary); border-color: var(--primary); }
        .btn-icon.del:hover { background: #fee2e2; color: var(--danger); border-color: #fecaca; }

        /* --- EMPTY STATE --- */
        .empty-state {
            grid-column: 1/-1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 80px 0; color: var(--text-muted); text-align: center;
            border: 2px dashed #e5e5e5; border-radius: 16px;
            background: #fafafa;
        }
        .empty-icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
        .empty-text { font-size: 16px; font-weight: 500; }

        /* --- FORMS & PANELS --- */
        .content-card {
            background: var(--bg-card); border-radius: 12px; padding: 30px;
            width: 100%; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid var(--border-color);
        }

        .tab-header { display: flex; gap: 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-btn {
            padding: 10px 0; background: none; border: none; font-size: 14px; color: var(--text-muted);
            cursor: pointer; border-bottom: 2px solid transparent; transition: 0.2s;
        }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 13px; font-weight: 500; }
        .form-control {
            width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border-color);
            border-radius: 8px; color: var(--text-main); font-size: 14px; transition: 0.2s;
        }
        .form-control:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(140, 123, 112, 0.1); }

        .main-btn {
            width: 100%; padding: 12px; background: var(--primary); color: white; border: none;
            border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;
            transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .main-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }

        .btn-outline {
            width: 100%; padding: 12px; background: transparent; color: var(--text-muted); border: 1px solid var(--border-color);
            border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.2s;
        }
        .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); }
        .btn-outline.active { border-color: var(--primary); color: var(--primary); background: #fcfbf9; }

        /* Import Dropzone */
        .dropzone {
            border: 2px dashed #d1d5db; border-radius: 12px; padding: 60px 20px;
            text-align: center; background: #f9fafb; cursor: pointer; transition: 0.3s; color: var(--text-muted);
        }
        .dropzone:hover { border-color: var(--primary); background: #fcfbf9; color: var(--primary); }

        /* AI Section */
        .ai-box { background: #faf5ff; border: 1px solid #e9d5ff; padding: 20px; border-radius: var(--radius-lg); margin-bottom: 20px; }
        .ai-loader { height: 4px; background: #e9d5ff; border-radius: 2px; margin-top: 20px; overflow: hidden; display: none; }
        .ai-progress { height: 100%; background: #a855f7; width: 50%; animation: scan 1.5s infinite ease-in-out; }
        @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }

        /* --- TOAST --- */
        .msg-toast {
            position: fixed; bottom: 30px; right: 30px; background: var(--text-main); color: white;
            padding: 12px 25px; border-radius: var(--radius-md); box-shadow: var(--shadow-md);
            z-index: 10000; opacity: 0; pointer-events: none; transition: 0.3s; font-size: 13px;
        }
        .msg-toast.show { opacity: 1; transform: translateY(-10px); }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 420px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        .modal-content h3 { margin-top: 0; color: var(--text-main); font-weight: 500; }

        /* Emoji Grid */
        .emoji-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 8px;
            max-height: 180px; overflow-y: auto; padding: 10px; background: var(--bg-input);
            border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-bottom: 20px;
        }
        .emoji-item {
            cursor: pointer; font-size: 20px; text-align: center; padding: 6px;
            border-radius: 6px; transition: background 0.2s;
        }
        .emoji-item:hover { background: rgba(0,0,0,0.05); }
        .emoji-item.selected { background: var(--primary); color: white; }

        .menu-toggle { display: none; font-size: 20px; background: none; border: none; cursor: pointer; color: var(--text-main); margin-right: 15px; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 280px; box-shadow: 5px 0 20px rgba(0,0,0,0.05); }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 45; display: none; }
            .sidebar-overlay.show { display: block; }
            .main-content { margin-left: 0; padding: 20px; width: 100%; }
            .menu-toggle { display: block !important; }
        }
    </style>
</head>
<body>

    <!-- Login -->
    <div id="login-overlay">
        <div class="login-box">
            <div style="font-size: 40px; margin-bottom: 10px;">üçÉ</div>
            <div class="login-title">MAGIC ITEM</div>
            <input type="password" id="login-pass" class="login-input" placeholder="Passcode" onkeypress="handleLoginEnter(event)">
            <div id="login-error" style="color:var(--danger); font-size:12px; margin-top:5px; height:20px;"></div>
            <button class="login-btn" onclick="checkLogin()">Enter</button>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="app-container" class="blur-content flex h-screen">
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Magic Item Manager</h2>
                <div class="header-controls">
                    <span class="version-tag">v1.6</span>
                    <div class="lang-toggle">
                        <button class="btn-lang active" id="lang-th" onclick="setLanguage('th')">TH</button>
                        <button class="btn-lang" id="lang-en" onclick="setLanguage('en')">EN</button>
                    </div>
                </div>
            </div>
            
            <div class="menu-scroll">
                <div class="menu-group">
                    <div class="menu-label">
                        <span id="label-categories">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span>
                        <span class="btn-add-cat" onclick="openModal('modal-category')">Ôºã</span>
                    </div>
                    <div id="sidebar-categories"></div>
                </div>

                <div class="menu-group">
                    <div class="menu-label" id="label-manage">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
                    <div class="menu-item" onclick="showSection('import-unified', this)">
                        <div class="menu-item-content"><span class="nav-icon">üì•</span> <span id="menu-import">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (Import)</span></div>
                    </div>
                    <div class="menu-item" onclick="showSection('ai-gen', this)">
                        <div class="menu-item-content"><span class="nav-icon">‚ú®</span> <span id="menu-aigen">AI Creator</span></div>
                    </div>
                    <div class="menu-item" onclick="showSection('trash-bin', this)">
                        <div class="menu-item-content"><span class="nav-icon">üóëÔ∏è</span> <span id="menu-trash">‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</span></div>
                    </div>
                </div>

                <div class="menu-group">
                    <div class="menu-label">SYSTEM</div>
                    <div class="menu-item" onclick="openGithubModal()">
                        <div class="menu-item-content"><span class="nav-icon">‚öôÔ∏è</span> <span>Config GitHub</span></div>
                    </div>
                    <div class="menu-item" onclick="openAiConfigModal()">
                        <div class="menu-item-content"><span class="nav-icon">üîë</span> <span id="menu-ai-config">AI Config</span></div>
                    </div>
                    <div class="menu-item" onclick="backupAll()">
                        <div class="menu-item-content"><span class="nav-icon">üíæ</span> <span id="menu-backup">Backup JSON</span></div>
                    </div>
                    <div class="menu-item" onclick="openModal('modal-restore')">
                        <div class="menu-item-content"><span class="nav-icon">üì§</span> <span id="menu-restore">Restore JSON</span></div>
                    </div>
                    <div class="menu-item" onclick="downloadDB()">
                         <div class="menu-item-content"><span class="nav-icon">‚¨áÔ∏è</span> <span id="menu-download">Download DB</span></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="footer-btn btn-push" onclick="syncToGitHub('push')">üöÄ PUSH</button>
                <button class="footer-btn btn-pull" onclick="syncToGitHub('pull')">‚òÅÔ∏è PULL</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="section-title">
                <div style="display:flex; align-items:center;">
                    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <h1 id="view-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</h1>
                </div>
            </header>

            <!-- Items Grid -->
            <div id="section-category-view" class="content-section">
                <div class="item-grid" id="items-display-grid"></div>
            </div>

            <!-- Unified Import (Code + Image) -->
            <div id="section-import-unified" class="content-section hidden">
                <div class="content-card">
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="switchImportTab('code', this)" id="tab-code-btn">‡πÇ‡∏Ñ‡πâ‡∏î (SVG Code)</button>
                        <button class="tab-btn" onclick="switchImportTab('img', this)" id="tab-img-btn">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image)</button>
                    </div>

                    <!-- Image Tab -->
                    <div id="tab-img-content" class="hidden">
                        <div style="display:flex; gap:10px; margin-bottom:20px;">
                            <button class="btn-outline active mode-btn" id="mode-embed" onclick="setImportMode('embed')">Embed (‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏°)</button>
                            <button class="btn-outline mode-btn" id="mode-trace" onclick="setImportMode('trace')">Vector (‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô)</button>
                        </div>
                        
                        <div class="dropzone" id="import-dropzone" 
                             onclick="document.getElementById('file-input').click()"
                             ondragover="handleImportDragOver(event)" 
                             ondragleave="handleImportDragLeave(event)" 
                             ondrop="handleImportDrop(event)">
                             <div style="font-size:32px; margin-bottom:10px; opacity:0.5;">üñºÔ∏è</div>
                             <p id="dropzone-text">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (Ctrl+V)</p>
                             <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFileSelect(event)">
                        </div>

                        <div id="import-preview-area" class="hidden" style="margin-top:20px;">
                            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                                <div style="flex:1; text-align:center; background:#fcfbf9; padding:10px; border-radius:8px; border:1px solid #eee;">
                                    <label>Original</label><br>
                                    <img id="img-preview" style="max-width:100%; max-height:150px; object-fit:contain;">
                                </div>
                                <div style="flex:1; text-align:center; background:#fcfbf9; padding:10px; border-radius:8px; border:1px solid #eee;">
                                    <label>Result SVG</label><br>
                                    <div id="svg-preview-cont" style="display:flex; justify-content:center; height:150px;"></div>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:15px;">
                                <button class="btn-outline" style="flex:1" onclick="removeBackgroundSimple()">‚úÇÔ∏è ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß</button>
                                <button class="btn-outline" style="flex:1" onclick="generateSVG()">‚ö° ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                            </div>
                            
                            <div class="form-group" style="margin-top:20px;">
                                <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</label>
                                <input type="text" id="import-img-name" class="form-control" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°...">
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button class="main-btn" style="flex:2;" onclick="saveImportedItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save)</button>
                                <button class="btn-outline" style="flex:1; color:var(--danger); border-color:var(--danger);" onclick="resetImport()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            </div>
                        </div>
                    </div>

                    <!-- Code Tab (Default) -->
                    <div id="tab-code-content">
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</label>
                            <input type="text" id="code-item-name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>SVG Code</label>
                            <textarea id="code-item-svg" class="form-control" style="height:200px; font-family:monospace;" placeholder="<svg>...</svg>"></textarea>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="main-btn" style="flex:2;" onclick="saveCodeItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save)</button>
                            <button class="btn-outline" style="flex:1; color:var(--danger); border-color:var(--danger);" onclick="clearCodeImport()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Gen -->
            <div id="section-ai-gen" class="content-section hidden">
                <div class="content-card">
                    <div class="ai-box">
                        <div class="form-group">
                            <label id="lbl-ai-name" style="color:#6b21a8;">Item Name</label>
                            <input type="text" id="ai-prompt-name" class="form-control" placeholder="e.g. Dragon Sword">
                        </div>
                        <div class="form-group">
                            <label id="lbl-ai-ref" style="color:#6b21a8;">Ref. (Game/Anime)</label>
                            <input type="text" id="ai-prompt-ref" class="form-control" placeholder="e.g. Ragnarok Online, Zelda">
                        </div>
                        <div class="form-group">
                            <label id="lbl-ai-detail" style="color:#6b21a8;">Detail</label>
                            <textarea id="ai-prompt-detail" class="form-control" rows="3" placeholder="e.g. Glowing blue blade with gold hilt..."></textarea>
                        </div>

                        <div style="display:flex; gap:10px;">
                            <button class="main-btn" style="background:#9333ea;" onclick="generateAiSvg()">‚ú® Generate</button>
                            <button class="btn-outline" style="width:auto;" onclick="resetAiGen()">Clear</button>
                        </div>
                        <div id="ai-loading" class="hidden" style="margin-top:20px; text-align:center; color:#9333ea;">
                            AI is creating...
                        </div>
                    </div>

                    <div id="ai-result-area" class="hidden">
                        <div style="background:#fcfbf9; padding:20px; text-align:center; border-radius:8px; margin-bottom:20px; border:1px solid #eee;">
                            <div id="ai-svg-output" style="height:150px; display:flex; justify-content:center; align-items:center;"></div>
                        </div>
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏° (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</label>
                            <input type="text" id="ai-item-name" class="form-control">
                        </div>
                        <button class="main-btn" onclick="saveAiItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save)</button>
                    </div>
                </div>
            </div>

            <!-- Trash Bin -->
            <div id="section-trash-bin" class="content-section hidden">
                <div class="item-grid" id="trash-display-grid"></div>
            </div>

        </main>
    </div>

    <!-- Common Modals -->
    <div id="modal-category" class="modal-overlay">
        <div class="modal-content">
            <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</h3>
            <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="cat-name-input" class="form-control"></div>
            <div class="form-group"><label>‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</label>
                <div id="emoji-selection" class="emoji-grid"></div>
            </div>
            <!-- Hidden real input -->
            <input type="hidden" id="cat-icon-input">
            
            <div style="display:flex; gap:10px;">
                <button class="main-btn" onclick="saveCategory()">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
                <button class="btn-outline" onclick="closeModal('modal-category')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="modal-github" class="modal-overlay">
        <div class="modal-content">
            <h3>GitHub Config</h3>
            <div class="form-group"><label>User</label><input type="text" id="gh-user" class="form-control"></div>
            <div class="form-group"><label>Repo</label><input type="text" id="gh-repo" class="form-control"></div>
            <div class="form-group"><label>Token</label><input type="password" id="gh-token" class="form-control"></div>
            <div class="form-group"><label>File Path</label><input type="text" id="gh-path" class="form-control" value="magic-items-db.json"></div>
            <div style="display:flex; gap:10px;">
                <button class="main-btn" onclick="syncToGitHub('push')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & Push</button>
                <button class="btn-outline" onclick="closeModal('modal-github')">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div id="modal-ai-config" class="modal-overlay">
        <div class="modal-content">
            <h3>AI Configuration</h3>
            <div style="font-size:12px; color:#666; margin-bottom:15px;">‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Default)</div>
            <div class="form-group">
                <label>Gemini API Key</label>
                <input type="password" id="gemini-api-key" class="form-control" placeholder="AIzaSy...">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="main-btn" onclick="saveAiConfig()">Save</button>
                <button class="btn-outline" onclick="closeModal('modal-ai-config')">Close</button>
            </div>
        </div>
    </div>

    <div id="modal-restore" class="modal-overlay">
        <div class="modal-content">
            <h3>Restore JSON</h3>
            <div class="form-group"><textarea id="restore-input" class="form-control" style="height:150px;"></textarea></div>
            <div style="display:flex; gap:10px;">
                <button class="main-btn" style="background:var(--warning);" onclick="processRestore()">Merge & Restore</button>
                <button class="btn-outline" onclick="closeModal('modal-restore')">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div id="toast" class="msg-toast">Message</div>

    <script>
        // --- 1. CONFIG & AUTH ---
        const _p1="sdek", _p2="zasvg", _p3="1234";
        const SESSION_MS = 7*24*60*60*1000;
        const _pool = [
            { k1: "AIzaSyDyyR4vfovqTD7WsuKg", k2: "jyNmS5HT3-GCtow" },
            { k1: "AIzaSyBmYB-nlMaFNkPxI-BWRQ8k", k2: "n02wbE5ybB8" }
        ];
        let activeKeyIndex = 0;

        // --- EMOJIS FOR CATEGORIES ---
        const categoryEmojis = [
            "üéí", "üì¶", "üëú", "üíº", "ü™µ", "ü™®", "üíé", "üß∂", "üßµ", "üõ†Ô∏è",
            "‚öîÔ∏è", "üó°Ô∏è", "üèπ", "üõ°Ô∏è", "ü™ì", "üî®", "üî´", "üí£", "üß®", "üß±",
            "üîÆ", "ü™Ñ", "üìú", "üè∫", "‚öóÔ∏è", "üßø", "üíç", "üëë", "‚ö±Ô∏è", "üóø",
            "üåø", "üçÑ", "üå∑", "üåπ", "üåª", "üå≤", "üåµ", "üçÅ", "üçÇ", "üçÉ",
            "üî•", "üíß", "üå™Ô∏è", "‚ö°", "‚ùÑÔ∏è", "‚òÄÔ∏è", "üåô", "‚≠ê", "üåà", "‚òÅÔ∏è"
        ];

        // --- 2. STATE ---
        let currentLang = 'th';
        let categories = [
            { id: 'cat-imports', name: 'Imports', icon: 'üì•' },
            { id: 'cat-ai-gen', name: 'AI Gen', icon: '‚ú®' },
            { id: 'cat-consumables', name: 'Consumables', icon: 'üì¶' },
            { id: 'cat-treasures', name: 'Treasures', icon: 'üíé' },
            { id: 'cat-restore', name: 'Restore', icon: 'üì¶' }
        ];
        let items = [];
        let trash = [];
        let currentCatId = 'cat-imports';
        let importMode = 'embed';
        let currentGeneratedSvg = '', originalImgData = '', currentAiSvg = '';
        let draggedItemId = null;
        let selectedEmoji = 'üìÅ';

        // --- 3. INIT ---
        window.onload = function() {
            checkSession();
            loadLocal();
            applyLanguage();
            renderSidebar();
            renderItems();
            renderEmojiPicker();
            setupPasteListener();
        };

        // --- 4. CORE FUNCTIONS ---
        function checkSession() {
            const t = localStorage.getItem('auth_token');
            if(t && Date.now() - t < SESSION_MS) hideLogin(); else showLogin();
        }
        function checkLogin() {
            if(document.getElementById('login-pass').value === _p1+_p2+_p3) {
                localStorage.setItem('auth_token', Date.now()); hideLogin();
            } else { document.getElementById('login-error').innerText = "Wrong Password"; }
        }
        function showLogin() { document.getElementById('login-overlay').style.display='flex'; document.getElementById('app-container').classList.add('blur-content'); }
        function hideLogin() { document.getElementById('login-overlay').style.display='none'; document.getElementById('app-container').classList.remove('blur-content'); }
        function handleLoginEnter(e) { if(e.key === 'Enter') checkLogin(); }

        function loadLocal() {
            const d = localStorage.getItem('muji_db_v2');
            if(d) {
                try {
                    const j = JSON.parse(d);
                    if(j.categories) categories = j.categories;
                    if(j.items) items = j.items;
                    if(j.trash) trash = j.trash;
                } catch(e) {}
            }
        }
        function saveLocal() {
            localStorage.setItem('muji_db_v2', JSON.stringify({categories, items, trash}));
        }

        // --- 5. RENDER ---
        function renderSidebar() {
            const div = document.getElementById('sidebar-categories');
            div.innerHTML = categories.map(c => {
                const isSystem = ['cat-imports','cat-ai-gen','cat-restore'].includes(c.id);
                const delBtn = isSystem ? '' : `<span class="btn-del-cat" onclick="deleteCategory('${c.id}', event)">√ó</span>`;
                
                return `<div class="menu-item ${c.id === currentCatId ? 'active' : ''}" 
                     onclick="selectCategory('${c.id}', this)"
                     ondragover="handleDragOverCat(event)" ondragleave="handleDragLeaveCat(event)" ondrop="handleDropCat(event, '${c.id}')">
                     <div class="menu-item-content"><span class="nav-icon">${c.icon}</span> <span>${c.name}</span></div>
                     ${delBtn}
                </div>`;
            }).join('');
        }

        function renderEmojiPicker() {
            const grid = document.getElementById('emoji-selection');
            grid.innerHTML = categoryEmojis.map(emoji => 
                `<div class="emoji-item" onclick="selectEmoji('${emoji}', this)">${emoji}</div>`
            ).join('');
        }

        function selectEmoji(emoji, el) {
            selectedEmoji = emoji;
            document.getElementById('cat-icon-input').value = emoji; // Sync hidden input if needed
            document.querySelectorAll('.emoji-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
        }

        function renderItems() {
            const grid = document.getElementById('items-display-grid');
            const filtered = items.filter(i => i.catId === currentCatId);
            
            // Empty State
            if(filtered.length === 0) { 
                grid.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üçÉ</div>
                    <div class="empty-text">No items here yet</div>
                </div>`; 
                return; 
            }
            
            grid.innerHTML = filtered.map(i => `
                <div class="item-card" draggable="true" ondragstart="handleDragStart(event, '${i.id}')" ondragend="handleDragEnd(event)">
                    <h3>${i.name}</h3>
                    <div class="svg-display" id="svg-cont-${i.id}">${i.svg}</div>
                    <div class="btn-row">
                        <button class="btn-icon" onclick="editName('${i.id}')" title="Edit Name">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="copySVG('${i.id}')" title="Copy SVG">üìã</button>
                        <button class="btn-icon" onclick="flipItem('${i.id}')" title="Flip Horizontal">‚ÜîÔ∏è</button>
                        <button class="btn-icon del" onclick="moveToTrash('${i.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTrash() {
            const grid = document.getElementById('trash-display-grid');
            if(trash.length===0) { 
                grid.innerHTML=`
                <div class="empty-state">
                    <div class="empty-icon">üóëÔ∏è</div>
                    <div class="empty-text">Trash is empty</div>
                </div>`; 
                return; 
            }
            grid.innerHTML = trash.map(i => `
                <div class="item-card" style="opacity:0.7;">
                    <h3>${i.name}</h3> <div class="svg-display">${i.svg}</div>
                    <div class="btn-row">
                        <button class="btn-outline w-full" style="font-size:12px;" onclick="restoreItem('${i.id}')">Restore</button>
                        <button class="btn-outline w-full" style="font-size:12px; color:var(--danger); border-color:var(--danger);" onclick="deleteForever('${i.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // --- 6. ACTIONS ---
        function selectCategory(id, el) {
            currentCatId = id; showSection('category-view'); 
            const cat = categories.find(c=>c.id===id);
            document.getElementById('view-title').innerText = cat ? cat.name : 'Items';
            document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
            if(el) el.classList.add('active');
            renderItems();
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s=>s.classList.add('hidden'));
            document.getElementById(`section-${id}`).classList.remove('hidden');
            
            let title = "Items";
            if(id === 'trash-bin') title = "Trash Bin";
            if(id === 'import-unified') title = "Import";
            if(id === 'ai-gen') title = "AI Creator";
            
            if(id !== 'category-view') document.getElementById('view-title').innerText = title;
            
            if(id === 'trash-bin') renderTrash();
            if(id === 'category-view') renderItems();
            if(window.innerWidth <= 768) toggleSidebar();
        }

        function switchImportTab(tab, el) {
            document.getElementById('tab-img-content').classList.add('hidden');
            document.getElementById('tab-code-content').classList.add('hidden');
            document.getElementById('tab-img-btn').classList.remove('active');
            document.getElementById('tab-code-btn').classList.remove('active');
            
            document.getElementById(`tab-${tab}-content`).classList.remove('hidden');
            if(el) el.classList.add('active');
            else document.getElementById(`tab-${tab}-btn`).classList.add('active');
        }

        function clearCodeImport() {
            document.getElementById('code-item-name').value = '';
            document.getElementById('code-item-svg').value = '';
        }

        function saveCodeItem() {
            const name = document.getElementById('code-item-name').value;
            const svg = document.getElementById('code-item-svg').value;
            if(!name || !svg) return;
            items.unshift({ id:'item-'+Date.now(), catId:'cat-imports', name, svg: normalizeSVG(svg) });
            saveLocal(); toast('Item Added');
            clearCodeImport();
        }

        function saveImportedItem() {
            const name = document.getElementById('import-img-name').value;
            if(!name || !currentGeneratedSvg) return;
            items.unshift({ id:'item-'+Date.now(), catId:'cat-imports', name, svg: currentGeneratedSvg });
            saveLocal(); toast('Image Imported'); resetImport();
        }

        function saveAiItem() {
            const name = document.getElementById('ai-item-name').value || "AI Item";
            if(!currentAiSvg) return;
            items.unshift({ id:'item-'+Date.now(), catId:'cat-ai-gen', name, svg: currentAiSvg });
            saveLocal(); toast('AI Item Saved'); resetAiGen();
        }

        function deleteCategory(id, e) {
            e.stopPropagation();
            if(confirm("Delete this category? Items will move to trash.")) {
                items.forEach(i => { if(i.catId === id) { i.isTrash = true; trash.push(i); } }); // Copy to trash logic
                items = items.filter(i => i.catId !== id); // Remove from active
                categories = categories.filter(c => c.id !== id);
                if(currentCatId === id) { currentCatId = 'cat-imports'; selectCategory('cat-imports'); }
                saveLocal(); renderSidebar(); renderItems();
            }
        }

        function editName(id) {
            const item = items.find(i=>i.id===id);
            const n = prompt("Rename:", item.name);
            if(n) { item.name=n; saveLocal(); renderItems(); }
        }
        function moveToTrash(id) {
            const idx = items.findIndex(i=>i.id===id);
            if(idx>-1) {
                const item = items.splice(idx,1)[0];
                item.isTrash = true; trash.push(item);
                saveLocal(); renderItems(); toast('Moved to Trash');
            }
        }
        function restoreItem(id) {
            const idx = trash.findIndex(i=>i.id===id);
            if(idx>-1) {
                const item = trash.splice(idx,1)[0];
                item.isTrash = false;
                if(!categories.find(c=>c.id===item.catId)) item.catId = 'cat-restore';
                items.push(item);
                saveLocal(); renderTrash(); toast('Restored');
            }
        }
        function deleteForever(id) {
            if(confirm("Delete forever?")) {
                trash = trash.filter(i=>i.id!==id);
                saveLocal(); renderTrash();
            }
        }

        // --- 7. UTILS ---
        function normalizeSVG(str) {
            if(!str) return '';
            try {
                const p = new DOMParser(); const doc = p.parseFromString(str,'image/svg+xml'); const s = doc.querySelector('svg');
                if(!s) return str;
                if(!s.hasAttribute('viewBox')) s.setAttribute('viewBox', '0 0 100 100');
                s.setAttribute('width','100%'); s.setAttribute('height','100%'); s.setAttribute('preserveAspectRatio','xMidYMid meet');
                return new XMLSerializer().serializeToString(s);
            } catch(e){ return str; }
        }
        
        function copySVG(id) { 
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏à‡∏≤‡∏Å ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤ SVG Code ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
            const item = items.find(i => i.id === id);
            if(item && item.svg) {
                copyToClipboard(item.svg);
                toast("SVG Code Copied!");
            } else {
                toast("No SVG Code found");
            }
        }

        function flipItem(id) { document.getElementById(`svg-cont-${id}`).classList.toggle('flipped'); }
        function toast(msg) { 
            const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); 
            setTimeout(()=>t.classList.remove('show'),2000); 
        }
        
        // --- 7.1 HELPER: copyToClipboard ---
        function copyToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        }

        function openModal(id) { document.getElementById(id).style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('show'); }

        // --- 8. AI & IMG ---
        function setImportMode(m) { importMode=m; document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active')); document.getElementById('mode-'+m).classList.add('active'); }
        function handleFileSelect(e) { if(e.target.files[0]) processFile(e.target.files[0]); }
        function handleImportDrop(e) { e.preventDefault(); if(e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); }
        function handleImportDragOver(e) { e.preventDefault(); } function handleImportDragLeave(e) { e.preventDefault(); }
        function setupPasteListener() { window.addEventListener('paste', e=>{ if(!document.getElementById('section-import-unified').classList.contains('hidden')) { const f = e.clipboardData.items[0].getAsFile(); if(f) processFile(f); } }); }
        function processFile(f) {
            const r = new FileReader(); r.onload=e=>{ originalImgData=e.target.result; document.getElementById('img-preview').src=originalImgData; document.getElementById('import-preview-area').classList.remove('hidden'); }; r.readAsDataURL(f);
        }
        function removeBackgroundSimple() {
            const img=document.getElementById('img-preview'); const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d');
            cvs.width=img.naturalWidth; cvs.height=img.naturalHeight; ctx.drawImage(img,0,0);
            const d=ctx.getImageData(0,0,cvs.width,cvs.height);
            for(let i=0;i<d.data.length;i+=4) { if(d.data[i]>230 && d.data[i+1]>230 && d.data[i+2]>230) d.data[i+3]=0; }
            ctx.putImageData(d,0,0); originalImgData=cvs.toDataURL(); img.src=originalImgData;
        }
        function generateSVG() {
            if(importMode==='embed') {
                currentGeneratedSvg = normalizeSVG(`<svg viewBox="0 0 200 200"><image href="${originalImgData}" width="200" height="200"/></svg>`);
                document.getElementById('svg-preview-cont').innerHTML = currentGeneratedSvg;
            } else {
                if(typeof ImageTracer !== 'undefined') {
                     ImageTracer.imageToSVG(originalImgData, s=>{
                         currentGeneratedSvg = normalizeSVG(s);
                         document.getElementById('svg-preview-cont').innerHTML = currentGeneratedSvg;
                     }, {ltres:1, qtres:1, scale:1});
                } else alert("Tracer lib not loaded");
            }
        }
        function resetImport() { document.getElementById('import-preview-area').classList.add('hidden'); document.getElementById('import-img-name').value=''; originalImgData=''; currentGeneratedSvg=''; }
        
        // --- AI CONFIG ---
        function openAiConfigModal() {
            const key = localStorage.getItem('gemini_api_key') || '';
            document.getElementById('gemini-api-key').value = key;
            openModal('modal-ai-config');
        }

        function saveAiConfig() {
            const key = document.getElementById('gemini-api-key').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                toast("API Key Saved");
            } else {
                localStorage.removeItem('gemini_api_key');
                toast("API Key Removed");
            }
            closeModal('modal-ai-config');
        }

        async function generateAiSvg() {
            const name = document.getElementById('ai-prompt-name').value;
            const ref = document.getElementById('ai-prompt-ref').value;
            const detail = document.getElementById('ai-prompt-detail').value;

            if(!name && !detail) { toast("Please enter details"); return; }
            
            // Build Scope Prompt
            const prompt = `Item Name: ${name}. Style Ref: ${ref}. Details: ${detail}.`;

            document.getElementById('ai-loading').classList.remove('hidden');
            
            // Check for User Key first, else use Pool
            let key = localStorage.getItem('gemini_api_key');
            if (!key) {
                 key = _pool[activeKeyIndex].k1 + _pool[activeKeyIndex].k2;
            }

            try {
                // CHANGED MODEL to gemini-2.5-flash-preview-09-2025:generateContent to support public keys
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method:'POST', 
                    body:JSON.stringify({
                        contents:[{parts:[{text:"Create SVG icon for game item. " + prompt + " Return raw SVG only. Minimize code."}]}],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    }), 
                    headers:{'Content-Type':'application/json'}
                });
                
                if (!res.ok) {
                    const errData = await res.json();
                    // Rotation logic only if using Pool keys
                    if(!localStorage.getItem('gemini_api_key') && res.status === 429 && activeKeyIndex < _pool.length -1) {
                         activeKeyIndex++;
                         generateAiSvg(); 
                         return;
                    }
                    throw new Error(errData.error?.message || res.statusText);
                }

                const j = await res.json();
                if (!j.candidates || !j.candidates[0].content) {
                    throw new Error("AI Safety Block or No Response");
                }

                let txt = j.candidates[0].content.parts[0].text.replace(/```xml|```svg|```/g,'');
                const start = txt.indexOf('<svg'); 
                const end = txt.lastIndexOf('</svg>')+6;
                
                if (start === -1 || end === -1) throw new Error("No SVG found in response");

                currentAiSvg = normalizeSVG(txt.substring(start, end));
                document.getElementById('ai-svg-output').innerHTML = currentAiSvg;
                document.getElementById('ai-result-area').classList.remove('hidden');
                document.getElementById('ai-item-name').value = name || "New Item";
            } catch(e) { 
                console.error(e);
                toast("AI Error: " + e.message); 
            } finally { 
                document.getElementById('ai-loading').classList.add('hidden'); 
            }
        }
        
        function resetAiGen() { 
            document.getElementById('ai-result-area').classList.add('hidden'); 
            currentAiSvg=''; 
            document.getElementById('ai-prompt-name').value=''; 
            document.getElementById('ai-prompt-ref').value=''; 
            document.getElementById('ai-prompt-detail').value=''; 
        }

        // --- 9. DRAG & DROP ---
        function handleDragStart(e, id) { draggedItemId = id; e.target.classList.add('dragging'); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); draggedItemId = null; }
        function handleDragOverCat(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over-cat'); }
        function handleDragLeaveCat(e) { e.currentTarget.classList.remove('drag-over-cat'); }
        function handleDropCat(e, catId) {
            e.preventDefault(); e.currentTarget.classList.remove('drag-over-cat');
            if(draggedItemId) {
                const item = items.find(i=>i.id===draggedItemId);
                if(item) { item.catId=catId; saveLocal(); renderItems(); toast('Moved'); }
            }
        }

        // --- 10. SYNC ---
        function openGithubModal() {
            const c = localStorage.getItem('gh_config');
            if (c) {
                const j = JSON.parse(c);
                document.getElementById('gh-user').value=j.user; document.getElementById('gh-repo').value=j.repo;
                document.getElementById('gh-token').value=j.token; document.getElementById('gh-path').value=j.path;
            }
            openModal('modal-github');
        }
        async function syncToGitHub(action) {
            const user=document.getElementById('gh-user').value, repo=document.getElementById('gh-repo').value, token=document.getElementById('gh-token').value, path=document.getElementById('gh-path').value;
            if(!user||!repo||!token) { openGithubModal(); return; }
            localStorage.setItem('gh_config', JSON.stringify({user,repo,token,path}));
            closeModal('modal-github'); toast('Connecting...');
            
            const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            try {
                let sha=null, content=null;
                const get = await fetch(url, {headers:{'Authorization':`token ${token}`}});
                if(get.ok) { const j = await get.json(); sha=j.sha; content=j.content; }

                if(action==='pull') {
                    if(!content) { toast('No file found'); return; }
                    const d = JSON.parse(decodeURIComponent(escape(atob(content.replace(/\s/g,'')))));
                    if(d.categories) d.categories.forEach(c=>{ if(!categories.find(ex=>ex.id===c.id)) categories.push(c); });
                    if(d.items) { const ids=new Set(items.map(i=>i.id)); d.items.forEach(i=>{ if(!ids.has(i.id)) items.push(i); }); }
                    saveLocal(); renderSidebar(); renderItems(); toast('Data Pulled');
                } else {
                    const b = btoa(unescape(encodeURIComponent(JSON.stringify({categories,items,trash}))));
                    const body = { message:"Update DB", content:b }; if(sha) body.sha=sha;
                    const put = await fetch(url, {method:'PUT', headers:{'Authorization':`token ${token}`, 'Content-Type':'application/json'}, body:JSON.stringify(body)});
                    if(put.ok) toast('Data Pushed'); else alert('Push Failed');
                }
            } catch(e) { console.error(e); toast('Error'); }
        }

        function backupAll() { navigator.clipboard.writeText(JSON.stringify({categories,items})).then(()=>toast('Copied to Clipboard')); }
        function downloadDB() {
            const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify({categories,items,trash})], {type:'application/json'}));
            a.download='db.json'; a.click();
        }
        function processRestore() {
            try {
                const d = JSON.parse(document.getElementById('restore-input').value);
                if(d.items) {
                    if(d.categories) d.categories.forEach(c=>{ if(!categories.find(ex=>ex.id===c.id)) categories.push(c); });
                    const ids=new Set(items.map(i=>i.id));
                    d.items.forEach(i=>{ if(!ids.has(i.id)) { i.catId = i.catId || 'cat-restore'; items.push(i); } });
                    saveLocal(); renderSidebar(); renderItems(); closeModal('modal-restore'); toast('Restored');
                }
            } catch(e) { alert('Invalid JSON'); }
        }

        // --- 11. LANG ---
        function setLanguage(l) {
            currentLang=l;
            document.querySelectorAll('.btn-lang').forEach(b=>b.classList.remove('active'));
            document.getElementById('lang-'+l).classList.add('active');
            applyLanguage();
        }
        
        function applyLanguage() {
            const t = {
                th: { manage:"‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£", backup:"‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", system:"‡∏£‡∏∞‡∏ö‡∏ö", restore:"‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô", items:"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡∏°", menuAiConfig: "AI Config" },
                en: { manage:"Manage", backup:"Backup", system:"System", restore:"Restore", items:"Item List", menuAiConfig: "AI Config" }
            };
            const lang = t[currentLang];
            document.getElementById('label-manage').innerText = lang.manage;
            document.getElementById('view-title').innerText = lang.items;
            document.getElementById('menu-ai-config').innerText = lang.menuAiConfig;
        }

        function saveCategory() {
            const n = document.getElementById('cat-name-input').value;
            let i = document.getElementById('cat-icon-input').value;
            if(!i) i = selectedEmoji || 'üìÅ';
            if(n) { categories.push({id:'cat-'+Date.now(), name:n, icon:i}); saveLocal(); renderSidebar(); closeModal('modal-category'); }
        }
    </script>
</body>
</html>
