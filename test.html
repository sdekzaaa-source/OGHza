<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OGHza - Abyssal Sovereign Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Kanit:wght@300;400;700;900&display=swap');
        
        :root { --abyssal-purple: #7c3aed; --abyssal-gold: #fbbf24; }
        html { font-size: clamp(14px, 0.85vw + 10px, 16px); }
        body { font-family: 'Inter', 'Kanit', sans-serif; background-color: #020617; color: #f1f5f9; overflow-x: hidden; padding-bottom: 110px; transition: background-color 0.3s, color 0.3s; }
        
        /* Themes */
        body.light { background-color: #f8fafc; color: #1e293b; }
        body.rom { background-color: #1a1d2e; color: #e2e8f0; }
        
        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.05); }
        body.light .glass-panel { background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(0, 0, 0, 0.05); }
        body.rom .glass-panel { background: rgba(21, 23, 37, 0.9); border: 1px solid rgba(252, 211, 77, 0.1); }

        .resonance-bar { transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px var(--abyssal-purple); } 50% { box-shadow: 0 0 20px var(--abyssal-purple); } }
        .glow-active { animation: pulse-glow 2s infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment } = React;
        const { ResponsiveContainer, AreaChart, Area } = window.Recharts;

        // --- CONSTANTS ---
        const APP_VERSION = "Ver.3.0.0 Reforged";
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAbWzr8o_OhkjGbEetBYq_nzYmVZ2fTf40",
            authDomain: "rocogh-88a38.firebaseapp.com",
            projectId: "rocogh-88a38",
            storageBucket: "rocogh-88a38.firebasestorage.app",
            messagingSenderId: "1025971309206",
            appId: "1:1025971309206:web:d4f9e0ab6bb016dde590b7",
        };

        const INITIAL_STATS = { baseLv: 1, baseExp: 0, jobLv: 1, jobExp: 0, jobClass: 'Novice', coins: 0, zeny: 0, veteranTokens: 0 };
        const RANKS = [
            { threshold: 0, name: "Ruins Wanderer", color: "text-slate-400" },
            { threshold: 20, name: "Ancient Explorer", color: "text-blue-400" },
            { threshold: 60, name: "Abyssal Sentinel", color: "text-purple-400" },
            { threshold: 80, name: "Dreadnought Hunter", color: "text-orange-400" },
            { threshold: 100, name: "Glast Heim Sovereign", color: "text-yellow-400" }
        ];

        const MILESTONES = [
            { count: 1, badge: "ü•â", title: "First Step" },
            { count: 3, badge: "ü•à", title: "Dedicated" },
            { count: 5, badge: "ü•á", title: "Elite" }
        ];

        // --- HELPERS ---
        const formatMoney = (n) => new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(n);
        const formatFullMoney = (n) => new Intl.NumberFormat('th-TH').format(Math.floor(n));
        
        const getTimeLeftStr = (expiry) => {
            const diff = expiry - Date.now();
            if (diff <= 0) return null;
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            return `${h}h ${m}m ${s}s`;
        };

        const getDeviceDate = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const calculateProfit = (f, p, config) => {
            let rev = Number(f.trashAmount) || 0;
            const sp = f.isSellingSpell ? (Number(f.customSpellPrice) || p.purpleStonePrice) : 0;
            const mp = (f.runMode === 'aogh' && f.isSellingMagic) ? (Number(f.customMagicPrice) || p.contMagicPrice) : 0;
            rev += (Number(f.purpleStoneCount) * sp) + (Number(f.contMagicCount) * mp);
            
            const costGum = Number(f.normalCount) * (p.gumBoxPrice / 10);
            const costSv = f.useSilvervine ? (2 * (p.silvervineBoxPrice / 10)) / (config.totalChars || 1) : 0;
            const costOther = (f.otherCosts || []).reduce((a, c) => a + (Number(c.amount) || 0), 0);
            return rev - (costGum + costSv + costOther);
        };

        // --- ICONS & SVGS ---
        const SVGs = {
            Spell: ({className}) => <svg viewBox="0 0 32 32" className={className}><path d="M16 4 L24 12 L24 22 L16 28 L8 22 L8 12 Z" fill="#7E57C2" /><path d="M16 6 L22 12 L22 20 L16 26 L10 20 L10 12 Z" fill="#9575CD" /></svg>,
            Magic: ({className}) => <svg viewBox="0 0 32 32" className={className}><circle cx="16" cy="16" r="10" fill="#EF5350" /><circle cx="16" cy="16" r="6" fill="#B71C1C" /></svg>,
            Gum: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><rect x="6" y="10" width="12" height="10" rx="2" /><path d="M10 10V6a2 2 0 0 1 4 0v4" /></svg>,
            GumBox: ({className}) => <svg viewBox="0 0 32 32" className={className} shapeRendering="crispEdges"><rect x="4" y="10" width="24" height="18" rx="2" fill="#42A5F5" /><rect x="4" y="10" width="24" height="6" rx="2" fill="#1E88E5" /><circle cx="16" cy="19" r="5" fill="#F06292" /><path d="M12 10 L12 6 L20 6 L20 10" fill="none" stroke="#BBDEFB" strokeWidth="2" /></svg>,
            Silvervine: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="#10b981" fill="#10b981" fillOpacity="0.2"/></svg>,
            SilvervineBox: ({className}) => <svg viewBox="0 0 32 32" className={className} shapeRendering="crispEdges"><rect x="4" y="10" width="24" height="18" fill="#8D6E63" /><path d="M4 10 L16 14 L28 10" fill="none" stroke="#5D4037" strokeWidth="2" /><path d="M16 4 L14 10 L18 10 Z" fill="#4CAF50" /><rect x="12" y="18" width="8" height="2" fill="#FFD600" /></svg>,
            Zeny: ({className}) => <span className={`font-black ${className}`}>Z</span>
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Home: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
                History: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
                Box: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/></svg>,
                Settings: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09"/></svg>,
                Plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                Trash: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg>,
                Edit: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15"/></svg>,
                Check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
                Moon: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
                Sun: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
                TrendingUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
                MinusCircle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
                PlusCircle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
                RefreshCw: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
                Sparkles: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
                AlertTriangle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
                Clock: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
                Save: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
                Zap: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
                ChevronDown: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><polyline points="6 9 12 15 18 9"/></svg>,
                Medal: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M12 8.5a6 6 0 0 1 3.53 10.74l-.94 5.25-2.59-1.25-2.59 1.25-.94-5.25A6 6 0 0 1 12 8.5zM12 2l3 5h-6l3-5z"/></svg>,
                Star: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            };
            return icons[name] || null;
        };

        const NumberStepper = ({ value, onChange, theme }) => {
            const handleStep = (amount) => {
                let next = (parseInt(value) || 0) + amount;
                if (next < 0) next = 0;
                onChange(next);
            };
            return (
                <div className={`flex items-center gap-2 w-full h-[52px]`}>
                    <button type="button" onClick={() => handleStep(-1)} className={`flex-none w-10 h-full rounded-xl flex items-center justify-center transition-all active:scale-95 ${theme === 'dark' || theme === 'rom' ? 'bg-slate-800 text-rose-400 hover:bg-slate-700' : 'bg-slate-200 text-slate-600'}`}><Icon name="MinusCircle" size={20} /></button>
                    <input type="number" inputMode="numeric" value={value} onFocus={(e) => e.target.select()} onChange={(e) => onChange(e.target.value)} className={`flex-1 h-full rounded-xl text-center font-black text-2xl outline-none ${theme === 'dark' || theme === 'rom' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-800'}`} />
                    <button type="button" onClick={() => handleStep(1)} className={`flex-none w-10 h-full rounded-xl flex items-center justify-center transition-all active:scale-95 ${theme === 'dark' || theme === 'rom' ? 'bg-slate-800 text-emerald-400 hover:bg-slate-700' : 'bg-slate-200 text-slate-600'}`}><Icon name="PlusCircle" size={20} /></button>
                </div>
            );
        };

        const ConfirmModal = ({ title, message, onConfirm, onCancel, isProcessing, confirmColor = "rose" }) => (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-fade-in" onClick={onCancel}>
                <div className="w-full max-w-sm p-6 rounded-3xl shadow-2xl border bg-slate-900 border-slate-700 relative text-white" onClick={e => e.stopPropagation()}>
                    <div className="flex flex-col items-center text-center gap-4">
                        <div className={`w-16 h-16 rounded-full bg-${confirmColor}-500/20 flex items-center justify-center text-${confirmColor}-500 mb-2 animate-shake`}>
                            <Icon name="AlertTriangle" size={32} />
                        </div>
                        <h3 className={`text-xl font-black text-${confirmColor}-500`}>{title}</h3>
                        <p className="text-sm opacity-70 leading-relaxed whitespace-pre-wrap">{message}</p>
                        <div className="flex gap-3 w-full mt-4">
                            <button onClick={onCancel} className="flex-1 py-3 rounded-2xl font-bold text-xs bg-slate-800 text-slate-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button onClick={onConfirm} className={`flex-1 py-3 rounded-2xl font-bold text-xs bg-${confirmColor}-600 text-white shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95`} disabled={isProcessing}>
                                {isProcessing ? <Icon name="RefreshCw" size={16} className="animate-spin"/> : "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );

        const MessageModal = ({ title, message, onClose, color = "emerald" }) => (
            <div className="fixed inset-0 z-[110] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                <div className="w-full max-w-sm p-6 rounded-3xl shadow-2xl border bg-slate-900 border-slate-700 relative text-white text-center" onClick={e => e.stopPropagation()}>
                    <h3 className={`text-xl font-black text-${color}-500 uppercase mb-4`}>{title}</h3>
                    <p className="text-sm opacity-70 leading-relaxed mb-6 whitespace-pre-wrap">{message}</p>
                    <button onClick={onClose} className="w-full py-3 rounded-2xl font-bold text-xs bg-slate-800 text-white mt-2">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            </div>
        );

        // --- VIEWS ---
        const AddDataView = ({ onClose, targetUid, db, prices, accountConfig, userStats, allRecords, setGlobalIsSaving, onSuccess, theme }) => {
            const [form, setForm] = useState({ 
                date: getDeviceDate(), runMode: 'ogh', trashAmount: '', 
                purpleStoneCount: '0', contMagicCount: '0', 
                isSellingSpell: false, isSellingMagic: false,
                heCount: 0, normalCount: 0, useSilvervine: true, minutesUsed: '60', notes: '', otherCosts: []
            });
            const [stoneTab, setStoneTab] = useState('spell'); // 'spell' or 'magic'
            const [limitErrorModal, setLimitErrorModal] = useState(null);

            const validate = () => {
                if (parseInt(form.minutesUsed) < 5 || parseInt(form.minutesUsed) > 180) return "‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 5 - 180 ‡∏ô‡∏≤‡∏ó‡∏µ";
                if (form.heCount > 4) return "‡∏Æ‡∏µ‡∏Å‡∏±‡πâ‡∏°‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 4 ‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö";
                if (form.normalCount > 2) return "‡∏Å‡∏±‡πâ‡∏°‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö";
                return null;
            };

            const addCost = () => setForm(p => ({...p, otherCosts: [...(p.otherCosts || []), {id: Date.now(), name: '', amount: ''}]}));
            const updateCost = (id, field, val) => setForm(p => ({...p, otherCosts: p.otherCosts.map(c => c.id === id ? {...c, [field]: val} : c)}));
            const removeCost = (id) => setForm(p => ({...p, otherCosts: p.otherCosts.filter(c => c.id !== id)}));

            // Expose submit to parent via ref or context ideally, but here we hook into a hidden button
            useEffect(() => {
                const btn = document.getElementById('hidden-submit-btn');
                if(btn) btn.onclick = async (e) => {
                    e.preventDefault();
                    const err = validate();
                    if(err) { setLimitErrorModal(err); return; }
                    
                    setGlobalIsSaving(true);
                    const { addDoc, collection, doc, setDoc } = window.firebaseModules;
                    
                    const costGumNormal = form.normalCount * (Number(prices.gumBoxPrice) / 10);
                    const costSilvervine = form.useSilvervine ? ((Number(prices.silvervineBoxPrice) / 5) / (Number(accountConfig.totalChars) || 1)) : 0;
                    const costOthers = form.otherCosts.reduce((acc, c) => acc + (Number(c.amount) || 0), 0);
                    const totalCost = costGumNormal + costSilvervine + costOthers;

                    let revenue = Number(form.trashAmount) || 0;
                    if(form.isSellingSpell) revenue += (Number(form.purpleStoneCount) * Number(prices.purpleStonePrice));
                    if(form.runMode === 'aogh' && form.isSellingMagic) revenue += (Number(form.contMagicCount) * Number(prices.contMagicPrice));
                    
                    const profit = revenue - totalCost;
                    const [y, m, d] = form.date.split('-');
                    
                    const finalData = { 
                        ...form, date: `${d}/${m}/${y}`, timestamp: Date.now(), 
                        profit, mode: form.runMode,
                        savedCostGum: costGumNormal, savedCostSv: costSilvervine, savedCostOthers: costOthers
                    };

                    await addDoc(collection(db, 'artifacts', 'ogh-reforged', 'users', targetUid, 'records'), finalData);
                    
                    // Update Stats & Veteran Token
                    let newStats = { ...userStats, zeny: (userStats.zeny || 0) + profit };
                    // Check for Veteran Token (Runs > 5 today)
                    const todayStr = `${d}/${m}/${y}`;
                    const runsToday = allRecords.filter(r => r.date === todayStr).length;
                    if (runsToday >= 5) {
                        newStats.veteranTokens = (newStats.veteranTokens || 0) + 1;
                    }

                    await setDoc(doc(db, 'artifacts', 'ogh-reforged', 'users', targetUid, 'gamification', 'stats'), newStats);
                    onSuccess({ zenyGain: profit, tokenGain: runsToday >= 5 ? 1 : 0 });
                    setGlobalIsSaving(false);
                };
            }, [form, prices, accountConfig, userStats, allRecords]);

            return (
                <div className="p-6 pb-32 animate-fade-in space-y-6">
                    <h2 className="text-2xl font-black italic uppercase text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">Record Expedition</h2>
                    
                    {/* 1. Mode Select */}
                    <div className="flex gap-2 p-1 bg-slate-900 rounded-2xl">
                        <button type="button" onClick={() => setForm({...form, runMode: 'ogh'})} className={`flex-1 py-3 rounded-xl text-[10px] font-black transition-all ${form.runMode === 'ogh' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-500'}`}>OGH</button>
                        <button type="button" onClick={() => setForm({...form, runMode: 'aogh'})} className={`flex-1 py-3 rounded-xl text-[10px] font-black transition-all ${form.runMode === 'aogh' ? 'bg-rose-600 text-white shadow-lg' : 'text-slate-500'}`}>AOGH</button>
                    </div>

                    {/* 2. Date & Time */}
                    <div className="grid grid-cols-2 gap-4">
                        <input type="date" value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="h-12 bg-slate-900 rounded-xl px-4 text-xs font-black outline-none border border-white/5 text-white" />
                        <input type="number" value={form.minutesUsed} onChange={e => setForm({...form, minutesUsed: e.target.value})} className="h-12 bg-slate-900 rounded-xl px-4 text-center text-xs font-black outline-none border border-white/5 text-white" placeholder="‡∏ô‡∏≤‡∏ó‡∏µ" />
                    </div>

                    {/* 3. Income Section */}
                    <div className="space-y-4">
                        <div className="glass-panel p-6 rounded-3xl text-center border-l-4 border-emerald-500">
                            <label className="text-[10px] font-black text-emerald-400 uppercase tracking-widest block mb-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏¢‡∏∞ (Zeny)</label>
                            <input type="number" value={form.trashAmount} onChange={e => setForm({...form, trashAmount: e.target.value})} className="w-full bg-transparent text-center text-4xl font-black outline-none placeholder-slate-800 text-white" placeholder="0" />
                        </div>

                        {/* Smart Stone Input */}
                        <div className="glass-panel p-4 rounded-3xl border-l-4 border-purple-500">
                            <div className="flex bg-slate-900/50 p-1 rounded-xl mb-4">
                                <button onClick={() => setStoneTab('spell')} className={`flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${stoneTab === 'spell' ? 'bg-purple-600 text-white' : 'text-slate-500'}`}>Spell (‡∏°‡πà‡∏ß‡∏á)</button>
                                {form.runMode === 'aogh' && <button onClick={() => setStoneTab('magic')} className={`flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${stoneTab === 'magic' ? 'bg-rose-600 text-white' : 'text-slate-500'}`}>Magic (‡πÅ‡∏î‡∏á)</button>}
                            </div>
                            
                            {stoneTab === 'spell' ? (
                                <div className="space-y-3 animate-fade-in">
                                    <div className="flex justify-between items-center text-white"><span className="text-xs font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏¥‡∏ô‡∏°‡πà‡∏ß‡∏á</span><button onClick={()=>setForm({...form, isSellingSpell: !form.isSellingSpell})} className={`text-[9px] px-2 py-0.5 rounded font-bold ${form.isSellingSpell?'bg-purple-600':'bg-slate-700'}`}>{form.isSellingSpell?'‡∏Ç‡∏≤‡∏¢':'‡πÄ‡∏Å‡πá‡∏ö'}</button></div>
                                    <NumberStepper value={form.purpleStoneCount} onChange={v => setForm({...form, purpleStoneCount: v})} theme={theme} />
                                </div>
                            ) : (
                                <div className="space-y-3 animate-fade-in">
                                    <div className="flex justify-between items-center text-white"><span className="text-xs font-bold text-rose-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏¥‡∏ô‡πÅ‡∏î‡∏á</span><button onClick={()=>setForm({...form, isSellingMagic: !form.isSellingMagic})} className={`text-[9px] px-2 py-0.5 rounded font-bold ${form.isSellingMagic?'bg-rose-600':'bg-slate-700'}`}>{form.isSellingMagic?'‡∏Ç‡∏≤‡∏¢':'‡πÄ‡∏Å‡πá‡∏ö'}</button></div>
                                    <NumberStepper value={form.contMagicCount} onChange={v => setForm({...form, contMagicCount: v})} theme={theme} />
                                </div>
                            )}
                        </div>
                    </div>

                    {/* 4. Costs Section */}
                    <div className="glass-panel p-5 rounded-3xl space-y-4 border-l-4 border-blue-500 text-white">
                        <p className="text-[10px] font-black uppercase opacity-40">Consumables Used</p>
                        <div className="flex justify-between items-center">
                            <span className="text-xs font-bold text-blue-400">Gum (‡∏Å‡∏±‡πâ‡∏°)</span>
                            <div className="flex items-center gap-3 bg-black/20 p-1 rounded-xl"><button type="button" onClick={()=>setForm({...form, normalCount: Math.max(0, form.normalCount-1)})} className="w-6 h-6 rounded bg-slate-800 text-xs">-</button><span className="w-4 text-center font-black">{form.normalCount}</span><button type="button" onClick={()=>setForm({...form, normalCount: Math.min(2, form.normalCount+1)})} className="w-6 h-6 rounded bg-slate-800 text-xs">+</button></div>
                        </div>
                        <div className="flex justify-between items-center">
                            <span className="text-xs font-bold text-rose-400">HE Gum (‡∏Æ‡∏µ)</span>
                            <div className="flex items-center gap-3 bg-black/20 p-1 rounded-xl"><button type="button" onClick={()=>setForm({...form, heCount: Math.max(0, form.heCount-1)})} className="w-6 h-6 rounded bg-slate-800 text-xs">-</button><span className="w-4 text-center font-black">{form.heCount}</span><button type="button" onClick={()=>setForm({...form, heCount: Math.min(4, form.heCount+1)})} className="w-6 h-6 rounded bg-slate-800 text-xs">+</button></div>
                        </div>
                         <div className="flex justify-between items-center pt-2 border-t border-white/5">
                            <span className="text-xs font-bold text-emerald-400">Silvervine</span>
                            <button type="button" onClick={() => setForm({...form, useSilvervine: !form.useSilvervine})} className={`px-3 py-1 rounded text-[10px] font-bold ${form.useSilvervine ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-gray-500'}`}>{form.useSilvervine ? 'Active' : 'Off'}</button>
                        </div>
                    </div>

                    {/* 5. Others & Notes */}
                    <div className="space-y-3">
                         <button type="button" onClick={addCost} className="text-xs font-bold text-blue-400 flex items-center gap-2"><Icon name="Plus" size={14}/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</button>
                        {(form.otherCosts || []).map((c, i) => (
                            <div key={c.id} className="flex gap-2">
                                <input type="text" value={c.name} onChange={e => updateCost(c.id, 'name', e.target.value)} placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." className="flex-1 bg-slate-900 h-10 rounded-lg px-3 text-xs outline-none text-white" />
                                <input type="number" value={c.amount} onChange={e => updateCost(c.id, 'amount', e.target.value)} placeholder="0" className="w-20 bg-slate-900 h-10 rounded-lg px-3 text-xs outline-none text-right text-white" />
                                <button type="button" onClick={() => removeCost(c.id)} className="text-rose-500 p-2"><Icon name="Trash" size={16}/></button>
                            </div>
                        ))}
                         <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="w-full h-20 bg-slate-900 border border-white/5 rounded-2xl p-4 text-xs text-white placeholder-slate-600 outline-none resize-none" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                    </div>

                    <button id="hidden-submit-btn" style={{display:'none'}}>Submit</button>
                    {limitErrorModal && <MessageModal title="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" message={limitErrorModal} onClose={() => setLimitErrorModal(null)} color="rose" />}
                </div>
            );
        };

        const SettingsView = ({ uid, config, db, updateConfig, theme, setTheme }) => {
            const [local, setLocal] = useState(config);
            const [isSaving, setIsSaving] = useState(false);
            const [saveSuccess, setSaveSuccess] = useState(false);
            
            // Backup/Restore Logic
            const copyUid = () => { navigator.clipboard.writeText(uid); alert("Copied UID!"); };
            const restoreUid = () => { const code = prompt("Enter Backup UID:"); if(code && code.length > 5) { localStorage.setItem('ogh_restore_uid', code); window.location.reload(); }};

            const save = async () => {
                setIsSaving(true);
                const { doc, setDoc } = window.firebaseModules;
                await setDoc(doc(db, 'artifacts', 'ogh-reforged', 'users', uid, 'config', 'account'), local);
                updateConfig(local);
                setIsSaving(false);
                setSaveSuccess(true);
                setTimeout(() => setSaveSuccess(false), 2000);
            };

            return (
                <div className="p-6 pb-24 space-y-8 animate-fade-in text-white text-center">
                    <h2 className="text-lg font-black uppercase tracking-widest">Settings</h2>
                    
                    <div className="glass-panel p-6 rounded-3xl space-y-4 text-left">
                        <p className="text-[10px] font-black opacity-40 uppercase">User Data</p>
                        <div className="flex gap-2">
                            <div className="flex-1 bg-black/40 p-3 rounded-xl text-[10px] font-mono truncate text-slate-400">{uid}</div>
                            <button onClick={copyUid} className="bg-slate-700 px-3 rounded-xl text-[10px] font-bold">Copy</button>
                        </div>
                        <button onClick={restoreUid} className="w-full py-2 border border-slate-700 rounded-xl text-[10px] text-slate-400 hover:text-white hover:border-white/20 transition-all">Restore Data from UID</button>
                    </div>

                    <div className="glass-panel p-6 rounded-3xl space-y-4 text-left">
                         <div className="flex justify-between items-center"><span className="text-xs font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</span><input type="number" value={local.totalChars} onChange={e => setLocal({...local, totalChars: e.target.value})} className="w-16 bg-black/40 h-8 rounded-lg text-center text-xs outline-none" /></div>
                         <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-[8px] opacity-40 font-black uppercase">‡∏´‡∏¥‡∏ô‡∏°‡πà‡∏ß‡∏á (Price)</label><input type="number" value={local.purpleStonePrice} onChange={e => setLocal({...local, purpleStonePrice: e.target.value})} className="w-full bg-black/40 h-10 rounded-xl text-center outline-none mt-1" /></div>
                            <div><label className="text-[8px] opacity-40 font-black uppercase text-rose-400">‡∏´‡∏¥‡∏ô‡πÅ‡∏î‡∏á (Price)</label><input type="number" value={local.contMagicPrice} onChange={e => setLocal({...local, contMagicPrice: e.target.value})} className="w-full bg-black/40 h-10 rounded-xl text-center outline-none mt-1" /></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-[8px] opacity-40 font-black uppercase text-blue-400">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏±‡πâ‡∏° (10ea)</label><input type="number" value={local.gumBoxPrice} onChange={e => setLocal({...local, gumBoxPrice: e.target.value})} className="w-full bg-black/40 h-10 rounded-xl text-center outline-none mt-1" /></div>
                            <div><label className="text-[8px] opacity-40 font-black uppercase text-emerald-400">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏°‡∏∞‡∏•‡∏∞‡∏Å‡∏≠ (10ea)</label><input type="number" value={local.silvervineBoxPrice} onChange={e => setLocal({...local, silvervineBoxPrice: e.target.value})} className="w-full bg-black/40 h-10 rounded-xl text-center outline-none mt-1" /></div>
                        </div>
                    </div>

                    <button onClick={save} className={`w-full py-4 rounded-2xl font-black uppercase text-xs shadow-lg transition-all flex items-center justify-center gap-2 ${saveSuccess ? 'bg-emerald-500 text-white' : 'bg-white text-black'}`}>
                        {isSaving ? <Icon name="Zap" size={16} className="animate-spin"/> : (saveSuccess ? <><Icon name="Check" size={16}/> Saved!</> : 'Save Config')}
                    </button>

                    <button onClick={() => setTheme(theme === 'dark' ? 'light' : (theme === 'light' ? 'rom' : 'dark'))} className="w-full py-4 glass-panel border border-white/10 rounded-2xl flex items-center justify-center gap-3 font-bold text-xs uppercase">
                        {theme === 'dark' ? <Icon name="Sun" /> : (theme === 'light' ? <Icon name="Settings" /> : <Icon name="Moon" />)} ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏° ({theme})
                    </button>
                    
                    <div className="text-center opacity-30 text-[9px] font-bold mt-8 pb-4">{APP_VERSION}</div>
                </div>
            );
        };

        const HomeView = ({ records, userStats, accountConfig }) => {
            const today = new Date().toISOString().split('T')[0];
            const runsToday = records.filter(r => r.date.split('/').reverse().join('-') === today).length;
            const resonancePercent = Math.min(100, Math.floor((runsToday / (accountConfig.totalChars || 1)) * 100));
            const currentRank = RANKS.reduce((prev, curr) => (resonancePercent >= curr.threshold ? curr : prev), RANKS[0]);
            
            // New Milestone Logic: 1, 3, 5
            const nextMilestone = [1, 3, 5].find(m => runsToday < m) || 5;
            
            return (
                <div className="p-6 pb-24 space-y-8 animate-fade-in text-white">
                    <header className="flex justify-between items-start">
                        <div className="flex flex-col">
                            <span className="text-[10px] font-black uppercase tracking-widest opacity-40">Hunter Rank</span>
                            <h2 className={`text-xl font-black italic tracking-tight ${currentRank.color}`}>{currentRank.name}</h2>
                        </div>
                        <div className="text-right">
                            <p className="text-[10px] opacity-40 uppercase font-black">Veteran Tokens</p>
                            <p className="text-xl font-black text-amber-400 leading-none flex justify-end gap-1 items-center">{userStats.veteranTokens || 0} <Icon name="Star" size={16}/></p>
                        </div>
                    </header>

                    <div className={`glass-panel p-6 rounded-[2.5rem] relative overflow-hidden transition-all duration-500`}>
                        <div className="flex justify-between items-end mb-4">
                            <div>
                                <p className="text-[11px] font-black uppercase tracking-tighter opacity-60 flex items-center gap-2">Daily Progress</p>
                                <p className="text-3xl font-black">{runsToday} <span className="text-sm opacity-30">/ {nextMilestone} Goal</span></p>
                            </div>
                            <div className="text-right"><span className="text-2xl font-black">{Math.floor((runsToday/nextMilestone)*100)}%</span></div>
                        </div>
                        <div className="w-full h-4 bg-black/40 rounded-full overflow-hidden border border-white/5">
                            <div className={`h-full resonance-bar rounded-full bg-purple-600`} style={{width: `${Math.min(100, (runsToday/nextMilestone)*100)}%`}}></div>
                        </div>
                        {runsToday >= 5 && <p className="mt-4 text-[10px] text-amber-400 font-bold text-center animate-pulse">OVERDRIVE ACTIVE: Token Drop Enabled</p>}
                    </div>

                    <div className="space-y-3">
                        <p className="text-xs font-black opacity-40 uppercase tracking-widest px-2">Recent</p>
                        {records.slice(0, 3).map(r => (
                            <div key={r.id} className="glass-panel p-4 rounded-2xl flex justify-between items-center border-l-4 border-purple-500">
                                <div>
                                    <p className="font-bold text-sm text-white">{r.date}</p>
                                    <p className="text-[10px] opacity-40 uppercase font-black">{r.mode}</p>
                                </div>
                                <span className="font-black text-emerald-500 text-sm">+{formatMoney(r.profit)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const InventoryView = ({ records, prices, manualSales, onSell, userStats }) => {
            const stockSpell = Math.max(0, records.reduce((a, r) => a + Number(r.purpleStoneCount||0), 0));
            const stockMagic = Math.max(0, records.reduce((a, r) => a + Number(r.contMagicCount||0), 0));
            
            return (
                <div className="p-6 pb-24 space-y-6 text-white animate-fade-in">
                    <h2 className="text-lg font-black uppercase tracking-widest">Inventory</h2>
                    
                    <div className="glass-panel p-6 rounded-3xl border border-amber-500/20 bg-amber-900/10 flex items-center justify-between">
                         <div className="flex items-center gap-4"><div className="p-3 bg-amber-500/20 rounded-full text-amber-400"><Icon name="Medal" size={24}/></div><div><p className="text-[10px] opacity-60 font-bold uppercase text-amber-200">Veteran Tokens</p><p className="text-3xl font-black text-amber-400">{userStats.veteranTokens || 0}</p></div></div>
                    </div>

                    <div className="glass-panel p-6 rounded-[2rem] flex items-center justify-between border-l-4 border-purple-500">
                        <div className="flex items-center gap-4"><SVGs.Spell className="w-10 h-10"/><div><p className="text-[9px] opacity-40 font-bold uppercase">Spell Stock</p><p className="text-3xl font-black">{stockSpell}</p></div></div>
                        <div className="text-right"><p className="text-[9px] opacity-40">{formatMoney(stockSpell * prices.purpleStonePrice)} z</p><button className="mt-1 bg-purple-600 px-3 py-1 rounded-lg text-[9px] font-black">SELL</button></div>
                    </div>
                    
                    <div className="glass-panel p-6 rounded-[2rem] flex items-center justify-between border-l-4 border-rose-500">
                        <div className="flex items-center gap-4"><SVGs.Magic className="w-10 h-10"/><div><p className="text-[9px] opacity-40 font-bold uppercase">Magic Stock</p><p className="text-3xl font-black">{stockMagic}</p></div></div>
                        <div className="text-right"><p className="text-[9px] opacity-40">{formatMoney(stockMagic * prices.contMagicPrice)} z</p><button className="mt-1 bg-rose-600 px-3 py-1 rounded-lg text-[9px] font-black">SELL</button></div>
                    </div>
                </div>
            );
        };

        const HistoryView = ({ records, prices, onDelete }) => {
            const [expandedId, setExpandedId] = useState(null);
            return (
                <div className="p-4 pb-24 space-y-3 animate-fade-in text-white">
                    <h2 className="text-lg font-black mb-4 px-2 uppercase tracking-widest">History Log</h2>
                    {records.map(r => (
                        <div key={r.id} className="glass-panel rounded-3xl overflow-hidden transition-all duration-300">
                            <div className="p-4 flex justify-between items-center cursor-pointer" onClick={() => setExpandedId(expandedId === r.id ? null : r.id)}>
                                <div className="flex gap-4 items-center">
                                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-[8px] font-black uppercase ${r.mode==='aogh'?'bg-rose-500':'bg-purple-500'}`}>{r.mode}</div>
                                    <div><p className="font-bold text-sm">{r.date}</p><p className="text-[10px] opacity-40 font-bold">Spell {r.purpleStoneCount} ‚Ä¢ Magic {r.contMagicCount}</p></div>
                                </div>
                                <div className="text-right flex items-center gap-3">
                                    <p className="font-black text-emerald-500 text-lg">{formatMoney(r.profit)}</p>
                                    <Icon name="ChevronDown" size={16} className={`transition-transform opacity-30 ${expandedId === r.id ? 'rotate-180' : ''}`} />
                                </div>
                            </div>
                            {expandedId === r.id && (
                                <div className="px-4 pb-5 pt-3 text-[11px] bg-black/20 border-t border-white/5 animate-slide-up text-slate-300">
                                    <div className="grid grid-cols-2 gap-4 mb-4 border-b border-white/5 pb-3">
                                        <div><p className="opacity-40 uppercase text-[9px]">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p><p className="font-bold text-emerald-400">{formatFullMoney(r.profit)} z</p></div>
                                        <div><p className="opacity-40 uppercase text-[9px]">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</p><p className="font-bold">{r.minutesUsed} ‡∏ô‡∏≤‡∏ó‡∏µ</p></div>
                                    </div>
                                    <div className="space-y-1.5 mb-4 border-b border-white/5 pb-3">
                                        <p className="opacity-40 text-[9px] uppercase font-black">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (Revenue)</p>
                                        <div className="flex justify-between"><span>‡∏Ç‡∏¢‡∏∞</span><span>+{formatFullMoney(r.trashAmount)} z</span></div>
                                        <div className="flex justify-between"><span>Spell x{r.purpleStoneCount}</span><span>{r.isSellingSpell ? `+${formatFullMoney(Number(r.purpleStoneCount)*prices.purpleStonePrice)}` : '(‡πÄ‡∏Å‡πá‡∏ö)'}</span></div>
                                        {r.mode === 'aogh' && <div className="flex justify-between"><span>Magic x{r.contMagicCount}</span><span>{r.isSellingMagic ? `+${formatFullMoney(Number(r.contMagicCount)*prices.contMagicPrice)}` : '(‡πÄ‡∏Å‡πá‡∏ö)'}</span></div>}
                                    </div>
                                    <div className="space-y-1.5 mb-4 border-b border-white/5 pb-3">
                                        <p className="opacity-40 text-[9px] uppercase font-black">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (Costs)</p>
                                        <div className="flex justify-between text-rose-300"><span>Gum x{r.normalCount}</span><span>-{formatFullMoney(r.savedCostGum)} z</span></div>
                                        <div className="flex justify-between text-rose-300"><span>Silvervine</span><span>-{formatFullMoney(r.savedCostSv)} z</span></div>
                                        {(r.otherCosts || []).map((c, i) => <div key={i} className="flex justify-between pl-2 text-rose-200 opacity-80"><span>‚Ä¢ {c.name}</span><span>-{formatFullMoney(c.amount)} z</span></div>)}
                                    </div>
                                    {r.notes && <div className="mb-4 p-3 bg-black/20 rounded-xl italic opacity-70">"{r.notes}"</div>}
                                    <button onClick={()=>onDelete(r.id)} className="w-full py-2 bg-rose-500/10 text-rose-500 rounded-xl font-bold flex items-center justify-center gap-2"><Icon name="Trash" size={12}/> ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [activeTab, setActiveTab] = useState('home'); 
            const [records, setRecords] = useState([]);
            const [targetUid, setTargetUid] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userStats, setUserStats] = useState(INITIAL_STATS);
            const [accountConfig, setAccountConfig] = useState({ totalChars: 1, purpleStonePrice: 0, contMagicPrice: 0, gumBoxPrice: 0, silvervineBoxPrice: 0 });
            const [isSaving, setIsSaving] = useState(false);
            const [db, setDb] = useState(null);
            const [toast, setToast] = useState(null);
            const [rewardData, setRewardData] = useState(null);
            const [theme, setTheme] = useState('dark');

            useEffect(() => {
                const init = async () => {
                    const { initializeApp, getAuth, getFirestore, signInAnonymously, onAuthStateChanged } = window.firebaseModules;
                    const app = initializeApp(MANUAL_FIREBASE_CONFIG);
                    const auth = getAuth(app);
                    setDb(getFirestore(app));
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, u => { if(u) setTargetUid(u.uid); setLoading(false); });
                };
                init();
            }, []);

            useEffect(() => {
                if(!targetUid || !db) return;
                const { collection, onSnapshot, doc, query, orderBy } = window.firebaseModules;
                const unsubRecords = onSnapshot(query(collection(db, 'artifacts', 'ogh-reforged', 'users', targetUid, 'records'), orderBy('timestamp', 'desc')), snap => setRecords(snap.docs.map(d => ({...d.data(), id: d.id}))));
                const unsubConfig = onSnapshot(doc(db, 'artifacts', 'ogh-reforged', 'users', targetUid, 'config', 'account'), d => { if(d.exists()) setAccountConfig(d.data()); });
                const unsubStats = onSnapshot(doc(db, 'artifacts', 'ogh-reforged', 'users', targetUid, 'gamification', 'stats'), d => { if(d.exists()) setUserStats(d.data()); });
                return () => { unsubRecords(); unsubConfig(); unsubStats(); };
            }, [targetUid, db]);

            useEffect(() => { document.body.className = theme; }, [theme]);

            if(loading || !db) return <div className="min-h-screen flex items-center justify-center bg-slate-950 text-purple-500 font-black animate-pulse text-xs uppercase tracking-widest">LOADING REFORGED...</div>;

            return (
                <div className={`min-h-screen transition-colors duration-500 ${theme === 'dark' ? 'text-white' : (theme === 'light' ? 'bg-slate-100 text-slate-900' : 'bg-[#1a1d2e] text-slate-200')}`}>
                    {toast && <Toast message={toast.message} onClose={() => setToast(null)} />}
                    {rewardData && <RewardPopup data={rewardData} onClose={() => setRewardData(null)} />}
                    
                    <div className="max-w-md mx-auto min-h-screen relative">
                        {activeTab === 'home' && <HomeView records={records} userStats={userStats} accountConfig={accountConfig} />}
                        {activeTab === 'history' && <HistoryView records={records} prices={accountConfig} onDelete={async (id) => { const { deleteDoc, doc } = window.firebaseModules; await deleteDoc(doc(db, 'artifacts', 'ogh-reforged', 'users', targetUid, 'records', id)); }} />}
                        {activeTab === 'inventory' && <InventoryView records={records} prices={accountConfig} onSell={() => {}} userStats={userStats} />}
                        {activeTab === 'settings' && <SettingsView uid={targetUid} config={accountConfig} db={db} updateConfig={setAccountConfig} theme={theme} setTheme={setTheme} />}
                        {activeTab === 'add' && <AddDataView onClose={() => setActiveTab('home')} targetUid={targetUid} db={db} prices={accountConfig} accountConfig={accountConfig} userStats={userStats} allRecords={records} setGlobalIsSaving={setIsSaving} onSuccess={r => { if(r) setRewardData(r); setActiveTab('home'); }} theme={theme} />}
                    </div>

                    <nav className={`fixed bottom-0 left-0 right-0 max-w-md mx-auto border-t pb-6 pt-2 px-4 flex justify-between items-center z-40 backdrop-blur-xl transition-all ${theme === 'light' ? 'bg-white/90 border-slate-200 text-slate-500' : 'bg-slate-950/90 border-white/5 text-white'}`}>
                        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 w-12 transition-all ${activeTab === 'home' ? 'text-purple-500' : 'opacity-30'}`}><Icon name="Home" size={20}/><span className="text-[9px] font-bold uppercase">Home</span></button>
                        <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center gap-1 w-12 transition-all ${activeTab === 'history' ? 'text-purple-500' : 'opacity-30'}`}><Icon name="History" size={20}/><span className="text-[9px] font-bold uppercase">Logs</span></button>
                        <div className="relative -top-6">
                            <button id="hidden-submit-btn" type={activeTab === 'add' ? 'submit' : 'button'} onClick={() => { if(activeTab !== 'add') setActiveTab('add'); }} className={`w-14 h-14 rounded-full flex items-center justify-center shadow-2xl active:scale-90 transition-transform ${activeTab === 'add' ? 'bg-emerald-500 text-white' : 'bg-purple-600 text-white'}`}>
                                {isSaving ? <Icon name="Zap" size={24} className="animate-spin"/> : (activeTab === 'add' ? <Icon name="Save" size={24}/> : <Icon name="Plus" size={28}/>)}
                            </button>
                        </div>
                        <button onClick={() => setActiveTab('inventory')} className={`flex flex-col items-center gap-1 w-12 transition-all ${activeTab === 'inventory' ? 'text-purple-500' : 'opacity-30'}`}><Icon name="Box" size={20}/><span className="text-[9px] font-bold uppercase">Stock</span></button>
                        <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center gap-1 w-12 transition-all ${activeTab === 'settings' ? 'text-purple-500' : 'opacity-30'}`}><Icon name="Settings" size={20}/><span className="text-[9px] font-bold uppercase">Setting</span></button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
