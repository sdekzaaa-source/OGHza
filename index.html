<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OGHza Tracker V2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Add Prop-Types for Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Kanit:wght@300;400;500;700;900&display=swap');
        
        :root {
            --app-bg: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.95);
        }

        body { 
            font-family: 'Inter', 'Kanit', sans-serif; 
            background-color: var(--app-bg); 
            color: #f1f5f9; 
            overflow-x: hidden; 
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
        }

        .glass-panel { 
            background: var(--glass-bg); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        .view-content {
            padding-bottom: calc(env(safe-area-inset-bottom) + 120px) !important;
        }

        .nav-bar-padding {
            padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
        }

        .progress-bar { transition: width 0.5s ease-out; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { transform: opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-in-out forwards; }

        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop-in { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

        @keyframes huginFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-hugin { animation: huginFloat 3s ease-in-out infinite; }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs, limit } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const { useState, useEffect, useMemo, useRef } = React;

        // --- Global Constants ---
        var APP_VERSION = "Ver.2.18.3 (Compact Layout)";
        
        var CHANGELOGS = [
            { ver: "2.18.3", date: "Latest", desc: "‡∏à‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤ New Run ‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏ß‡∏° Time, Gum, Silvervine ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß" },
            { ver: "2.18.2", date: "Previous", desc: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ Gum, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Settings ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÅ‡∏à, ‡πÅ‡∏Å‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö History, ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Share ‡πÄ‡∏ô‡πâ‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" },
            { ver: "2.18.1", date: "Old", desc: "‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á UI ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô (Unified Border Radius)" }
        ];

        var MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAbWzr8o_OhkjGbEetBYq_nzYmVZ2fTf40",
            authDomain: "rocogh-88a38.firebaseapp.com",
            projectId: "rocogh-88a38",
            storageBucket: "rocogh-88a38.firebasestorage.app",
            messagingSenderId: "1025971309206",
            appId: "1:1025971309206:web:d4f9e0ab6bb016dde590b7"
        };

        var INITIAL_STATS = { 
            baseLv: 1, baseExp: 0, jobLv: 1, jobExp: 0, 
            jobClass: 'Novice', coins: 0, zeny: 0, isHighClass: false,
            virtual_inventory: {} 
        };

        var DROP_TABLE = [
            { id: 'elu', name: 'Elunium', rate: 0.4, min: 1, max: 2, icon: 'Elunium' },
            { id: 'ori', name: 'Oridecon', rate: 0.4, min: 1, max: 2, icon: 'Oridecon' },
            { id: 'card_wk', name: 'White Knight Card', rarity: 'Rare', rate: 0.05, min: 1, max: 1, icon: 'Card', rare: true },
            { id: 'card_kk', name: 'Khalitzburg Knight Card', rarity: 'Rare', rate: 0.05, min: 1, max: 1, icon: 'Card', rare: true },
            { id: 'card_ogh', name: 'Old Glast Heim Card', rarity: 'Legendary', rate: 0.001, min: 1, max: 1, icon: 'Card', rare: true, legendary: true }
        ];

        var ITEM_DETAILS = {
            'spell': { name: 'Coagulated Spell', desc: '‡∏ú‡∏•‡∏∂‡∏Å‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡πÅ‡∏ô‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πâ‡∏≠‡∏ô ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡πÉ‡∏ô Glast Heim', type: 'Etc', rarity: 'Common' },
            'magic': { name: 'Contaminated Magic', desc: '‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏ô‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏î ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô', type: 'Etc', rarity: 'Uncommon' },
            'elu': { name: 'Elunium', desc: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏´‡∏≤‡∏¢‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏¥‡∏® ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (Armor)', type: 'Ore', rarity: 'Common' },
            'ori': { name: 'Oridecon', desc: '‡πÅ‡∏£‡πà‡∏ò‡∏≤‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏µ‡πà‡∏¢‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏•‡πâ‡∏≤‡∏á ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò (Weapon)', type: 'Ore', rarity: 'Common' },
            'card_wk': { name: 'White Knight Card', desc: '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö Rare ‡∏Ç‡∏≠‡∏á‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô‡∏Ç‡∏≤‡∏ß ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏•‡∏±‡∏á‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏ç‡πà 20%', type: 'Card', rarity: 'Rare' },
            'card_kk': { name: 'Khalitzburg Knight Card', desc: '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö Rare ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≤‡∏•‡∏¥‡∏ó‡∏ã‡πå‡πÄ‡∏ö‡∏¥‡∏£‡πå‡∏Å ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏ç‡πà 25%', type: 'Card', rarity: 'Rare' },
            'card_ogh': { name: 'Old Glast Heim Card', desc: '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏Å‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏ô‡∏ã‡∏≤‡∏Å‡∏õ‡∏£‡∏±‡∏Å‡∏´‡∏±‡∏Å‡∏û‡∏±‡∏á‡∏Ç‡∏≠‡∏á Glast Heim ‡∏°‡∏≠‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á', type: 'Card', rarity: 'Legendary' }
        };

        // --- Helper Functions ---
        function formatMoney(n) { return new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(n || 0); }
        function formatFullMoney(n) { return new Intl.NumberFormat('th-TH').format(n || 0); }
        function getExpReq(lv, type) { return Math.floor(100 * Math.pow(lv || 1, 1.5)); }

        function handleNumberInput(e, field, setter) {
            const val = e.target.value.replace(/[^0-9]/g, '');
            setter(prev => ({ ...prev, [field]: val }));
        }

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try { document.execCommand('copy'); return true; } catch (err) { return false; } finally { document.body.removeChild(textArea); }
        }

        function simulateDrops() {
            const drops = [];
            DROP_TABLE.forEach(item => {
                if (Math.random() <= item.rate) {
                    const qty = Math.floor(Math.random() * (item.max - item.min + 1)) + item.min;
                    drops.push({ ...item, qty });
                }
            });
            return drops;
        }

        // --- SVGs ---
        var SVGs = {
            Hugin: ({className}) => (<svg viewBox="0 0 120 120" className={className} fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M35,45 Q30,80 60,95 Q90,80 85,45" fill="#f5d0a9" stroke="#5a3a29" strokeWidth="2.5" /><path d="M30,60 Q25,65 32,70" fill="#f5d0a9" stroke="#5a3a29" strokeWidth="2" /><path d="M90,60 Q95,65 88,70" fill="#f5d0a9" stroke="#5a3a29" strokeWidth="2" /><path d="M25,50 C10,20 110,20 95,50 C100,30 90,10 60,10 C30,10 20,30 25,50" fill="#fbbf24" stroke="#92400e" strokeWidth="2.5" /><circle cx="50" cy="58" r="2.5" fill="#1e293b" /><circle cx="70" cy="58" r="2.5" fill="#1e293b" /><path d="M52,82 Q60,85 68,82" stroke="#5a3a29" strokeWidth="2" fill="none" strokeLinecap="round" /></svg>),
            Spell: ({className}) => (
                <svg viewBox="0 0 100 120" className={className} fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
                    <polygon points="50,5 92,30 92,90 50,115 8,90 8,30" fill="#4b3a8a"/>
                    <polygon points="50,5 8,30 8,90 50,115 50,60" fill="#6a4eb3"/>
                    <polygon points="50,5 92,30 92,90 50,115 50,60" fill="#8464d1"/>
                    <polygon points="50,20 80,40 80,80 50,100 20,80 20,40" fill="#a68af0"/>
                    <g stroke="#ffffff" strokeWidth="0.5" strokeOpacity="0.3">
                        <line x1="50" y1="5" x2="50" y2="20"/>
                        <line x1="8" y1="30" x2="20" y2="40"/>
                        <line x1="92" y1="30" x2="80" y2="40"/>
                        <line x1="8" y1="90" x2="20" y2="80"/>
                        <line x1="92" y1="90" x2="80" y2="80"/>
                        <line x1="50" y1="115" x2="50" y2="100"/>
                    </g>
                    <rect x="30" y="35" width="8" height="8" fill="white" opacity="0.6" rx="1"/>
                    <polygon points="50,5 92,30 92,90 50,115 8,90 8,30" fill="none" stroke="#9d81e1" strokeWidth="2" strokeLinejoin="round"/>
                </svg>
            ),
            Magic: ({className}) => (
                <svg viewBox="0 0 100 120" className={className} fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
                    <polygon points="50,5 92,30 92,90 50,115 8,90 8,30" fill="#7a1a1a"/>
                    <polygon points="50,5 8,30 8,90 50,115 50,60" fill="#a32929"/>
                    <polygon points="50,5 92,30 92,90 50,115 50,60" fill="#c43333"/>
                    <polygon points="50,20 80,40 80,80 50,100 20,80 20,40" fill="#ff5757"/>
                    <g stroke="#ffffff" strokeWidth="0.5" strokeOpacity="0.3">
                        <line x1="50" y1="5" x2="50" y2="20"/>
                        <line x1="8" y1="30" x2="20" y2="40"/>
                        <line x1="92" y1="30" x2="80" y2="40"/>
                        <line x1="8" y1="90" x2="20" y2="80"/>
                        <line x1="92" y1="90" x2="80" y2="80"/>
                        <line x1="50" y1="115" x2="50" y2="100"/>
                    </g>
                    <rect x="30" y="35" width="8" height="8" fill="white" opacity="0.6" rx="1"/>
                    <polygon points="50,5 92,30 92,90 50,115 8,90 8,30" fill="none" stroke="#ff7a7a" strokeWidth="2" strokeLinejoin="round"/>
                </svg>
            ),
            Oridecon: ({className}) => (
                <svg viewBox="0 0 300 400" className={className} xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="crystalBody" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stopColor="#dbeafe"></stop>
                            <stop offset="50%" stopColor="#60a5fa"></stop>
                            <stop offset="100%" stopColor="#2563eb"></stop>
                        </linearGradient>
                        <linearGradient id="crystalSide" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stopColor="#93c5fd"></stop>
                            <stop offset="100%" stopColor="#1e40af"></stop>
                        </linearGradient>
                        <linearGradient id="sheen" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stopColor="white" stopOpacity="0.9"></stop>
                            <stop offset="100%" stopColor="white" stopOpacity="0.1"></stop>
                        </linearGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="1.5" result="coloredBlur"></feGaussianBlur>
                            <feMerge>
                                <feMergeNode in="coloredBlur"></feMergeNode>
                                <feMergeNode in="SourceGraphic"></feMergeNode>
                            </feMerge>
                        </filter>
                    </defs>
                    <g transform="scale(1.2) translate(10, 10)">
                        <g transform="translate(60, 200) rotate(-25) scale(0.8)">
                            <path d="M 0,0 L -40,100 L 0,200 L 0,0" fill="url(#crystalSide)" stroke="#60a5fa" strokeWidth="1"></path>
                            <path d="M 0,0 L 40,80 L 0,200 L 0,0" fill="url(#crystalBody)" stroke="#bfdbfe" strokeWidth="1"></path>
                            <path d="M -5,20 L -25,90 L -15,95 L 0,30" fill="white" opacity="0.4"></path>
                            <path d="M 0,0 L 0,200" stroke="#bfdbfe" strokeWidth="1" opacity="0.6"></path>
                        </g>
                        <g transform="translate(100, 320) rotate(-15) scale(0.4)">
                            <path d="M 0,-50 L -30,20 L 0,80 L 30,10 L 0,-50" fill="url(#crystalBody)" stroke="#60a5fa" strokeWidth="2"></path>
                            <path d="M 0,-50 L 0,80" stroke="white" strokeWidth="3" opacity="0.5"></path>
                        </g>
                        <g transform="translate(150, 50)">
                            <path d="M 0,0 L -50,150 L 0,320" fill="none" stroke="#1d4ed8" strokeWidth="1"></path>
                            <path d="M 0,0 L -50,150 L 0,320 L 0,0" fill="url(#crystalSide)" stroke="#3b82f6" strokeWidth="0.5"></path>
                            <path d="M 0,0 L 50,130 L 0,320 L 0,0" fill="url(#crystalBody)" stroke="#93c5fd" strokeWidth="0.5"></path>
                            <path d="M 0,0 L 0,320" stroke="white" strokeWidth="2" opacity="0.4"></path>
                            <path d="M 5,40 L 40,130 L 10,250 L 2,260" fill="url(#sheen)" opacity="0.3"></path>
                            <path d="M 10,50 L 35,120" stroke="white" strokeWidth="3" opacity="0.6" strokeLinecap="round"></path>
                            <path d="M -5,60 L -40,150 L -10,200" fill="white" opacity="0.15"></path>
                            <path d="M -15,100 L -35,150" stroke="white" strokeWidth="2" opacity="0.5" strokeLinecap="round"></path>
                        </g>
                        <g transform="translate(230, 220) rotate(10) scale(0.5)">
                            <path d="M 0,-60 L -30,20 L 0,90 L 30,10 L 0,-60" fill="url(#crystalBody)" stroke="#93c5fd" strokeWidth="2"></path>
                            <path d="M 0,-60 L 0,90" stroke="white" strokeWidth="2" opacity="0.7"></path>
                            <path d="M 5,-30 L 20,10" stroke="white" strokeWidth="4" opacity="0.5" strokeLinecap="round"></path>
                        </g>
                        <g filter="url(#glow)">
                            <circle cx="150" cy="50" r="3" fill="white"></circle>
                            <path d="M 150,40 L 150,60 M 140,50 L 160,50" stroke="white" strokeWidth="2"></path>
                            <circle cx="90" cy="180" r="2" fill="white" opacity="0.8"></circle>
                            <circle cx="230" cy="180" r="2" fill="white" opacity="0.8"></circle>
                            <circle cx="170" cy="120" r="1.5" fill="white" opacity="0.6"></circle>
                            <circle cx="130" cy="250" r="1" fill="white" opacity="0.5"></circle>
                            <circle cx="210" cy="250" r="1.5" fill="white" opacity="0.4"></circle>
                        </g>
                    </g>
                </svg>
            ),
            Elunium: ({className}) => (
                <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <radialGradient id="oreGrad" cx="40%" cy="40%" r="60%">
                            <stop offset="0%" stopColor="#d1d1e9"/>
                            <stop offset="40%" stopColor="#a8a4c1"/>
                            <stop offset="80%" stopColor="#7b7593"/>
                            <stop offset="100%" stopColor="#5a5470"/>
                        </radialGradient>
                        <filter id="oreTexture" x="0" y="0" width="100%" height="100%">
                            <feTurbulence type="fractalNoise" baseFrequency="0.6" numOctaves="3" result="noise"/>
                            <feDiffuseLighting in="noise" lightingColor="#ffffff" surfaceScale="1">
                                <feDistantLight azimuth="45" elevation="35"/>
                            </feDiffuseLighting>
                            <feComposite in2="SourceGraphic" operator="in"/>
                        </filter>
                        <filter id="innerGlow">
                            <feGaussianBlur stdDeviation="3" in="SourceAlpha" result="blur"/>
                            <feOffset dx="2" dy="2" result="offsetBlur"/>
                            <feComposite in="SourceGraphic" in2="offsetBlur" operator="out" result="innerShadow"/>
                            <feFlood floodColor="black" floodOpacity="0.3" result="color"/>
                            <feComposite in="color" in2="innerShadow" operator="in" result="shadow"/>
                            <feComposite in="shadow" in2="SourceGraphic" operator="over"/>
                        </filter>
                    </defs>
                    <ellipse cx="100" cy="175" rx="60" ry="12" fill="#000" opacity="0.2"/>
                    <path d="M100,30 C140,30 175,65 175,100 C175,140 135,170 100,170 C60,170 25,140 25,100 C25,60 60,30 100,30 Z" fill="url(#oreGrad)" stroke="#4a445e" strokeWidth="1.5" filter="url(#innerGlow)"/>
                    <g opacity="0.4">
                        <circle cx="70" cy="70" r="8" fill="#5a5470"/>
                        <circle cx="120" cy="60" r="6" fill="#6d6684"/>
                        <circle cx="140" cy="110" r="10" fill="#4a445e"/>
                        <circle cx="90" cy="130" r="7" fill="#5a5470"/>
                        <circle cx="60" cy="115" r="5" fill="#6d6684"/>
                        <circle cx="110" cy="95" r="4" fill="#4a445e"/>
                        <circle cx="150" cy="80" r="3" fill="#5a5470"/>
                    </g>
                    <ellipse cx="80" cy="70" rx="30" ry="20" fill="white" opacity="0.15" transform="rotate(-20, 80, 70)"/>
                    <path d="M130,140 Q135,150 145,145" fill="none" stroke="#2d2a3a" strokeWidth="1" opacity="0.3"/>
                </svg>
            ),
            Card: ({className}) => (
                <svg viewBox="0 0 300 400" className={className} xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <clipPath id="inner-frame-clip"><rect x="8" y="8" width="284" height="384" rx="6" ry="6"></rect></clipPath>
                        <filter id="ray-blur"><feGaussianBlur stdDeviation="5.5"></feGaussianBlur></filter>
                        <filter id="grain">
                            <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" result="noise"></feTurbulence>
                            <feColorMatrix type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 0.25 0" in="noise" result="coloredNoise"></feColorMatrix>
                            <feComposite operator="in" in="coloredNoise" in2="SourceGraphic" result="composite"></feComposite>
                            <feBlend mode="multiply" in="composite" in2="SourceGraphic"></feBlend>
                        </filter>
                        <filter id="inner-shadow"><feGaussianBlur stdDeviation="2.5"></feGaussianBlur></filter>
                        <radialGradient id="irisGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                            <stop offset="0%" stopColor="#d0d0d0"></stop>
                            <stop offset="80%" stopColor="#a0958d"></stop>
                            <stop offset="100%" stopColor="#807570"></stop>
                        </radialGradient>
                    </defs>
                    <rect x="0" y="0" width="300" height="400" fill="#a18a80" rx="12" ry="12"></rect>
                    <g clipPath="url(#inner-frame-clip)">
                        <rect x="0" y="0" width="300" height="400" fill="url(#grain)" opacity="0.6" pointerEvents="none"></rect>
                        <g stroke="#1a1a1a" strokeWidth="13" strokeLinecap="round" opacity="0.7" filter="url(#ray-blur)">
                            <line x1="0" y1="0" x2="110" y2="120"></line>
                            <line x1="150" y1="-20" x2="150" y2="110"></line>
                            <line x1="300" y1="0" x2="190" y2="120"></line>
                            <line x1="0" y1="400" x2="110" y2="280"></line>
                            <line x1="150" y1="420" x2="150" y2="290"></line>
                            <line x1="300" y1="400" x2="190" y2="280"></line>
                        </g>
                        <g transform="translate(0, 10)">
                            <path d="M 50,200 Q 150,90 250,200 Q 150,300 50,200 Z" fill="#f2f2f2" stroke="none"></path>
                            <path d="M 50,200 Q 150,90 250,200 Q 150,115 50,200 Z" fill="#000" opacity="0.15" filter="url(#inner-shadow)"></path>
                            <path d="M 50,200 Q 150,300 250,200 Q 150,275 50,200 Z" fill="#000" opacity="0.1" filter="url(#inner-shadow)"></path>
                            <circle cx="150" cy="200" r="44" fill="url(#irisGradient)" stroke="#6b6058" strokeWidth="1" opacity="0.95"></circle>
                            <circle cx="150" cy="200" r="19" fill="#111"></circle>
                            <ellipse cx="140" cy="190" rx="7" ry="5" fill="#fff" opacity="0.6" transform="rotate(-45 140 190)" filter="url(#inner-shadow)"></ellipse>
                            <path id="upperLid" d="M 45,200 Q 150,90 255,200" fill="none" stroke="#1a1a1a" strokeWidth="3.5" strokeLinecap="round"></path>
                            <path d="M 50,200 Q 150,300 245,200" fill="none" stroke="#4a3e3e" strokeWidth="2" strokeLinecap="round" opacity="0.6"></path>
                            <path d="M 70,250 Q 150,285 230,250" fill="none" stroke="#4a3e3e" strokeWidth="1.5" strokeLinecap="round" opacity="0.4"></path>
                            <path d="M 253,198 C 275,212 288,205 285,190 C 282,185 275,185 272,192" fill="none" stroke="#1a1a1a" strokeWidth="5.5" strokeLinecap="round"></path>
                            <g stroke="#1a1a1a" strokeWidth="1" fill="none" strokeLinecap="round">
                                <path d="M 65,170 C 55,145 60,125 70,110"></path>
                                <path d="M 100,135 C 98,110 102,90 110,80"></path>
                                <path d="M 150,108 C 150,90 155,75 160,65"></path>
                                <path d="M 200,130 C 205,110 210,95 220,85"></path>
                            </g>
                            <g stroke="#1a1a1a" strokeWidth="0.8" fill="none" strokeLinecap="round" opacity="0.6">
                                <path d="M 70,230 Q 65,245 70,250"></path>
                                <path d="M 110,250 Q 105,265 110,270"></path>
                                <path d="M 150,260 Q 150,275 155,280"></path>
                                <path d="M 190,250 Q 195,265 200,270"></path>
                            </g>
                        </g>
                    </g>
                    <rect x="8" y="8" width="284" height="384" rx="6" ry="6" fill="none" stroke="#f0f0f0" strokeWidth="4" pointerEvents="none"></rect>
                    <rect x="0" y="0" width="300" height="400" rx="12" ry="12" fill="none" stroke="#1a1a1a" strokeWidth="8" pointerEvents="none"></rect>
                </svg>
            ),
            Zeny: ({className}) => (
                <svg viewBox="0 0 24 24" className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/></svg>
            ),
            Crown: ({className}) => (
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}><path d="M15 70 L25 30 L45 60 L50 20 L55 60 L75 30 L85 70 L85 85 Q85 90 80 90 L20 90 Q15 90 15 85 Z" fill="#fbbf24" stroke="#d97706" strokeWidth="3"/><circle cx="25" cy="30" r="5" fill="#ef4444" stroke="#991b1b" strokeWidth="2"/><circle cx="50" cy="20" r="5" fill="#3b82f6" stroke="#1e3a8a" strokeWidth="2"/><circle cx="75" cy="30" r="5" fill="#ef4444" stroke="#991b1b" strokeWidth="2"/></svg>
            ),
            Poring: ({className}) => (
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}><path d="M50 15 C25 15 5 35 5 60 C5 85 25 95 50 95 C75 95 95 85 95 60 C95 35 75 15 50 15 Z" fill="#f472b6" stroke="#db2777" strokeWidth="3"/><ellipse cx="35" cy="55" rx="4" ry="9" fill="#1e293b"/><ellipse cx="65" cy="55" rx="4" ry="9" fill="#1e293b"/><path d="M45 68 Q50 73 55 68" stroke="#1e293b" strokeWidth="3" strokeLinecap="round"/></svg>
            ),
            Skull: ({className}) => (
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}><path d="M50 10 C30 10 15 25 15 45 C15 55 20 65 25 70 L25 85 C25 88 28 90 32 90 L68 90 C72 90 75 88 75 85 L75 70 C80 65 85 55 85 45 C85 25 70 10 50 10 Z" fill="#cbd5e1" stroke="#475569" strokeWidth="3"/><circle cx="35" cy="45" r="8" fill="#1e293b"/><circle cx="65" cy="45" r="8" fill="#1e293b"/><path d="M46 65 L50 60 L54 65 L50 72 Z" fill="#1e293b"/></svg>
            ),
            Gum: ({className}) => (
                <svg viewBox="0 0 160 160" className={className} fill="none" xmlns="http://www.w3.org/2000/svg"><g transform="rotate(15, 80, 100)"><rect x="30" y="80" width="100" height="35" rx="3" fill="#ffb38a" stroke="#d18a66" strokeWidth="1.5"></rect><rect x="35" y="83" width="90" height="29" rx="2" fill="#ffe0cf"></rect><circle cx="50" cy="97" r="6" fill="#ff7da1"></circle></g><g transform="rotate(-30, 80, 70)"><rect x="30" y="45" width="100" height="35" rx="3" fill="#a0d8f5" stroke="#6ba8cc" strokeWidth="1.5"></rect><rect x="35" y="48" width="90" height="29" rx="2" fill="#def4ff"></rect><circle cx="55" cy="62" r="5" fill="#ff9aa2"></circle><circle cx="70" cy="58" r="6" fill="#fff5ba"></circle><rect x="95" y="55" width="12" height="15" rx="1" fill="#4d3b2c" opacity="0.8"></rect></g></svg>
            ),
            Silvervine: ({className}) => (
                <svg viewBox="0 0 120 160" className={className} fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M60,10 L60,25" stroke="#4a7729" strokeWidth="4" strokeLinecap="round"></path><path d="M60,25 C75,25 75,45 75,60 C75,80 95,90 95,115 C95,145 75,155 60,155 C45,155 25,145 25,115 C25,90 45,80 45,60 C45,45 45,25 60,25 Z" fill="#8cc63f"></path></svg>
            ),
            Camera: ({className}) => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
            ),
            GumBox: ({className}) => (
                <svg viewBox="0 0 150 150" className={className} fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M30,50 L120,50 L125,120 L25,120 Z" fill="#b1a5cc" stroke="#7e709e" strokeWidth="2"></path><path d="M25,55 L125,55 L125,35 C125,35 75,30 25,35 Z" fill="#c9bddb" stroke="#7e709e" strokeWidth="2"></path><path d="M90,120 C100,105 125,110 125,95 L125,120 Z" fill="#d4af37" opacity="0.6"></path><path d="M30,50 L45,50 L30,65 Z" fill="#d4af37" opacity="0.8"></path><path d="M120,50 L105,50 L120,65 Z" fill="#d4af37" opacity="0.8"></path></svg>
            ),
            SilvervineBox: ({className}) => (
                <svg viewBox="0 0 250 200" className={className} fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M40,80 L210,80 L220,160 L30,160 Z" fill="#b19cd9" stroke="#5e449e" strokeWidth="2"></path><path d="M30,85 C30,30 220,30 220,85 L220,95 L30,95 Z" fill="#c3b1e1" stroke="#5e449e" strokeWidth="2"></path><path d="M45,85 C45,45 205,45 205,85" fill="none" stroke="white" strokeWidth="3" strokeOpacity="0.3"></path><rect x="35" y="80" width="10" height="85" fill="#f9e498" rx="2"></rect><rect x="205" y="80" width="10" height="85" fill="#f9e498" rx="2"></rect><rect x="35" y="85" width="180" height="8" fill="#f9e498"></rect><circle cx="125" cy="95" r="22" fill="#fdf2d0" stroke="#d4a017" strokeWidth="2"></circle><circle cx="125" cy="82" r="5" fill="#ff44cc" stroke="white" strokeWidth="1"></circle><path d="M110,105 Q125,120 140,105" fill="none" stroke="#d4a017" strokeWidth="2"></path></svg>
            ),
            Cost: ({className}) => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            ),
            Clock: ({className}) => (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            )
        };

        function Icon({ name, size = 20, className = "" }) {
            const icons = {
                Home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
                History: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
                Box: <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>,
                Settings: <><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                Copy: <><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></>,
                Warp: <><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z" opacity="0.3"/><path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10 10 10 0 0 1-10-10A10 10 0 0 1 12 2m0 2a8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8 8 8 0 0 0-8-8z"/><path d="M12 8a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 2a2 2 0 0 0-2 2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2z"/></>,
                Lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
                ChevronDown: <polyline points="6 9 12 15 18 9"/>,
                ChevronUp: <polyline points="18 15 12 9 6 15"/>,
                ToggleOn: <><rect x="1" y="5" width="22" height="14" rx="7" fill="#4ade80"/><circle cx="16" cy="12" r="5" fill="white"/></>,
                ToggleOff: <><rect x="1" y="5" width="22" height="14" rx="7" fill="#475569"/><circle cx="8" cy="12" r="5" fill="white"/></>,
                Trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
                Refresh: <><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></>,
                Key: <><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></>,
                Pen: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>,
                TrendingUp: <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>,
                Check: <polyline points="20 6 9 17 4 12"/>,
                AlertTriangle: <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>,
                Sparkles: <path d="M12 3v1m0 16v1m5-15-1 1m-10 10-1 1M21 12h-1M4 12H3m15.364 6.364-1 1m-10.728-10.728-1 1M12 8l-2 4 2 4 2-4-2-4z"/>,
                Loader: <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/>,
                X: <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>,
                Share: <><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></>
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        }

        // --- UI Components ---
        function Toast({ message, onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 2500);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] animate-slide-down pointer-events-none w-full max-w-sm px-4">
                    <div className="bg-slate-800/95 backdrop-blur-md border border-white/10 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 justify-center">
                        <div className="bg-emerald-500/20 p-1 rounded-full text-emerald-400">
                            <Icon name="Check" size={14} />
                        </div>
                        <span className="text-xs font-bold tracking-wide">{message}</span>
                    </div>
                </div>
            );
        }

        function RewardPopup({ data, onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const current = data.profit;
            const avg = data.average || 0;
            let iconType = 'Poring';
            let message = "Normal Luck";
            let color = "text-emerald-400";
            
            if (avg > 0) {
                const ratio = current / avg;
                if (ratio > 1.15) {
                    iconType = 'Crown';
                    message = "Great Fortune!";
                    color = "text-amber-400";
                } else if (ratio < 0.85) {
                    iconType = 'Skull';
                    message = "Bad Luck...";
                    color = "text-slate-400";
                }
            }

            const IconComp = SVGs[iconType] || SVGs.Poring;

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-slate-900 border border-yellow-500/30 p-8 rounded-3xl text-center relative overflow-hidden animate-pop-in shadow-2xl shadow-yellow-500/20 max-w-xs w-full">
                        <div className="absolute inset-0 bg-yellow-500/5 mix-blend-overlay"></div>
                        <div className="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce bg-black/20 border-2 border-white/10">
                            <IconComp className={`w-16 h-16 drop-shadow-xl ${color}`} />
                        </div>
                        <h3 className={`text-2xl font-black mb-1 ${color}`}>{message}</h3>
                        <p className="text-xs text-slate-400 font-bold tracking-widest uppercase mb-6">Profit: {formatMoney(current)} z</p>
                        
                        <div className="flex justify-center gap-4 mb-4">
                            <div className="bg-slate-800 p-3 rounded-2xl min-w-[80px]">
                                <p className="text-[10px] opacity-50 uppercase">Exp</p>
                                <p className="text-lg font-black text-white">+50</p>
                            </div>
                            <div className="bg-slate-800 p-3 rounded-2xl min-w-[80px] border border-emerald-500/30">
                                <p className="text-[10px] opacity-50 uppercase text-emerald-400">DEK</p>
                                <p className="text-lg font-black text-emerald-400">+{data.dekEarned}</p>
                            </div>
                        </div>
                        
                        {data.drops && data.drops.length > 0 && (
                            <div className="bg-slate-800/50 p-3 rounded-2xl mb-4 border border-indigo-500/30">
                                <p className="text-[10px] opacity-50 uppercase mb-2">Item Obtained</p>
                                <div className="flex gap-2 justify-center flex-wrap">
                                    {data.drops.map((item, i) => (
                                        <div key={i} className="flex flex-col items-center">
                                            <div className="w-8 h-8 flex items-center justify-center">
                                                {SVGs[item.icon] ? React.createElement(SVGs[item.icon], { className: "w-6 h-6 drop-shadow" }) : <Icon name="Box" size={20}/>}
                                            </div>
                                            <span className="text-[9px] font-bold text-white">x{item.qty}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        <p className="text-[9px] opacity-30 uppercase mt-4">Avg: {formatMoney(avg)} z</p>
                    </div>
                </div>
            );
        }

        function ShareCardModal({ record, onClose, prices }) {
            const profitValue = record.profit || 0;
            const trashValue = parseInt(record.trashAmount || 0);
            
            // Calculate Total Cost based on recorded data
            let totalCost = 0;
            if (record.gumUsed > 0) totalCost += record.gumUsed * (prices.gumBoxPrice / 10);
            if (record.useSilvervine) totalCost += (prices.silvervineBoxPrice / 5);
            if (record.otherCosts) totalCost += record.otherCosts.reduce((sum, c) => sum + parseInt(c.amount || 0), 0);
            
            const realizedStoneIncome = profitValue + totalCost - trashValue;
            const minutes = record.minutesUsed || 60;

            const handleShare = async () => {
                const shareData = {
                    title: 'OGHza Tracker Summary',
                    text: `‚öîÔ∏è OGH Run Summary [${record.date}]\n\nüíé Stone Income: ${formatMoney(realizedStoneIncome)} z\nüóëÔ∏è Trash: ${formatMoney(trashValue)} z\nüìâ Cost: ${formatMoney(totalCost)} z\n\nüí∞ NET PROFIT: ${formatFullMoney(profitValue)} z`,
                };

                if (navigator.share) {
                    try {
                        await navigator.share(shareData);
                    } catch (err) {
                        console.log('Share failed:', err);
                    }
                } else {
                    copyToClipboard(shareData.text);
                    alert("Copied to clipboard!");
                }
            };

            return (
                <div className="fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center p-6 animate-fade-in">
                    <div className="relative w-full max-w-sm bg-gradient-to-br from-slate-900 to-indigo-950 border border-white/10 rounded-[2.5rem] p-8 shadow-2xl overflow-hidden flex flex-col items-center text-center">
                        
                        <div className="absolute top-[-20%] right-[-20%] w-60 h-60 bg-purple-500/20 rounded-full blur-3xl pointer-events-none"></div>
                        <div className="absolute bottom-[-10%] left-[-10%] w-40 h-40 bg-emerald-500/10 rounded-full blur-3xl pointer-events-none"></div>

                        <div className="z-10 w-full">
                            <h2 className="text-3xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-1">OGH RESULT</h2>
                            <p className="text-[10px] font-bold uppercase tracking-[0.3em] opacity-40 mb-6">{record.date}</p>

                            {/* Profit Big */}
                            <div className="mb-6">
                                <p className="text-[10px] opacity-40 uppercase font-bold tracking-widest mb-1">Net Profit</p>
                                <p className="text-5xl font-black text-emerald-400 tracking-tighter drop-shadow-[0_0_10px_rgba(52,211,153,0.5)]">{formatMoney(profitValue)}</p>
                                <p className="text-[10px] opacity-30 uppercase mt-1">Zeny</p>
                            </div>

                            {/* Stats Grid */}
                            <div className="grid grid-cols-2 gap-3 mb-6">
                                <div className="bg-white/5 p-3 rounded-2xl border border-white/5 flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <SVGs.Cost className="w-5 h-5 text-rose-400"/>
                                        <span className="text-[10px] opacity-50 uppercase font-bold">Cost</span>
                                    </div>
                                    <span className="text-sm font-black text-white">{formatMoney(totalCost)}</span>
                                </div>
                                <div className="bg-white/5 p-3 rounded-2xl border border-white/5 flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <SVGs.Clock className="w-5 h-5 text-blue-400"/>
                                        <span className="text-[10px] opacity-50 uppercase font-bold">Time</span>
                                    </div>
                                    <span className="text-sm font-black text-white">{minutes}m</span>
                                </div>
                            </div>

                            {/* Items Grid */}
                            <div className="flex justify-between items-center bg-black/20 p-4 rounded-3xl border border-white/5 mb-8">
                                <div className="flex flex-col items-center">
                                    <SVGs.Spell className="w-8 h-8 drop-shadow-md mb-1"/>
                                    <span className="text-xs font-black">{record.purpleStoneCount}</span>
                                </div>
                                <div className="w-px h-8 bg-white/10"></div>
                                <div className="flex flex-col items-center">
                                    <SVGs.Magic className="w-8 h-8 drop-shadow-md mb-1"/>
                                    <span className="text-xs font-black">{record.contMagicCount}</span>
                                </div>
                                <div className="w-px h-8 bg-white/10"></div>
                                <div className="flex flex-col items-center">
                                    <SVGs.Gum className="w-8 h-8 drop-shadow-md mb-1"/>
                                    <span className="text-xs font-black">{record.gumUsed}</span>
                                </div>
                            </div>

                            <div className="flex gap-3">
                                <button onClick={onClose} className="flex-1 py-4 bg-slate-800 rounded-2xl text-xs font-bold uppercase hover:bg-slate-700 transition-all">Close</button>
                                <button onClick={handleShare} className="flex-[2] py-4 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl text-xs font-black uppercase shadow-lg shadow-purple-500/30 hover:scale-105 transition-all flex items-center justify-center gap-2">
                                    <SVGs.Camera className="w-4 h-4"/> Capture & Share
                                </button>
                            </div>
                        </div>
                    </div>
                    <p className="text-white/30 text-[10px] mt-6 font-bold uppercase tracking-widest animate-pulse">Screenshot this card to share</p>
                </div>
            );
        }

        function Modal({ children, onClose }) {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/90 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="w-full max-w-sm bg-[#1e293b] rounded-3xl p-6 relative" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-6 right-6 text-slate-500 hover:text-white transition-colors">
                            <Icon name="X" size={20}/>
                        </button>
                        {children}
                    </div>
                </div>
            );
        }

        function ItemDetailModal({ item, onClose }) {
            const detail = ITEM_DETAILS[item.id] || { name: "Unknown", desc: "No data available.", type: "Etc", rarity: "Common" };
            const rarityColors = { Common: "text-slate-400 border-slate-500", Uncommon: "text-emerald-400 border-emerald-500", Rare: "text-indigo-400 border-indigo-500", Legendary: "text-amber-400 border-amber-500" };
            const rColor = rarityColors[detail.rarity] || rarityColors.Common;
            const rarityBgs = { Common: "bg-slate-500/10", Uncommon: "bg-emerald-500/10", Rare: "bg-indigo-500/10", Legendary: "bg-amber-500/10" };

            return (
                <Modal onClose={onClose}>
                    <div className="text-center">
                        <div className={`w-20 h-20 mx-auto rounded-3xl flex items-center justify-center mb-4 ${rarityBgs[detail.rarity]} border-2 border-white/5 shadow-2xl`}>
                            {React.cloneElement(item.iconComp, { className: "w-12 h-12" })}
                        </div>
                        <h3 className={`text-lg font-black uppercase italic ${rColor.split(' ')[0]}`}>{detail.name}</h3>
                        <p className="text-[10px] font-bold opacity-40 uppercase tracking-widest mb-4">{detail.type} ‚Ä¢ {detail.rarity}</p>
                        <div className="bg-black/20 p-4 rounded-2xl text-left border border-white/5">
                            <p className="text-xs text-slate-300 leading-relaxed italic">"{detail.desc}"</p>
                        </div>
                        <div className="mt-6 flex justify-between items-center px-2">
                             <span className="text-xs font-bold opacity-40">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ</span>
                             <span className="text-lg font-black">{item.count}</span>
                        </div>
                    </div>
                </Modal>
            );
        }

        function AiAnalysisModal({ onClose, analysisResult }) {
            return (
                <Modal onClose={onClose}>
                    <div className="text-center">
                        <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-yellow-500 shadow-xl overflow-hidden relative">
                             <div className="absolute inset-0 bg-yellow-500/10"></div>
                             <SVGs.Hugin className="w-16 h-16"/>
                        </div>
                        <h3 className="text-xl font-black text-amber-400 mb-2">Hugin's Report</h3>
                        <div className="bg-slate-800/50 p-4 rounded-2xl text-left border border-slate-700 max-h-60 overflow-y-auto">
                             <p className="text-sm leading-relaxed opacity-90 text-slate-200 whitespace-pre-wrap font-medium">{analysisResult}</p>
                        </div>
                    </div>
                </Modal>
            );
        }

        function NumberStepper({ value, onChange, label, step = 1, disabled = false }) {
            return (
                <div className={`flex items-center justify-between p-1.5 rounded-2xl transition-colors ${disabled ? 'bg-slate-800/20 opacity-30 cursor-not-allowed' : 'bg-slate-800'}`}>
                    <button type="button" disabled={disabled} onClick={() => onChange(Math.max(0, parseInt(value || 0) - step))} className="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center hover:bg-rose-500/20">
                        <span className="text-lg font-black">-</span>
                    </button>
                    <div className="text-center flex-1">
                        <input 
                            type="text" 
                            inputMode="numeric" 
                            disabled={disabled} 
                            value={value} 
                            onFocus={(e) => e.target.value === '0' && onChange('')} 
                            onBlur={(e) => e.target.value === '' && onChange(0)}
                            onChange={e => {
                                const val = e.target.value.replace(/[^0-9]/g, '');
                                onChange(val === '' ? '' : parseInt(val));
                            }} 
                            className="w-full bg-transparent text-center text-lg font-black outline-none" 
                        />
                        {label && <p className="text-[8px] opacity-40 font-bold uppercase tracking-widest leading-none">{label}</p>}
                    </div>
                    <button type="button" disabled={disabled} onClick={() => onChange(parseInt(value || 0) + step)} className="w-8 h-8 rounded-xl bg-slate-700 flex items-center justify-center hover:bg-emerald-500/20">
                        <span className="text-lg font-black">+</span>
                    </button>
                </div>
            );
        }

        // --- Core Gemini API ---
        const callGemini = async (prompt, specificKey = null) => {
            const savedKey = localStorage.getItem('ogh_gemini_key');
            const apiKey = specificKey || savedKey || ""; 
            const model = "gemini-2.5-flash-preview-09-2025";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: "You are Hugin, the researcher NPC from RO. Use Thai." }] } };
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Hugin ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∏‡πà‡∏á...";
                } catch (e) { await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000)); }
            }
            return "Server Busy!";
        };

        // --- Application Views ---
        function HomeView({ records, stats, goToTab }) {
            const totalProfit = records.reduce((acc, r) => acc + (r.profit || 0), 0);
            
            // Safe access to Recharts
            if (!window.Recharts) return <div className="p-6 text-center opacity-40">Loading Charts...</div>;
            const { ResponsiveContainer, AreaChart, Area } = window.Recharts;
            const chartData = [...records].reverse().slice(-7).map((r, i) => ({ name: `Run ${i+1}`, profit: r.profit }));

            return (
                <div className="p-6 animate-fade-in view-content">
                    <header className="flex justify-between items-center mb-6">
                        <div onClick={() => goToTab('profile')} className="flex items-center gap-3 bg-white/5 p-2 rounded-full pr-4 cursor-pointer hover:bg-white/10">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-black bg-slate-600`}>{stats.jobClass.substring(0, 1)}</div>
                            <div><p className="text-[10px] font-bold opacity-50 uppercase tracking-tighter">LV.{stats.baseLv}</p><p className="text-xs font-black">{stats.jobClass}</p></div>
                        </div>
                        <div className="text-right"><p className="text-[10px] opacity-50 font-bold uppercase">Total Profit</p><p className="text-2xl font-black text-emerald-400">{formatMoney(totalProfit)}</p></div>
                    </header>
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="glass-panel p-4 rounded-3xl"><Icon name="TrendingUp" className="text-blue-400 mb-2"/><p className="text-2xl font-black">{records.length}</p><p className="text-[10px] opacity-40 font-bold uppercase">Runs</p></div>
                        <div className="glass-panel p-4 rounded-3xl"><Icon name="History" className="text-amber-400 mb-2"/><p className="text-lg font-black truncate">{records[0]?.date || '-'}</p><p className="text-[10px] opacity-40 font-bold uppercase">Latest</p></div>
                    </div>
                    {window.Recharts && (
                        <div className="glass-panel p-4 rounded-3xl h-48 mb-4">
                            <p className="text-[10px] font-bold opacity-40 mb-2 uppercase">Profit Trend</p>
                            <ResponsiveContainer width="100%" height="90%">
                                <AreaChart data={chartData}><Area type="monotone" dataKey="profit" stroke="#a855f7" fill="#a855f7" fillOpacity={0.2} strokeWidth={3} /></AreaChart>
                            </ResponsiveContainer>
                        </div>
                    )}
                    <div className="space-y-3">
                        <h4 className="text-[10px] font-bold opacity-40 px-2 uppercase tracking-widest">Recent Activity</h4>
                        {records.slice(0, 3).map(r => (
                            <div key={r.id} className="glass-panel p-4 rounded-2xl flex justify-between items-center animate-slide-up">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center font-black ${r.isSaleRecord ? 'bg-emerald-500' : 'bg-purple-600'}`}>{r.isSaleRecord ? '$' : 'D'}</div>
                                    <div><p className="font-bold text-sm">{r.date}</p><p className="text-[10px] opacity-40 uppercase tracking-tighter">{r.isSaleRecord ? 'Market Sale' : 'Dungeon Run'}</p></div>
                                </div>
                                <p className="font-black text-emerald-400">{formatMoney(r.profit)}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function AddDataView({ db, uid, prices, stats, onSuccess, isSaving, setGlobalIsSaving, records }) {
            const [form, setForm] = useState({ date: new Date().toISOString().split('T')[0], runMode: 'ogh', trashAmount: '', gumUsed: 1, useSilvervine: true, purpleStoneCount: 0, contMagicCount: 0, isSellingSpell: false, isSellingMagic: false, customSpellPrice: '', customMagicPrice: '', otherCosts: [], notes: '', minutesUsed: 60 });

            // Calculate Average Profit from History
            const averageProfit = useMemo(() => {
                if (!records || records.length === 0) return 0;
                const total = records.filter(r => !r.isSaleRecord).reduce((acc, r) => acc + (r.profit || 0), 0);
                const count = records.filter(r => !r.isSaleRecord).length;
                return count > 0 ? total / count : 0;
            }, [records]);

            const calculateCurrentProfit = () => {
                const trash = parseInt(form.trashAmount) || 0;
                const spellPrice = form.isSellingSpell ? (parseInt(form.customSpellPrice) || prices.purpleStonePrice) : 0;
                const magicPrice = form.isSellingMagic ? (parseInt(form.customMagicPrice) || prices.contMagicPrice) : 0;
                const spells = (parseInt(form.purpleStoneCount) || 0) * spellPrice;
                const magics = (parseInt(form.contMagicCount) || 0) * magicPrice;
                const gumCost = (parseInt(form.gumUsed) || 0) * (prices.gumBoxPrice / 10);
                const svCost = form.useSilvervine ? (prices.silvervineBoxPrice / 5) : 0;
                const otherCostTotal = form.otherCosts.reduce((acc, c) => acc + (parseInt(c.amount) || 0), 0);
                return (trash + spells + magics) - (gumCost + svCost + otherCostTotal);
            };

            const handleSubmit = async (e) => {
                if(e) e.preventDefault();
                if (!form.trashAmount) return;
                setGlobalIsSaving(true);
                const profit = calculateCurrentProfit();
                const drops = simulateDrops();
                const newVirtualInventory = { ...(stats.virtual_inventory || {}) };
                drops.forEach(d => newVirtualInventory[d.id] = (newVirtualInventory[d.id] || 0) + d.qty);
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
                    await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'records'), { ...form, profit, timestamp: Date.now() });
                    const newBaseExp = stats.baseExp + 50; 
                    await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'gamification', 'stats'), { ...stats, baseExp: newBaseExp, coins: stats.coins + 1, virtual_inventory: newVirtualInventory });
                    
                    // Pass average profit to onSuccess
                    onSuccess({ profit, dekEarned: Math.floor(profit/1000), drops, average: averageProfit });
                    
                    setForm({ ...form, trashAmount: '', purpleStoneCount: 0, contMagicCount: 0, notes: '', otherCosts: [] }); 
                } catch (err) { console.error(err); } finally { setGlobalIsSaving(false); }
            };

            const addCost = () => setForm(p => ({...p, otherCosts: [...p.otherCosts, {id: Date.now(), name: '', amount: ''}]}));
            const updateCost = (id, field, val) => {
                if (field === 'amount') val = val.replace(/[^0-9]/g, '');
                setForm(p => ({...p, otherCosts: p.otherCosts.map(c => c.id === id ? {...c, [field]: val} : c)}));
            };
            const removeCost = (id) => setForm(p => ({...p, otherCosts: p.otherCosts.filter(c => c.id !== id)}));

            return (
                <div className="p-6 animate-fade-in view-content space-y-6">
                    <h2 className="text-2xl font-black italic mb-6 tracking-tighter">New Run</h2>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="flex bg-slate-800 p-1 rounded-2xl shadow-inner">
                            <button type="button" onClick={() => setForm({...form, runMode: 'ogh'})} className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase transition-all ${form.runMode === 'ogh' ? 'bg-purple-600 shadow-lg' : 'opacity-40'}`}>OGH (Normal)</button>
                            <button type="button" onClick={() => setForm({...form, runMode: 'aogh'})} className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase transition-all ${form.runMode === 'aogh' ? 'bg-rose-600 shadow-lg' : 'opacity-40'}`}>AOGH (Hard)</button>
                        </div>
                        <div className="bg-slate-900 p-8 rounded-[2.5rem] border border-white/5 text-center shadow-xl">
                            <p className="text-[10px] font-bold opacity-30 uppercase tracking-widest mb-2">Trash Sale (Zeny)</p>
                            <input type="text" inputMode="numeric" placeholder="0" value={form.trashAmount} onChange={e => handleNumberInput(e, 'trashAmount', setForm)} className="w-full bg-transparent text-center text-5xl font-black outline-none placeholder-white/5" />
                        </div>
                        
                        {/* Time, Gum & Silvervine Container */}
                        <div className="glass-panel p-6 rounded-[2rem] space-y-4">
                            {/* Row 1: Time */}
                            <div className="flex justify-between items-center p-2">
                                 <div className="flex items-center gap-2">
                                    <SVGs.Clock className="w-5 h-5 text-indigo-400"/>
                                    <span className="text-xs font-bold opacity-50 uppercase tracking-widest">Time Used</span>
                                 </div>
                                 <div className="w-32">
                                     <NumberStepper value={form.minutesUsed} onChange={v => setForm({...form, minutesUsed: v})} step={5} />
                                 </div>
                            </div>

                            {/* Separator */}
                            <div className="h-px bg-white/5 w-full"></div>

                            {/* Row 2: Gum & Silvervine */}
                            <div className="grid grid-cols-2 gap-4">
                                {/* Gum */}
                                <div className="flex flex-col gap-2">
                                    <span className="text-[10px] font-bold opacity-50 uppercase tracking-widest flex items-center gap-2">
                                        <SVGs.Gum className="w-4 h-4"/> Gum
                                    </span>
                                    <div className="flex gap-1">
                                        {[0, 1, 2].map(n => (
                                            <button key={n} type="button" onClick={() => setForm({...form, gumUsed: n})} 
                                            className={`flex-1 py-2 rounded-xl font-bold text-xs transition-all ${form.gumUsed === n ? 'bg-blue-600 shadow-lg shadow-blue-500/30' : 'bg-slate-800 hover:bg-slate-700'}`}>
                                            {n}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Silvervine */}
                                <div className="flex flex-col gap-2 items-end">
                                    <span className="text-[10px] font-bold opacity-50 uppercase tracking-widest flex items-center gap-2">
                                        <SVGs.Silvervine className="w-4 h-4"/> Silvervine
                                    </span>
                                    <button type="button" onClick={() => setForm({...form, useSilvervine: !form.useSilvervine})} className="text-blue-400 scale-110">
                                        <Icon name={form.useSilvervine ? "ToggleOn" : "ToggleOff"} size={32}/>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-slate-800/50 p-4 rounded-3xl flex flex-col justify-between">
                                <div className="flex justify-between items-center mb-2"><SVGs.Spell className="w-6 h-6"/><button type="button" onClick={() => setForm(p => ({...p, isSellingSpell: !p.isSellingSpell}))} className={`px-2 py-1 rounded text-[8px] font-bold uppercase ${form.isSellingSpell ? 'bg-emerald-500' : 'bg-slate-700 opacity-40'}`}>{form.isSellingSpell ? 'Sell' : 'Keep'}</button></div>
                                <NumberStepper value={form.purpleStoneCount} onChange={v => setForm({...form, purpleStoneCount: v})} />
                                <input type="text" placeholder={prices.purpleStonePrice} value={form.customSpellPrice} onChange={e => handleNumberInput(e, 'customSpellPrice', setForm)} disabled={!form.isSellingSpell} className="mt-2 bg-slate-900 rounded-lg p-2 text-[10px] text-center w-full outline-none" />
                            </div>
                            <div className={`bg-slate-800/50 p-4 rounded-3xl flex flex-col justify-between ${form.runMode === 'ogh' ? 'opacity-30' : ''}`}>
                                <div className="flex justify-between items-center mb-2"><SVGs.Magic className="w-6 h-6"/><button type="button" onClick={() => setForm(p => ({...p, isSellingMagic: !p.isSellingMagic}))} className={`px-2 py-1 rounded text-[8px] font-bold uppercase ${form.isSellingMagic ? 'bg-emerald-500' : 'bg-slate-700 opacity-40'}`}>{form.isSellingMagic ? 'Sell' : 'Keep'}</button></div>
                                <NumberStepper value={form.contMagicCount} onChange={v => setForm({...form, contMagicCount: v})} disabled={form.runMode === 'ogh'} />
                                <input type="text" placeholder={prices.contMagicPrice} value={form.customMagicPrice} onChange={e => handleNumberInput(e, 'customMagicPrice', setForm)} disabled={!form.isSellingMagic} className="mt-2 bg-slate-900 rounded-lg p-2 text-[10px] text-center w-full outline-none" />
                            </div>
                        </div>

                        <div>
                            <div className="flex justify-between items-center mb-2"><span className="text-[10px] font-bold opacity-50 uppercase tracking-widest">Etc. Costs</span><button type="button" onClick={addCost} className="text-[10px] text-blue-400 font-black uppercase tracking-tighter">+ Add Cost</button></div>
                            {form.otherCosts.map(c => (
                                <div key={c.id} className="flex gap-2 mb-2 animate-fade-in">
                                    <input type="text" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" value={c.name} onChange={e => updateCost(c.id, 'name', e.target.value)} className="flex-1 bg-slate-800 rounded-xl px-4 py-2 text-xs outline-none" />
                                    <input type="text" inputMode="numeric" placeholder="0" value={c.amount} onChange={e => updateCost(c.id, 'amount', e.target.value)} className="w-24 bg-slate-800 rounded-lg px-3 py-2 text-xs outline-none text-right" />
                                    <button type="button" onClick={() => removeCost(c.id)} className="text-rose-500"><Icon name="Trash" size={14}/></button>
                                </div>
                            ))}
                        </div>
                        <button type="submit" disabled={isSaving || !form.trashAmount} className="w-full py-5 bg-gradient-to-tr from-purple-600 to-indigo-600 rounded-[1.5rem] font-black text-lg shadow-xl shadow-purple-500/20 active:scale-95 transition-transform disabled:opacity-50">SAVE RECORD</button>
                    </form>
                </div>
            );
        }

        function InventoryView({ records, prices, db, uid, showToast, stats }) {
            const [detailModal, setDetailModal] = useState(null);
            const [sellModal, setSellModal] = useState(null);
            const [sellQty, setSellQty] = useState("");
            const [sellPrice, setSellPrice] = useState("");
            const longPressTimer = useRef(null);
            const isLongPressActive = useRef(false);
            const totalSpells = records.reduce((acc, r) => acc + (parseInt(r.purpleStoneCount) || 0), 0);
            const totalMagics = records.reduce((acc, r) => acc + (parseInt(r.contMagicCount) || 0), 0);
            const vInv = stats.virtual_inventory || {};

            const handleSell = async () => {
                if(!sellModal || !sellQty || !sellPrice) return;
                const qty = parseInt(sellQty);
                const price = parseInt(sellPrice);
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
                    await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'records'), { date: new Date().toISOString().split('T')[0], runMode: 'SALE', trashAmount: 0, purpleStoneCount: sellModal.item === 'spell' ? -qty : 0, contMagicCount: sellModal.item === 'magic' ? -qty : 0, profit: qty * price, isSaleRecord: true, timestamp: Date.now() });
                    showToast(`‡∏Ç‡∏≤‡∏¢ ${sellModal.item} x${qty} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    setSellModal(null); setSellQty(""); setSellPrice("");
                } catch(e) { console.error(e); }
            };

            const slots = Array.from({ length: 24 });
            const onSlotStart = (content) => { if (!content) return; isLongPressActive.current = false; longPressTimer.current = setTimeout(() => { isLongPressActive.current = true; setDetailModal(content); }, 500); };
            const onSlotEnd = (content) => { clearTimeout(longPressTimer.current); if (!isLongPressActive.current && content) { if (content.id === 'spell' || content.id === 'magic') { setSellModal({item: content.id, max: content.count}); setSellPrice(content.price); } else { setDetailModal(content); } } };

            return (
                <div className="p-6 animate-fade-in view-content h-full">
                    <h2 className="text-2xl font-black italic mb-6 tracking-tighter">Inventory</h2>
                    <div className="bg-[#1e293b] p-5 rounded-[2.5rem] shadow-2xl border border-slate-700/50">
                        <div className="grid grid-cols-4 gap-3">
                            {slots.map((_, index) => {
                                let content = null;
                                if (index === 0) content = { id: 'spell', iconComp: <SVGs.Spell/>, count: totalSpells, price: prices.purpleStonePrice };
                                else if (index === 1) content = { id: 'magic', iconComp: <SVGs.Magic/>, count: totalMagics, price: prices.contMagicPrice };
                                else {
                                    const vKeys = Object.keys(vInv);
                                    if (index - 2 < vKeys.length) {
                                        const itemId = vKeys[index - 2];
                                        const itemDef = DROP_TABLE.find(d => d.id === itemId);
                                        if (itemDef) content = { id: itemId, iconComp: React.createElement(SVGs[itemDef.icon] || Icon, { name: itemDef.icon }), count: vInv[itemId], isSim: true, rare: itemDef.rare };
                                    }
                                }
                                return (
                                     <div key={index} 
                                        onMouseDown={() => onSlotStart(content)} onMouseUp={() => onSlotEnd(content)} onMouseLeave={() => clearTimeout(longPressTimer.current)} onTouchStart={() => onSlotStart(content)} onTouchEnd={() => onSlotEnd(content)}
                                        className={`aspect-square rounded-2xl relative flex items-center justify-center transition-all ${content ? 'bg-slate-800 border border-slate-600 active:scale-95' : 'bg-slate-800/20 border-2 border-dashed border-slate-700/50'}`}>
                                        {content && <>
                                            {content.isSim && <span className="absolute top-0.5 right-1 text-[8px] font-black text-amber-400 opacity-70">SIM</span>}
                                            <div className="w-10 h-10 flex items-center justify-center">{React.cloneElement(content.iconComp, { className: "w-8 h-8" })}</div>
                                            <span className="absolute bottom-1 right-1.5 text-[10px] font-black text-white bg-black/60 px-1.5 rounded-md">{content.count}</span>
                                        </>}
                                     </div>
                                );
                            })}
                        </div>
                    </div>
                    {detailModal && <ItemDetailModal item={detailModal} onClose={() => setDetailModal(null)} />}
                    {sellModal && (
                        <Modal onClose={() => setSellModal(null)}>
                            <h3 className="text-xl font-black mb-4 uppercase">Sell {sellModal.item}</h3>
                            <div className="space-y-4">
                                <div><label className="text-[10px] opacity-50 uppercase">Quantity (Max: {sellModal.max})</label><input type="text" inputMode="numeric" value={sellQty} onChange={e => { let val = parseInt(e.target.value.replace(/\D/g, '')) || ''; if(val > sellModal.max) val = sellModal.max; setSellQty(val); }} className="w-full bg-slate-800 p-3 rounded-xl outline-none font-bold text-lg" autoFocus/></div>
                                <div><label className="text-[10px] opacity-50 uppercase">Price / Unit</label><input type="text" inputMode="numeric" value={sellPrice} onChange={e => handleNumberInput(e, '', setSellPrice)} className="w-full bg-slate-800 p-3 rounded-xl outline-none font-bold text-lg"/></div>
                                <div className="flex gap-2 pt-2"><button onClick={() => setSellModal(null)} className="flex-1 py-3 bg-slate-800 rounded-xl font-bold text-xs">Cancel</button><button onClick={handleSell} className="flex-1 py-3 bg-emerald-600 rounded-xl font-bold text-xs">Confirm Sale</button></div>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        }

        function HistoryView({ records, db, uid, showToast, prices }) {
            const [expandedId, setExpandedId] = useState(null);
            const [shareModalData, setShareModalData] = useState(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';

            return (
                <div className="p-6 animate-fade-in view-content space-y-4">
                    <h2 className="text-2xl font-black italic mb-6 tracking-tighter">History Logs</h2>
                    <div className="space-y-3">
                        {records.map(r => {
                            const isExpanded = expandedId === r.id;
                            const profitValue = r.profit || 0;
                            
                            let totalCost = (r.gumUsed || 0) * (prices.gumBoxPrice/10);
                            if (r.useSilvervine) totalCost += (prices.silvervineBoxPrice/5);
                            if (r.otherCosts) totalCost += r.otherCosts.reduce((a,c)=>a+parseInt(c.amount||0),0);
                            
                            const realizedStoneIncome = profitValue + totalCost - (r.trashAmount || 0);

                            return (
                                <div key={r.id} className={`glass-panel rounded-[1.5rem] overflow-hidden transition-all duration-300 ${isExpanded ? 'bg-slate-800/80 ring-2 ring-purple-500/50' : ''}`}>
                                    <div 
                                        onClick={() => setExpandedId(isExpanded ? null : r.id)}
                                        className="p-4 flex justify-between items-center cursor-pointer hover:bg-white/5 active:bg-white/10"
                                    >
                                        <div className="flex gap-3">
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center font-black ${r.isSaleRecord ? 'bg-emerald-500 shadow-emerald-500/20' : 'bg-purple-600 shadow-purple-500/20'} shadow-lg`}>
                                                {r.isSaleRecord ? '$' : 'D'}
                                            </div>
                                            <div>
                                                <p className="font-bold text-sm tracking-tight">{r.date}</p>
                                                <p className="text-[10px] opacity-40 uppercase font-bold tracking-widest">{r.isSaleRecord ? 'Market Sale' : `Run [${r.runMode?.toUpperCase()}]`}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <div className="text-right">
                                                <p className="text-emerald-400 font-black text-sm tracking-tight">{formatMoney(profitValue)}</p>
                                                <p className="text-[8px] opacity-20 uppercase font-bold tracking-[0.2em]">Breakdown</p>
                                            </div>
                                            <Icon name={isExpanded ? "ChevronUp" : "ChevronDown"} size={14} className="opacity-20" />
                                        </div>
                                    </div>

                                    {isExpanded && (
                                        <div className="px-4 pb-4 animate-slide-up bg-black/10">
                                            <div className="pt-4 space-y-3 border-t border-white/5">
                                                <div className="grid grid-cols-2 gap-2 text-[11px]">
                                                    <div className="bg-white/5 p-2 rounded-xl text-center"><p className="opacity-40 uppercase text-[9px] mb-0.5">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏´‡∏¥‡∏ô</p><p className="font-bold text-white">{formatFullMoney(realizedStoneIncome)} z</p></div>
                                                    <div className="bg-white/5 p-2 rounded-xl text-center"><p className="opacity-40 uppercase text-[9px] mb-0.5">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</p><p className="font-bold text-rose-400">-{formatFullMoney(totalCost)} z</p></div>
                                                </div>
                                                <div className="bg-white/5 p-3 rounded-2xl flex flex-wrap gap-4 items-center justify-around border border-white/5">
                                                    <div className="text-center flex flex-col items-center">
                                                        <SVGs.Spell className="w-6 h-6 mb-1 drop-shadow"/>
                                                        <p className="font-black text-purple-400">{r.purpleStoneCount || 0}</p>
                                                    </div>
                                                    <div className="text-center flex flex-col items-center">
                                                        <SVGs.Magic className="w-6 h-6 mb-1 drop-shadow"/>
                                                        <p className="font-black text-rose-400">{r.contMagicCount || 0}</p>
                                                    </div>
                                                    <div className="text-center flex flex-col items-center">
                                                        <SVGs.Gum className="w-6 h-6 mb-1 drop-shadow"/>
                                                        <p className="font-black text-blue-400">{r.gumUsed || 0}</p>
                                                    </div>
                                                </div>
                                                {r.notes && <div className="bg-black/20 p-3 rounded-xl border border-white/5"><p className="text-[9px] opacity-30 font-bold uppercase mb-1 tracking-widest">Memo</p><p className="text-xs opacity-70 italic text-slate-300">"{r.notes}"</p></div>}
                                                <div className="flex gap-2 pt-2">
                                                    <button onClick={() => setShareModalData(r)} className="flex-1 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 transition-colors rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-purple-500/20 flex items-center justify-center gap-2"><Icon name="Share" size={14}/> Share Card</button>
                                                    <button onClick={async (e) => { 
                                                        e.stopPropagation(); // Fixed: Stop event propagation
                                                        if(confirm("‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?")) {
                                                            await deleteDoc(doc(dbRef.current, 'artifacts', appId, 'users', uid, 'records', r.id));
                                                            showToast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                                                        }
                                                    }} className="py-2.5 px-4 border border-rose-500/20 text-rose-400 rounded-xl text-[10px] font-black uppercase hover:bg-rose-500/10">Del</button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    {shareModalData && <ShareCardModal record={shareModalData} prices={prices} onClose={() => setShareModalData(null)} />}
                </div>
            );
        }

        function SettingsView({ uid, defaultUid, prices, setPrices, db, onResetUid, onRestoreUid, showToast, showAiFab, setShowAiFab }) {
            const [localPrices, setLocalPrices] = useState(prices);
            const [isSaving, setIsSaving] = useState(false);
            const [restoreInput, setRestoreInput] = useState("");
            const [apiKeyInput, setApiKeyInput] = useState(localStorage.getItem('ogh_gemini_key') || "");
            const [isRestoring, setIsRestoring] = useState(false);
            const [showChangelog, setShowChangelog] = useState(false);
            const [isDeleting, setIsDeleting] = useState(false); 

            const savePrices = async () => {
                setIsSaving(true);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
                await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'config', 'prices'), localPrices);
                setPrices(localPrices);
                setIsSaving(false);
                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            };

            const handleSaveApiKey = async () => {
                if (!apiKeyInput) return;
                const check = await callGemini("Say Hello", apiKeyInput);
                if (check.startsWith("API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á") || check.startsWith("Error")) {
                    alert("API Key ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á: " + check);
                    return;
                }
                localStorage.setItem('ogh_gemini_key', apiKeyInput);
                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Key ‡πÅ‡∏•‡πâ‡∏ß");
            };

            const handleRestore = async () => {
                if (!restoreInput.trim() || restoreInput.length < 5) return alert("UID ‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ");
                setIsRestoring(true);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
                try {
                    const statsRef = doc(db, 'artifacts', appId, 'users', restoreInput, 'gamification', 'stats');
                    const statsSnap = await getDoc(statsRef);
                    if (!statsSnap.exists()) alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö UID ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
                    else {
                        const userData = statsSnap.data();
                        if(confirm(`‚úÖ ‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!\nClass: ${userData.jobClass || 'Novice'}\nCoins: ${userData.coins || 0}\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                            onRestoreUid(restoreInput);
                            setRestoreInput("");
                        }
                    }
                } catch (e) { alert("Error: " + e.message); } finally { setIsRestoring(false); }
            };

            const handleDeleteAll = async () => {
                if (!confirm("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
                const confirm2 = prompt("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ 'DELETE' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô");
                if (confirm2 !== 'DELETE') return;
                
                setIsDeleting(true); 
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';
                try {
                    const q = query(collection(db, 'artifacts', appId, 'users', uid, 'records'));
                    const snap = await getDocs(q);
                    await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
                    await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'gamification', 'stats'), INITIAL_STATS);
                    showToast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                    window.location.reload();
                } catch(e) { alert("Error: " + e.message); }
                finally { setIsDeleting(false); } 
            };

            const configLabels = {
                purpleStonePrice: "Coagulated Spell",
                contMagicPrice: "Contaminated Magic",
                gumBoxPrice: "Bubble Gum Box",
                silvervineBoxPrice: "Silvervine Box"
            };

            const configItems = [
                { id: 'purpleStonePrice', icon: <SVGs.Spell className="w-5 h-5"/> },
                { id: 'contMagicPrice', icon: <SVGs.Magic className="w-5 h-5"/> },
                { id: 'gumBoxPrice', icon: <SVGs.GumBox className="w-5 h-5"/> },
                { id: 'silvervineBoxPrice', icon: <SVGs.SilvervineBox className="w-5 h-5"/> }
            ];

            return (
                <div className="p-6 animate-fade-in view-content space-y-8">
                    <h2 className="text-2xl font-black italic tracking-tighter">Settings</h2>
                    <div className="glass-panel p-6 rounded-[2rem] space-y-4">
                        <span className="text-[10px] font-black uppercase opacity-50 tracking-[0.2em]">UID Management</span>
                        <div className="bg-black/30 p-3 rounded-2xl flex items-center justify-between gap-2 overflow-hidden border border-white/5">
                            <div className="flex-1 min-w-0">
                                <p className="text-[9px] opacity-40 uppercase font-black tracking-widest">Your Private UID</p>
                                <code className="text-xs font-mono opacity-80 truncate block">{uid}</code>
                            </div>
                            <button onClick={() => { copyToClipboard(uid); showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å UID ‡πÅ‡∏•‡πâ‡∏ß"); }} className="p-2 bg-white/5 rounded-xl active:scale-95"><Icon name="Copy" size={14}/></button>
                        </div>
                        <div className="text-right">
                            <button onClick={onResetUid} className="text-[10px] text-slate-400 hover:text-white underline">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà UID ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
                        </div>
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                value={restoreInput} 
                                onChange={e => setRestoreInput(e.target.value)} 
                                placeholder="Restore UID..." 
                                className="flex-1 bg-slate-800 rounded-xl px-4 text-xs outline-none focus:ring-1 focus:ring-blue-500/50 transition-all" 
                            />
                            <button 
                                onClick={handleRestore} 
                                disabled={isRestoring || !restoreInput}
                                className={`px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 ${
                                    isRestoring || !restoreInput 
                                    ? 'bg-slate-700 text-slate-500 cursor-not-allowed' 
                                    : 'bg-blue-600 text-white shadow-lg shadow-blue-500/30 active:scale-95 hover:bg-blue-500'
                                }`}
                            >
                                {isRestoring ? <Icon name="Loader" className="animate-spin" size={16}/> : <><Icon name="Refresh" size={16}/> Restore</>}
                            </button>
                        </div>
                    </div>
                    
                    <div className="glass-panel p-6 rounded-[2rem] space-y-4">
                        <div className="flex justify-between items-center"><span className="text-[10px] font-black uppercase opacity-50 tracking-widest">Hugin Service (AI)</span><button onClick={() => setShowAiFab(!showAiFab)} className="text-indigo-400">{showAiFab ? <Icon name="ToggleOn" size={28}/> : <Icon name="ToggleOff" size={28}/>}</button></div>
                        <div className="flex gap-2">
                            <input type="password" value={apiKeyInput} onChange={e => setApiKeyInput(e.target.value)} placeholder="Paste Key..." className="flex-1 bg-slate-800 rounded-xl px-4 text-xs outline-none h-10 border border-white/5" />
                            <button onClick={() => { localStorage.setItem('ogh_gemini_key', apiKeyInput); showToast("Saved API Key"); }} className="px-4 rounded-xl bg-slate-700 text-[10px] font-black uppercase active:scale-95">Save</button>
                        </div>
                    </div>

                    <div className="space-y-4">
                        <h3 className="text-[10px] font-black opacity-40 px-2 uppercase tracking-[0.2em]">Market Prices</h3>
                        <div className="grid grid-cols-2 gap-4">
                            {configItems.map(item => (
                                <div key={item.id} className="glass-panel p-4 rounded-2xl border border-white/5">
                                    <p className="text-[9px] font-bold opacity-50 uppercase mb-2 truncate tracking-widest flex items-center gap-2">
                                        {item.icon} {configLabels[item.id]}
                                    </p>
                                    <input 
                                        type="text" 
                                        inputMode="numeric" 
                                        value={localPrices[item.id]} 
                                        onChange={e => setLocalPrices({...localPrices, [item.id]: parseInt(e.target.value.replace(/\D/g,'')) || 0})} 
                                        className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-xl font-black outline-none focus:border-indigo-500/50 transition-colors text-center" 
                                    />
                                </div>
                            ))}
                        </div>
                        <button onClick={savePrices} disabled={isSaving} className="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-2xl font-black text-lg active:scale-95 transition-all shadow-xl shadow-emerald-500/20">{isSaving ? "SAVING..." : "SAVE PRICES"}</button>
                    </div>

                    <div className="pt-8 border-t border-white/5">
                        <button onClick={handleDeleteAll} disabled={isDeleting} className="w-full py-4 border border-rose-500/30 text-rose-400 rounded-2xl font-bold text-xs uppercase hover:bg-rose-500/10 flex justify-center gap-2">
                            {isDeleting ? <Icon name="Loader" className="animate-spin" size={16}/> : <><Icon name="Trash" size={16}/> DELETE ALL DATA</>}
                        </button>
                    </div>

                    <div className="text-center pt-8 border-t border-white/5">
                        <button onClick={() => setShowChangelog(true)} className="opacity-20 hover:opacity-100 text-[10px] font-bold uppercase tracking-[0.3em] transition-opacity">{APP_VERSION}</button>
                    </div>

                    {showChangelog && (
                        <Modal onClose={() => setShowChangelog(false)}>
                            <div className="space-y-4 max-h-[60vh] overflow-y-auto">
                                <h3 className="text-xl font-black italic">Changelog</h3>
                                {CHANGELOGS.map((log, idx) => (
                                    <div key={idx} className="bg-slate-800/50 p-4 rounded-2xl border border-white/5"><div className="flex justify-between items-end mb-1"><span className="text-lg font-black text-white">{log.ver}</span><span className="text-[9px] opacity-40 uppercase font-bold">{log.date}</span></div><p className="text-xs opacity-70 leading-relaxed">{log.desc}</p></div>
                                ))}
                            </div>
                        </Modal>
                    )}
                </div>
            );
        }

        function App() {
            const [authUser, setAuthUser] = useState(null);
            const [targetUid, setTargetUid] = useState(null);
            const [activeTab, setActiveTab] = useState('home');
            const [records, setRecords] = useState([]);
            const [prices, setPrices] = useState({ purpleStonePrice: 150000, contMagicPrice: 450000, gumBoxPrice: 1500000, silvervineBoxPrice: 2500000 });
            const [stats, setStats] = useState(INITIAL_STATS);
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [rewardData, setRewardData] = useState(null);
            const [showAiFab, setShowAiFab] = useState(false);
            const [aiResult, setAiResult] = useState(null);
            const [isAnalysing, setIsAnalysing] = useState(false);

            const dbRef = useRef(null);
            const authRef = useRef(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'oghza-tracker';

            const showToast = (message) => setToast(message);
            const handleRestoreUid = (newUid) => { localStorage.setItem('ogh_target_uid', newUid); setTargetUid(newUid); showToast("Restored UID: " + newUid); };
            const handleResetUid = () => { localStorage.removeItem('ogh_target_uid'); if (authUser) setTargetUid(authUser.uid); showToast("Reset to Default"); };

            useEffect(() => {
                const initFirebase = async () => {
                    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MANUAL_FIREBASE_CONFIG;
                    const app = initializeApp(firebaseConfig);
                    authRef.current = getAuth(app);
                    dbRef.current = getFirestore(app);
                    await signInAnonymously(authRef.current);
                    onAuthStateChanged(authRef.current, (u) => {
                        setAuthUser(u);
                        setTargetUid(localStorage.getItem('ogh_target_uid') || u?.uid);
                        setLoading(false);
                    });
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!dbRef.current || !targetUid) return;
                const unsubRecords = onSnapshot(query(collection(dbRef.current, 'artifacts', appId, 'users', targetUid, 'records'), orderBy('timestamp', 'desc')), (snap) => setRecords(snap.docs.map(d => ({ ...d.data(), id: d.id }))), (err) => console.log(err));
                const unsubPrices = onSnapshot(doc(dbRef.current, 'artifacts', appId, 'users', targetUid, 'config', 'prices'), d => { if (d.exists()) setPrices(d.data()); }, (err) => console.log(err));
                const unsubStats = onSnapshot(doc(dbRef.current, 'artifacts', appId, 'users', targetUid, 'gamification', 'stats'), d => { if (d.exists()) setStats(d.data()); else setStats(INITIAL_STATS); }, (err) => console.log(err));
                return () => { unsubRecords(); unsubPrices(); unsubStats(); };
            }, [targetUid]);

            const triggerAiAnalysis = async () => {
                if (records.length < 5) return showToast(`üîí ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ: ‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏£‡∏≠‡∏ö (‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å ${5 - records.length} ‡∏£‡∏≠‡∏ö)`);
                if (stats.coins < 1) return showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ: Coins ‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 1 Coin)");
                setIsAnalysing(true);
                try {
                    await setDoc(doc(dbRef.current, 'artifacts', appId, 'users', targetUid, 'gamification', 'stats'), { ...stats, coins: stats.coins - 1 });
                    const totalSpells = records.reduce((acc, r) => acc + (parseInt(r.purpleStoneCount) || 0), 0);
                    const totalMagics = records.reduce((acc, r) => acc + (parseInt(r.contMagicCount) || 0), 0);
                    const totalValue = (totalSpells * prices.purpleStonePrice) + (totalMagics * prices.contMagicPrice);
                    const prompt = `‡∏Ñ‡∏•‡∏±‡∏á: ‡∏´‡∏¥‡∏ô‡∏°‡πà‡∏ß‡∏á ${totalSpells}, ‡∏´‡∏¥‡∏ô‡πÅ‡∏î‡∏á ${totalMagics}, ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ ${totalValue}. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 5 ‡∏£‡∏≠‡∏ö: ${JSON.stringify(records.slice(0, 5).map(r => r.profit))}. ‡∏™‡∏ß‡∏°‡∏ö‡∏ó Hugin ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢ OGH ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢`;
                    const result = await callGemini(prompt);
                    setAiResult(result);
                } catch (e) { console.error(e); } finally { setIsAnalysing(false); }
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-[#0f172a]"><Icon name="Loader" className="animate-spin text-purple-500" size={40} /></div>;

            const renderContent = () => {
                switch(activeTab) {
                    case 'home': return <HomeView records={records} stats={stats} goToTab={setActiveTab} />;
                    case 'add': return <AddDataView db={dbRef.current} uid={targetUid} prices={prices} stats={stats} onSuccess={setRewardData} isSaving={isSaving} setGlobalIsSaving={setIsSaving} records={records} />;
                    case 'inventory': return <InventoryView records={records} prices={prices} db={dbRef.current} uid={targetUid} showToast={setToast} stats={stats}/>;
                    case 'settings': return <SettingsView uid={targetUid} defaultUid={authUser?.uid} prices={prices} setPrices={setPrices} db={dbRef.current} onResetUid={() => setTargetUid(authUser.uid)} onRestoreUid={setTargetUid} showToast={setToast} showAiFab={showAiFab} setShowAiFab={setShowAiFab} />;
                    case 'history': return <HistoryView records={records} db={dbRef.current} uid={targetUid} showToast={setToast} prices={prices} />;
                    case 'profile': return (
                        <div className="p-6 animate-fade-in view-content space-y-8">
                            <div className="text-center space-y-4">
                                <div className={`w-32 h-32 mx-auto rounded-[3rem] flex items-center justify-center text-4xl font-black shadow-2xl ${stats.isHighClass ? 'bg-amber-500' : 'bg-slate-700'}`}>{stats.jobClass.substring(0, 2).toUpperCase()}</div>
                                <h2 className="text-3xl font-black italic">{stats.jobClass}</h2>
                                <div className="bg-slate-800 p-2 rounded-2xl inline-block px-6 border border-white/5">
                                    <p className="text-[10px] font-bold opacity-40 uppercase tracking-widest leading-none mb-1">Base Experience</p>
                                    <p className="text-sm font-black">{stats.baseExp} / {getExpReq(stats.baseLv, 'base')}</p>
                                </div>
                                <p className="text-xs font-bold opacity-40 uppercase tracking-[0.2em]">Base Lv. {stats.baseLv}</p>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="glass-panel p-6 rounded-3xl text-center"><p className="text-2xl font-black text-amber-500">{stats.coins}</p><p className="text-[10px] font-bold opacity-40 uppercase">Coins</p></div>
                                <div className="glass-panel p-6 rounded-3xl text-center"><p className="text-xl font-black text-blue-400 truncate">{formatMoney(stats.zeny)}</p><p className="text-[10px] font-bold opacity-40 uppercase">DEKZA Coin</p></div>
                            </div>
                        </div>
                    );
                    default: return <HomeView records={records} stats={stats} goToTab={setActiveTab} />;
                }
            };

            return (
                <div className="max-w-md mx-auto relative min-h-screen">
                    {toast && <Toast message={toast} onClose={() => setToast(null)} />}
                    {rewardData && <RewardPopup data={rewardData} onClose={() => setRewardData(null)} />}
                    {aiResult && <AiAnalysisModal analysisResult={aiResult} onClose={() => setAiResult(null)} />}
                    
                    {showAiFab && (
                        <button onClick={triggerAiAnalysis} disabled={isAnalysing} className={`fixed bottom-24 right-6 w-16 h-16 rounded-full shadow-lg flex items-center justify-center animate-hugin active:scale-90 transition-transform z-50 border-2 border-white/20 ${isAiLocked ? 'bg-slate-700 grayscale' : 'bg-gradient-to-br from-amber-500 to-orange-600 shadow-orange-500/40'}`}>
                            {isAnalysing ? <Icon name="Loader" className="animate-spin text-white" size={28}/> : (isAiLocked ? <Icon name="Lock" className="text-white/50" size={24}/> : <SVGs.Hugin className="w-10 h-10"/>)}
                        </button>
                    )}

                    {renderContent()}

                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass-panel border-t border-white/5 nav-bar-padding pt-2 px-2 flex justify-between items-end z-40 rounded-t-[2rem]">
                        <button onClick={() => setActiveTab('home')} className={`flex-1 flex flex-col items-center gap-1 py-3 transition-all ${activeTab === 'home' ? 'text-purple-400' : 'opacity-40'}`}><Icon name="Home" size={24}/><span className="text-[9px] font-bold uppercase">Home</span></button>
                        <button onClick={() => setActiveTab('add')} className={`flex-1 flex flex-col items-center gap-1 py-3 transition-all ${activeTab === 'add' ? 'text-purple-400' : 'opacity-40'}`}><Icon name="Warp" size={24}/><span className="text-[9px] font-bold uppercase tracking-tighter">Dungeon</span></button>
                        <button onClick={() => setActiveTab('history')} className={`flex-1 flex flex-col items-center gap-1 py-3 transition-all ${activeTab === 'history' ? 'text-purple-400' : 'opacity-40'}`}><Icon name="History" size={24}/><span className="text-[9px] font-bold uppercase">History</span></button>
                        <button onClick={() => setActiveTab('inventory')} className={`flex-1 flex flex-col items-center gap-1 py-3 transition-all ${activeTab === 'inventory' ? 'text-purple-400' : 'opacity-40'}`}><Icon name="Box" size={24}/><span className="text-[9px] font-bold uppercase">Stock</span></button>
                        <button onClick={() => setActiveTab('settings')} className={`flex-1 flex flex-col items-center gap-1 py-3 transition-all ${activeTab === 'settings' ? 'text-purple-400' : 'opacity-40'}`}><Icon name="Settings" size={24}/><span className="text-[9px] font-bold uppercase">Setting</span></button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Kanit:wght@300;400;500;700;900&display=swap');
        
        html { font-size: clamp(14px, 0.85vw + 10px, 16px); touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', 'Kanit', sans-serif; margin: 0; padding: 0; background-color: #f8fafc; color: #1e293b; overflow-x: hidden; padding-bottom: 110px; }
        
        /* Dark Mode Override */
        body.dark { background-color: #0f172a; color: #f1f5f9; }

        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }

        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-in-out forwards; }
        
        @keyframes toastSlideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .animate-toast { animation: toastSlideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.3s ease-in-out; }

        @keyframes levelUp { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .animate-level-up { animation: levelUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* iOS Safe Area Fixes */
        .pb-safe {
            padding-bottom: 20px;
            padding-bottom: calc(env(safe-area-inset-bottom) + 20px);
        }
        
        .progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="dark"> <!-- Default Dark Mode -->
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment } = React;
        const { LineChart, Line, ResponsiveContainer, AreaChart, Area, XAxis, Tooltip } = window.Recharts || {};

        // --- VERSION CONTROL ---
        const APP_VERSION = "Ver.2.7.0";

        // --- GLOBAL VARIABLES ---
        let auth, db;

        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAbWzr8o_OhkjGbEetBYq_nzYmVZ2fTf40",
            authDomain: "rocogh-88a38.firebaseapp.com",
            projectId: "rocogh-88a38",
            storageBucket: "rocogh-88a38.firebasestorage.app",
            messagingSenderId: "1025971309206",
            appId: "1:1025971309206:web:d4f9e0ab6bb016dde590b7",
            measurementId: "G-04JN1ERQ4T"
        };
        
        const CLASS_TREE = {
            'Novice': { next: ['Swordman', 'Mage', 'Merchant', 'Thief', 'Acolyte', 'Archer'], maxJob: 10 },
            'Swordman': { next: ['Knight', 'Crusader'], maxJob: 50 },
            'Mage': { next: ['Wizard', 'Sage'], maxJob: 50 },
            'Merchant': { next: ['Blacksmith', 'Alchemist'], maxJob: 50 },
            'Thief': { next: ['Assassin', 'Rogue'], maxJob: 50 },
            'Acolyte': { next: ['Priest', 'Monk'], maxJob: 50 },
            'Archer': { next: ['Hunter', 'Bard'], maxJob: 50 },
            'Knight': { next: ['Lord Knight'], maxJob: 50 },
            'Wizard': { next: ['High Wizard'], maxJob: 50 },
            'Blacksmith': { next: ['Whitesmith'], maxJob: 50 },
            'Assassin': { next: ['Assassin Cross'], maxJob: 50 },
            'Priest': { next: ['High Priest'], maxJob: 50 },
            'Hunter': { next: ['Sniper'], maxJob: 50 },
            'High Novice': { next: ['High Swordman', 'High Mage', 'High Merchant', 'High Thief', 'High Acolyte', 'High Archer'], maxJob: 10 },
            'Lord Knight': { next: [], maxJob: 70 }, 
        };

        const INITIAL_STATS = {
            baseLv: 1, baseExp: 0,
            jobLv: 1, jobExp: 0,
            jobClass: 'Novice',
            coins: 0,
            zeny: 0,
            isHighClass: false
        };

        // --- GLOBAL HELPERS ---
        const getExpReq = (lv, type) => Math.floor(100 * Math.pow(lv, 1.2));
        const formatMoney = (n) => new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(n);
        const formatFullMoney = (n) => new Intl.NumberFormat('th-TH').format(n);
        
        // Get Device Date in YYYY-MM-DD format
        const getDeviceDate = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const handleNumberInput = (e, field, setFormData) => {
            const val = e.target.value;
            // Allow only digits
            if (val === '' || /^\d*$/.test(val)) {
                setFormData(p => ({ ...p, [field]: val }));
            }
        };

        const calculateProfit = (f, p) => {
            let rev = Number(f.trashAmount) || 0;
            const sp = f.isSellingSpell ? (Number(f.customSpellPrice) || p.purpleStonePrice) : 0;
            const mp = (f.runMode === 'aogh' && f.isSellingMagic) ? (Number(f.customMagicPrice) || p.contMagicPrice) : 0;
            rev += (f.purpleStoneCount * sp) + (f.contMagicCount * mp);
            const costGum = f.gumUsed * (p.gumBoxPrice / 10);
            const costSv = f.useSilvervine ? (2 * (p.silvervineBoxPrice / 10)) : 0;
            const costOther = f.otherCosts.reduce((a, c) => a + (Number(c.amount) || 0), 0);
            return rev - (costGum + costSv + costOther);
        };

        const callGemini = async (prompt) => {
            const userKey = localStorage.getItem('ogh_gemini_key');
            
            if (!userKey || userKey.trim() === "") {
                return "NO_API_KEY";
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                if (!response.ok) {
                    if (response.status === 400 || response.status === 403) return "INVALID_KEY";
                    throw new Error("API Error");
                }
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ";
            } catch (error) { 
                console.error("Gemini Error:", error);
                return "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"; 
            }
        };

        // --- ICONS ---
        const SVGs = {
            Spell: ({className}) => <svg viewBox="0 0 32 32" className={className}><path d="M16 4 L24 12 L24 22 L16 28 L8 22 L8 12 Z" fill="#7E57C2" /><path d="M16 6 L22 12 L22 20 L16 26 L10 20 L10 12 Z" fill="#9575CD" /><rect x="13" y="10" width="2" height="2" fill="#EDE7F6" /></svg>,
            Magic: ({className}) => <svg viewBox="0 0 32 32" className={className}><path d="M16 4 L24 12 L24 22 L16 28 L8 22 L8 12 Z" fill="#b91c1c" /><path d="M16 6 L22 12 L22 20 L16 26 L10 20 L10 12 Z" fill="#ef4444" /><rect x="13" y="10" width="2" height="2" fill="#fecaca" /></svg>,
            Gum: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><rect x="6" y="10" width="12" height="10" rx="2" /><path d="M10 10V6a2 2 0 0 1 4 0v4" /></svg>,
            GumBox: ({className}) => <svg viewBox="0 0 32 32" className={className} shapeRendering="crispEdges"><rect x="4" y="10" width="24" height="18" rx="2" fill="#42A5F5" /><rect x="4" y="10" width="24" height="6" rx="2" fill="#1E88E5" /><circle cx="16" cy="19" r="5" fill="#F06292" /><path d="M12 10 L12 6 L20 6 L20 10" fill="none" stroke="#BBDEFB" strokeWidth="2" /></svg>,
            Silvervine: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="#10b981" fill="#10b981" fillOpacity="0.2"/></svg>,
            SilvervineBox: ({className}) => <svg viewBox="0 0 32 32" className={className} shapeRendering="crispEdges"><rect x="4" y="10" width="24" height="18" fill="#8D6E63" /><path d="M4 10 L16 14 L28 10" fill="none" stroke="#5D4037" strokeWidth="2" /><path d="M16 4 L14 10 L18 10 Z" fill="#4CAF50" /><rect x="12" y="18" width="8" height="2" fill="#FFD600" /></svg>,
            SilvervineFruit: ({className, style}) => ( <svg viewBox="0 0 32 32" className={className} style={style}> <path d="M16 4c-5 0-9 6-9 14s4 12 9 12 9-4 9-12-4-14-9-14z" fill="#81C784"/> <path d="M16 4c0 0-3 6-3 14s3 12 3 12" fill="none" stroke="#4CAF50" strokeWidth="2"/> <path d="M16 2v4" stroke="#5D4037" strokeWidth="3" strokeLinecap="round"/> </svg> ),
            Zeny: ({className}) => <span className={`font-black ${className}`}>Z</span>
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Home: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
                History: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
                Box: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
                Settings: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
                Plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                X: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
                Trash: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
                Edit: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
                Copy: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1-2-2h9a2 2 0 0 1 2 2v1"/></svg>,
                Check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
                Moon: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
                Sun: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
                TrendingUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
                MinusCircle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
                PlusCircle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
                RefreshCw: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
                Sparkles: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
                AlertTriangle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
                Key: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3L15.5 7.5z"/></svg>,
                HelpCircle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
                Loader: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
                Coins: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="M16.72 11.06h1v4"/></svg>,
                User: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                ArrowLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
                Save: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
            };
            return icons[name] || null;
        };

        const NumberStepper = ({ value, onChange, min = 0, max = 999, step = 1, theme }) => {
            const handleStep = (amount) => {
                let current = parseInt(value) || 0;
                let next = current + amount;
                if (next < min) next = min;
                if (next > max) next = max;
                onChange(next);
            };
            return (
                <div className={`flex items-center gap-1 w-full rounded-xl p-1 h-[52px] transition-colors ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-100'}`}>
                    <button type="button" onClick={() => handleStep(-step)} className={`w-12 h-full rounded-lg flex items-center justify-center transition-all active:scale-95 ${theme === 'dark' ? 'bg-slate-700 text-white hover:bg-rose-600' : 'bg-white text-stone-600 hover:bg-rose-500 hover:text-white shadow-sm'}`}><Icon name="MinusCircle" size={20} /></button>
                    <input type="number" inputMode="numeric" pattern="[0-9]*" value={value} onFocus={(e) => e.target.select()} onChange={(e) => { let val = parseInt(e.target.value); if (isNaN(val)) val = ""; else if (val < min) val = min; else if (val > max) val = max; onChange(val); }} className={`flex-1 text-center font-black text-2xl bg-transparent outline-none ${theme === 'dark' ? 'text-white' : 'text-stone-800'}`} placeholder="0" />
                    <button type="button" onClick={() => handleStep(step)} className={`w-12 h-full rounded-lg flex items-center justify-center transition-all active:scale-95 ${theme === 'dark' ? 'bg-slate-700 text-white hover:bg-emerald-600' : 'bg-white text-stone-600 hover:bg-emerald-500 hover:text-white shadow-sm'}`}><Icon name="PlusCircle" size={20} /></button>
                </div>
            );
        };

        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            return (
                <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[70] bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-toast border border-slate-700/50 backdrop-blur-md">
                    {type === 'success' ? <div className="bg-emerald-500 rounded-full p-1"><Icon name="Check" size={12} className="text-white"/></div> : <Icon name="AlertTriangle" size={16} className="text-rose-500"/>}
                    <span className="text-xs font-bold">{message}</span>
                </div>
            );
        };

        const ConfirmModal = ({ title, message, onConfirm, onCancel, isProcessing, confirmColor = "rose" }) => {
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-fade-in" onClick={!isProcessing ? onCancel : undefined}>
                    <div className={`w-full max-w-sm p-6 rounded-3xl shadow-2xl border bg-slate-900 border-slate-700 relative`} onClick={e => e.stopPropagation()}>
                        <div className="flex flex-col items-center text-center gap-4">
                            <div className={`w-16 h-16 rounded-full bg-${confirmColor}-500/20 flex items-center justify-center text-${confirmColor}-500 mb-2 animate-shake`}>
                                <Icon name="AlertTriangle" size={32} />
                            </div>
                            <h3 className={`text-xl font-black text-${confirmColor}-500`}>{title}</h3>
                            <p className="text-sm opacity-70 leading-relaxed whitespace-pre-wrap">{message}</p>
                            <div className="flex gap-3 w-full mt-4">
                                <button onClick={onCancel} className="flex-1 py-3 rounded-2xl font-bold text-xs bg-slate-800 text-slate-400 hover:bg-slate-700" disabled={isProcessing}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                <button onClick={onConfirm} className={`flex-1 py-3 rounded-2xl font-bold text-xs bg-${confirmColor}-600 hover:bg-${confirmColor}-700 text-white shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all`} disabled={isProcessing}>
                                    {isProcessing ? <Icon name="Loader" size={16} className="animate-spin"/> : "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const MessageModal = ({ title, message, onClose, icon = "Check", color = "emerald" }) => {
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className={`w-full max-w-sm p-6 rounded-3xl shadow-2xl border bg-slate-900 border-slate-700 relative`} onClick={e => e.stopPropagation()}>
                        <div className="flex flex-col items-center text-center gap-4">
                            <div className={`w-16 h-16 rounded-full bg-${color}-500/20 flex items-center justify-center text-${color}-500 mb-2 animate-level-up`}>
                                <Icon name={icon} size={32} />
                            </div>
                            <h3 className={`text-xl font-black text-${color}-500`}>{title}</h3>
                            <p className="text-sm opacity-70 leading-relaxed whitespace-pre-wrap">{message}</p>
                            <div className="flex gap-3 w-full mt-4">
                                <button onClick={onClose} className="flex-1 py-3 rounded-2xl font-bold text-xs bg-slate-800 text-slate-400 hover:bg-slate-700">‡∏õ‡∏¥‡∏î</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const RewardPopup = ({ data, onClose }) => {
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-slate-900 border border-slate-700 p-8 rounded-[2.5rem] w-full max-w-sm text-center relative overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="absolute inset-0 bg-gradient-to-b from-purple-500/20 to-transparent pointer-events-none"></div>
                        <div className="animate-level-up mb-4">
                            <h2 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 italic">RECORD SAVED!</h2>
                        </div>
                        <div className="space-y-4 relative z-10">
                            <div className="bg-white/5 rounded-2xl p-4 border border-white/10">
                                <p className="text-xs text-slate-400 font-bold uppercase mb-2">Rewards</p>
                                <div className="flex justify-center gap-6">
                                    <div className="text-center">
                                        <div className="text-xl font-black text-yellow-400">+{data.expGain}</div>
                                        <div className="text-[9px] font-bold opacity-60">EXP</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-xl font-black text-emerald-400">+{data.zenyGain}</div>
                                        <div className="text-[9px] font-bold opacity-60">E-ZENY</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-xl font-black text-amber-500">+{data.coinGain}</div>
                                        <div className="text-[9px] font-bold opacity-60">COINS</div>
                                    </div>
                                </div>
                            </div>
                            <button onClick={onClose} className="w-full py-3 bg-white text-slate-900 rounded-xl font-black text-xs hover:scale-105 transition-transform">AWESOME!</button>
                        </div>
                    </div>
                </div>
            );
        };

        const NavButton = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1 w-12 transition-colors ${active ? 'text-purple-500' : 'opacity-40 hover:opacity-70'}`}>
                <Icon name={icon} size={20} />
                <span className="text-[9px] font-bold">{label}</span>
            </button>
        );

        // --- VIEWS ---
        const AddDataView = ({ onClose, targetUid, db, prices, editRecord, theme, onSuccess, userStats, allRecords, setGlobalIsSaving, setIsFormValid }) => {
            const [form, setForm] = useState(editRecord ? { ...editRecord, otherCosts: editRecord.otherCosts || [] } : { date: getDeviceDate(), runMode: 'ogh', trashAmount: '', gumUsed: 0, useSilvervine: true, purpleStoneCount: 0, contMagicCount: 0, isSellingSpell: false, isSellingMagic: false, minutesUsed: '60', otherCosts: [], notes: '' });
            const [activeLootTab, setActiveLootTab] = useState('spell');
            const [activeSection, setActiveSection] = useState('loot');
            const [showAnomalyConfirm, setShowAnomalyConfirm] = useState(false);

            useEffect(() => {
                const isValid = form.trashAmount !== '' && parseInt(form.trashAmount) >= 0 && targetUid;
                setIsFormValid(isValid);
            }, [form.trashAmount, targetUid, setIsFormValid]);

            const calculateRewards = (record, history) => {
                const currentProfit = calculateProfit(record, prices);
                let totalProfit = 0;
                history.forEach(r => totalProfit += r.profit);
                const avgProfit = history.length > 0 ? totalProfit / history.length : currentProfit;
                let coin = 0;
                if(currentProfit > avgProfit * 1.2) coin = 2; else if(currentProfit >= avgProfit * 0.8) coin = 1; else coin = 0;
                const baseExp = 10;
                let bonusExp = 0;
                if(coin === 2) bonusExp = 30; else if(coin === 1) bonusExp = 10;
                const zenyGain = Math.floor(currentProfit / 1000);
                return { coin, exp: baseExp + bonusExp, zeny: zenyGain };
            };

            const validateHardLimits = () => {
                if (parseInt(form.purpleStoneCount) > 40) return "‡∏´‡∏¥‡∏ô‡∏°‡πà‡∏ß‡∏á‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 40 ‡∏ä‡∏¥‡πâ‡∏ô";
                if (parseInt(form.contMagicCount) > 30) return "‡∏´‡∏¥‡∏ô‡πÅ‡∏î‡∏á‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ä‡∏¥‡πâ‡∏ô";
                if (parseInt(form.minutesUsed) < 5 || parseInt(form.minutesUsed) > 60) return "‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 5 - 60 ‡∏ô‡∏≤‡∏ó‡∏µ";
                return null;
            };

            const checkForAnomaly = () => {
                const sameModeRecords = allRecords.filter(r => r.runMode === form.runMode);
                if (sameModeRecords.length === 0) return false;
                const totalTrash = sameModeRecords.reduce((acc, r) => acc + r.trashAmount, 0);
                const avgTrash = totalTrash / sameModeRecords.length;
                return form.trashAmount > avgTrash * 1.75;
            };

            const processSave = async () => {
                setGlobalIsSaving(true);
                const { addDoc, collection, updateDoc, doc, setDoc } = window.firebaseModules;
                const finalData = { ...form, trashAmount: Number(form.trashAmount) || 0, minutesUsed: Number(form.minutesUsed) || 60, purpleStoneCount: Number(form.purpleStoneCount) || 0, contMagicCount: Number(form.contMagicCount) || 0, timestamp: Date.now(), profit: calculateProfit(form, prices) };
                
                await new Promise(r => setTimeout(r, 600));

                if(editRecord) {
                     await updateDoc(doc(db, 'artifacts', 'ogh-tracker-v2', 'users', targetUid, 'records', editRecord.id), finalData);
                     onSuccess(null);
                } else {
                     await addDoc(collection(db, 'artifacts', 'ogh-tracker-v2', 'users', targetUid, 'records'), finalData);
                     const rewards = calculateRewards(finalData, allRecords);
                     let newStats = { ...userStats };
                     newStats.baseExp += rewards.exp; newStats.jobExp += rewards.exp; newStats.coins += rewards.coin; newStats.zeny += rewards.zeny;
                     let nextBase = getExpReq(newStats.baseLv, 'base');
                     while(newStats.baseExp >= nextBase && newStats.baseLv < 99) { newStats.baseExp -= nextBase; newStats.baseLv++; nextBase = getExpReq(newStats.baseLv, 'base'); }
                     const maxJob = CLASS_TREE[newStats.jobClass]?.maxJob || 50;
                     let nextJob = getExpReq(newStats.jobLv, 'job');
                     while(newStats.jobExp >= nextJob && newStats.jobLv < maxJob) { newStats.jobExp -= nextJob; newStats.jobLv++; nextJob = getExpReq(newStats.jobLv, 'job'); }
                     await setDoc(doc(db, 'artifacts', 'ogh-tracker-v2', 'users', targetUid, 'gamification', 'stats'), newStats);
                     onSuccess({ expGain: rewards.exp, coinGain: rewards.coin, zenyGain: rewards.zeny });
                }
                setGlobalIsSaving(false);
            };

            const handleSaveClick = (e) => {
                e.preventDefault();
                if(!targetUid) { alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà..."); return; }
                
                const limitError = validateHardLimits();
                if(limitError) { alert(limitError); return; }

                if(checkForAnomaly()) {
                    setShowAnomalyConfirm(true);
                } else {
                    processSave();
                }
            };

            const addCost = () => setForm(p => ({...p, otherCosts: [...p.otherCosts, {id: Date.now(), name: '', amount: ''}]}));
            const removeCost = (id) => setForm(p => ({...p, otherCosts: p.otherCosts.filter(c => c.id !== id)}));
            const updateCost = (id, field, val) => {
                if (field === 'amount' && val !== '' && !/^\d*$/.test(val)) return;
                setForm(p => ({...p, otherCosts: p.otherCosts.map(c => c.id === id ? {...c, [field]: val} : c)}));
            };

            return (
                <div className={`p-6 pb-32 animate-fade-in space-y-6 ${theme === 'dark' ? 'text-slate-100' : 'text-slate-900'}`}>
                    <h2 className="text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 uppercase text-center mb-2">{editRecord ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏î‡∏±‡∏ô"}</h2>
                    
                    <div className="flex bg-slate-800 p-1 rounded-2xl mb-4">
                       <button type="button" onClick={()=>setActiveSection('loot')} className={`flex-1 py-3 rounded-xl text-xs font-black transition-all ${activeSection === 'loot' ? 'bg-slate-700 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Loot)</button>
                       <button type="button" onClick={()=>setActiveSection('setup')} className={`flex-1 py-3 rounded-xl text-xs font-black transition-all ${activeSection === 'setup' ? 'bg-slate-700 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Setup)</button>
                    </div>

                    <form id="add-data-form" onSubmit={handleSaveClick} className="space-y-6"> 
                        {activeSection === 'loot' && (
                            <div className="space-y-6 animate-in slide-in-from-right-4 duration-300">
                                <div className="flex justify-between items-center bg-slate-900/50 p-2 rounded-2xl border border-white/5">
                                    <button type="button" onClick={() => setForm(p => ({...p, runMode: 'ogh'}))} className={`flex-1 flex flex-col items-center justify-center py-3 rounded-xl transition-all ${form.runMode === 'ogh' ? 'bg-purple-600 text-white shadow-lg shadow-purple-600/30' : 'text-slate-500'}`}>
                                        <span className="text-[10px] font-black">OGH</span>
                                    </button>
                                    <button type="button" onClick={() => setForm(p => ({...p, runMode: 'aogh'}))} className={`flex-1 flex flex-col items-center justify-center py-3 rounded-xl transition-all ${form.runMode === 'aogh' ? 'bg-rose-600 text-white shadow-lg shadow-rose-600/30' : 'text-slate-500'}`}>
                                        <span className="text-[10px] font-black">AOGH</span>
                                    </button>
                                </div>

                                <div className="bg-gradient-to-br from-emerald-900/40 to-slate-900/40 p-6 rounded-3xl border border-emerald-500/20 text-center">
                                    <label className="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-2 block">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏¢‡∏∞ (Trash Sales)</label>
                                    <input 
                                        type="text" 
                                        inputMode="decimal" 
                                        value={form.trashAmount} 
                                        onChange={e => handleNumberInput(e, 'trashAmount', setForm)} 
                                        placeholder="0" 
                                        className="w-full text-center text-5xl font-black bg-transparent outline-none text-white placeholder-slate-700 tracking-tight" 
                                    />
                                    <span className="text-[10px] font-bold opacity-30 mt-2 block">ZENY</span>
                                </div>

                                <div className="space-y-4">
                                    {form.runMode === 'aogh' && (
                                        <div className="flex bg-slate-900/50 p-1 rounded-xl border border-white/5 mb-2">
                                            <button 
                                                type="button" 
                                                onClick={() => setActiveLootTab('spell')}
                                                className={`flex-1 py-2 rounded-lg text-[10px] font-bold transition-all flex items-center justify-center gap-2 ${activeLootTab === 'spell' ? 'bg-purple-600 text-white shadow' : 'text-slate-500'}`}
                                            >
                                                <SVGs.Spell className="w-4 h-4" /> ‡∏´‡∏¥‡∏ô‡∏°‡πà‡∏ß‡∏á ({form.purpleStoneCount || 0})
                                            </button>
                                            <button 
                                                type="button" 
                                                onClick={() => setActiveLootTab('magic')}
                                                className={`flex-1 py-2 rounded-lg text-[10px] font-bold transition-all flex items-center justify-center gap-2 ${activeLootTab === 'magic' ? 'bg-rose-600 text-white shadow' : 'text-slate-500'}`}
                                            >
                                                <SVGs.Magic className="w-4 h-4" /> ‡∏´‡∏¥‡∏ô‡πÅ‡∏î‡∏á ({form.contMagicCount || 0})
                                            </button>
                                        </div>
                                    )}

                                    {/* Purple Stone Input */}
                                    {(form.runMode === 'ogh' || activeLootTab === 'spell') && (
                                        <div className="bg-slate-900/50 p-5 rounded-3xl border border-white/5 flex flex-col gap-4 animate-in fade-in zoom-in duration-300">
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-purple-500/20 p-2 rounded-xl"><SVGs.Spell className="w-8 h-8"/></div>
                                                    <span className="text-sm font-bold text-purple-300">Coagulated Spell</span>
                                                </div>
                                                <div className="flex bg-slate-800 rounded-lg p-0.5">
                                                    <button type="button" onClick={() => setForm(p => ({...p, isSellingSpell: false}))} className={`px-3 py-1.5 rounded-md text-[10px] font-bold transition-all ${!form.isSellingSpell ? 'bg-purple-600 text-white' : 'text-slate-500'}`}>‡πÄ‡∏Å‡πá‡∏ö</button>
                                                    <button type="button" onClick={() => setForm(p => ({...p, isSellingSpell: true}))} className={`px-3 py-1.5 rounded-md text-[10px] font-bold transition-all ${form.isSellingSpell ? 'bg-white text-slate-900' : 'text-slate-500'}`}>‡∏Ç‡∏≤‡∏¢</button>
                                                </div>
                                            </div>
                                            <input 
                                                type="text" 
                                                inputMode="numeric" 
                                                value={form.purpleStoneCount} 
                                                onChange={e => handleNumberInput(e, 'purpleStoneCount', setForm)} 
                                                className={`w-full h-16 rounded-2xl text-center text-4xl font-black outline-none ${theme === 'dark' ? 'bg-slate-800 text-white' : 'bg-white text-slate-900'}`} 
                                                placeholder="0" 
                                            />
                                            {form.isSellingSpell && (
                                                <div className="flex items-center gap-2 bg-slate-800 p-3 rounded-xl animate-fade-in">
                                                    <span className="text-[10px] font-bold opacity-50 whitespace-nowrap">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢:</span>
                                                    <input type="text" inputMode="decimal" placeholder={prices.purpleStonePrice} onFocus={(e) => { if(e.target.value === prices.purpleStonePrice.toString()) setForm(p => ({...p, customSpellPrice: ''})) }} className="flex-1 bg-transparent text-right font-bold text-sm outline-none text-white" onChange={(e) => handleNumberInput(e, 'customSpellPrice', setForm)} value={form.customSpellPrice} />
                                                    <span className="text-[10px] font-bold opacity-50">Z</span>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Red Stone Input */}
                                    {form.runMode === 'aogh' && activeLootTab === 'magic' && (
                                        <div className="bg-slate-900/50 p-5 rounded-3xl border border-white/5 flex flex-col gap-4 animate-in fade-in zoom-in duration-300">
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-rose-500/20 p-2 rounded-xl"><SVGs.Magic className="w-8 h-8"/></div>
                                                    <span className="text-sm font-bold text-rose-300">Contaminated Magic</span>
                                                </div>
                                                <div className="flex bg-slate-800 rounded-lg p-0.5">
                                                    <button type="button" onClick={() => setForm(p => ({...p, isSellingMagic: false}))} className={`px-3 py-1.5 rounded-md text-[10px] font-bold transition-all ${!form.isSellingMagic ? 'bg-rose-600 text-white' : 'text-slate-500'}`}>‡πÄ‡∏Å‡πá‡∏ö</button>
                                                    <button type="button" onClick={() => setForm(p => ({...p, isSellingMagic: true}))} className={`px-3 py-1.5 rounded-md text-[10px] font-bold transition-all ${form.isSellingMagic ? 'bg-white text-slate-900' : 'text-slate-500'}`}>‡∏Ç‡∏≤‡∏¢</button>
                                                </div>
                                            </div>
                                            <input 
                                                type="text" 
                                                inputMode="numeric" 
                                                value={form.contMagicCount} 
                                                onChange={e => handleNumberInput(e, 'contMagicCount', setForm)} 
                                                className={`w-full h-16 rounded-2xl text-center text-4xl font-black outline-none ${theme === 'dark' ? 'bg-slate-800 text-white' : 'bg-white text-slate-900'}`} 
                                                placeholder="0" 
                                            />
                                            {form.isSellingMagic && (
                                                <div className="flex items-center gap-2 bg-slate-800 p-3 rounded-xl animate-fade-in">
                                                    <span className="text-[10px] font-bold opacity-50 whitespace-nowrap">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢:</span>
                                                    <input type="text" inputMode="decimal" placeholder={prices.contMagicPrice} onFocus={(e) => { if(e.target.value === prices.contMagicPrice.toString()) setForm(p => ({...p, customMagicPrice: ''})) }} className="flex-1 bg-transparent text-right font-bold text-sm outline-none text-white" onChange={(e) => handleNumberInput(e, 'customMagicPrice', setForm)} value={form.customMagicPrice} />
                                                    <span className="text-[10px] font-bold opacity-50">Z</span>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeSection === 'setup' && (
                            <div className="space-y-6 animate-in slide-in-from-right-4 duration-300">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="space-y-2">
                                        <label className={`text-[10px] font-bold uppercase tracking-widest ${theme === 'dark' ? 'text-slate-400' : 'text-slate-600'}`}>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                        <input type="date" value={form.date} onChange={e => setForm(p => ({...p, date: e.target.value}))} className={`w-full h-12 rounded-xl px-4 font-bold outline-none text-center ${theme === 'dark' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-900'}`} />
                                    </div>
                                    <div className="space-y-2">
                                        <label className={`text-[10px] font-bold uppercase tracking-widest ${theme === 'dark' ? 'text-slate-400' : 'text-slate-600'}`}>‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                                        <input type="text" inputMode="numeric" value={form.minutesUsed} onChange={e => handleNumberInput(e, 'minutesUsed', setForm)} className={`w-full h-12 rounded-xl px-4 font-bold text-center outline-none ${theme === 'dark' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-900'}`} placeholder="60" />
                                    </div>
                                </div>

                                <div className="bg-slate-900/50 p-5 rounded-3xl border border-white/5 space-y-5">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-blue-500/20 p-2 rounded-xl"><SVGs.GumBox className="w-5 h-5"/></div>
                                            <span className="text-sm font-bold">Bubble Gum</span>
                                        </div>
                                        <div className="flex gap-1 bg-slate-800 p-1 rounded-lg">
                                            {[0,1,2].map(n => <button key={n} type="button" onClick={() => setForm(p => ({...p, gumUsed: n}))} className={`w-10 h-10 rounded-md text-sm font-black transition-all ${form.gumUsed === n ? 'bg-blue-500 text-white shadow' : 'text-slate-500 hover:bg-slate-700'}`}>{n}</button>)}
                                        </div>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-emerald-500/20 p-2 rounded-xl"><SVGs.SilvervineBox className="w-5 h-5"/></div>
                                            <span className="text-sm font-bold">Silvervine</span>
                                        </div>
                                        <button type="button" onClick={() => setForm(p => ({...p, useSilvervine: !p.useSilvervine}))} className={`w-14 h-10 rounded-lg border flex items-center justify-center transition-all ${form.useSilvervine ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-600 text-slate-600'}`}>
                                            {form.useSilvervine ? <Icon name="Check" size={20}/> : <Icon name="X" size={20}/>}
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-3">
                                        <span className="text-xs font-bold uppercase tracking-widest text-slate-400">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
                                        <button type="button" onClick={addCost} className="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg flex items-center gap-1 transition-all"><Icon name="Plus" size={12}/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                                    </div>
                                    <div className="space-y-3">
                                        {form.otherCosts.map(c => (
                                            <div key={c.id} className="flex gap-2 animate-fade-in">
                                                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." value={c.name} onChange={e => updateCost(c.id, 'name', e.target.value)} className="flex-1 h-12 bg-slate-800 rounded-xl px-4 text-sm outline-none text-white" />
                                                <input type="text" inputMode="numeric" placeholder="0" value={c.amount} onChange={e => updateCost(c.id, 'amount', e.target.value)} className="w-24 h-12 bg-slate-800 rounded-xl px-4 text-sm outline-none text-right text-white" />
                                                <button type="button" onClick={() => removeCost(c.id)} className="w-12 h-12 flex items-center justify-center text-rose-500 hover:bg-rose-500/10 rounded-xl"><Icon name="Trash" size={18}/></button>
                                            </div>
                                        ))}
                                        {form.otherCosts.length === 0 && <p className="text-center text-[10px] opacity-30 py-4 border border-dashed border-slate-700 rounded-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>}
                                    </div>
                                </div>

                                <div className="space-y-2">
                                    <p className="text-xs font-bold uppercase tracking-widest text-slate-400">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥</p>
                                    <textarea value={form.notes} onChange={e => setForm(p => ({...p, notes: e.target.value}))} className="w-full h-32 bg-slate-900/50 border border-white/5 rounded-3xl p-4 text-sm font-medium outline-none resize-none text-white placeholder-slate-600" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                                </div>
                            </div>
                        )}
                    </form>
                    {showAnomalyConfirm && <ConfirmModal title="‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥?" message="‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏¢‡∏∞‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏≤‡∏Å ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?" onConfirm={() => { setShowAnomalyConfirm(false); processSave(); }} onCancel={() => setShowAnomalyConfirm(false)} isProcessing={false} confirmColor="emerald" />}
                </div>
            );
        };

        const HomeView = ({ records, prices, userStats, goToTab }) => {
            const totalProfit = records.reduce((acc, r) => acc + (r.profit || 0), 0);
            const totalRuns = records.length;
            const chartData = [...records].reverse().slice(-7).map(r => ({ name: r.date.split('/')[0], profit: r.profit }));

            return (
                <div className="p-6 space-y-6 animate-fade-in pb-24">
                    <header className="flex justify-between items-center">
                        <div onClick={() => goToTab('profile')} className="flex items-center gap-3 bg-white/5 border border-white/10 p-1.5 pr-4 rounded-full cursor-pointer hover:bg-white/10 transition-all active:scale-95">
                            <div className={`w-9 h-9 rounded-full flex items-center justify-center text-[10px] font-black shadow-lg border border-white/20 ${userStats.isHighClass ? 'bg-gradient-to-tr from-amber-300 to-yellow-600 text-white' : 'bg-gradient-to-tr from-slate-600 to-slate-500 text-white'}`}>
                                 {userStats.jobClass ? userStats.jobClass.substring(0, 2).toUpperCase() : 'NO'}
                            </div>
                            <div className="flex flex-col">
                                <span className="text-[9px] font-bold uppercase tracking-wider opacity-60">Lv. {userStats.baseLv}</span>
                                <span className="text-[10px] font-black leading-none">{userStats.jobClass}</span>
                            </div>
                        </div>
                        <div className="text-right"><p className="text-[10px] opacity-50 uppercase font-bold">Total Profit</p><p className="text-xl font-black text-emerald-500">{formatMoney(totalProfit)}</p></div>
                    </header>
                    <div className="grid grid-cols-2 gap-3">
                        <div className="glass-panel p-4 rounded-3xl"><div className="w-8 h-8 rounded-full bg-blue-500/20 text-blue-500 flex items-center justify-center mb-2"><Icon name="TrendingUp" size={16}/></div><p className="text-2xl font-black">{totalRuns}</p><p className="text-[10px] opacity-50 font-bold">‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á</p></div>
                        <div className="glass-panel p-4 rounded-3xl"><div className="w-8 h-8 rounded-full bg-amber-500/20 text-amber-500 flex items-center justify-center mb-2"><Icon name="History" size={16}/></div><p className="text-2xl font-black">{records.length > 0 ? records[0].date : '-'}</p><p className="text-[10px] opacity-50 font-bold">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p></div>
                    </div>
                    <div className="glass-panel p-4 rounded-3xl h-48 relative overflow-hidden">
                         <p className="text-xs font-bold opacity-50 mb-2 absolute top-4 left-4 z-10">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≥‡πÑ‡∏£ (7 ‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</p>
                         <div className="absolute inset-0 pt-8 pl-0 pr-0"><ResponsiveContainer width="100%" height="100%"><AreaChart data={chartData}><defs><linearGradient id="colorP" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#a855f7" stopOpacity={0.3}/><stop offset="95%" stopColor="#a855f7" stopOpacity={0}/></linearGradient></defs><Area type="monotone" dataKey="profit" stroke="#a855f7" strokeWidth={3} fill="url(#colorP)" /></AreaChart></ResponsiveContainer></div>
                    </div>
                     <div className="space-y-2">
                        <p className="text-xs font-bold opacity-50 px-2">RECENT ACTIVITY</p>
                        {records.slice(0, 3).map(r => (
                            <div key={r.id} className="glass-panel p-3 rounded-2xl flex justify-between items-center"><div className="flex gap-3 items-center"><div className={`w-10 h-10 rounded-xl flex items-center justify-center text-[8px] font-black uppercase ${r.mode === 'aogh' ? 'bg-rose-500 text-white' : 'bg-purple-500 text-white'}`}>{r.mode}</div><div><p className="font-bold text-xs">{r.date}</p><p className="text-[10px] opacity-50">{r.purpleStoneCount} Spell {r.contMagicCount > 0 && `‚Ä¢ ${r.contMagicCount} Magic`}</p></div></div><span className="font-black text-emerald-500 text-sm">+{formatMoney(r.profit)}</span></div>
                        ))}
                    </div>
                </div>
            );
        };

        const HistoryView = ({ records, onEdit, onDelete }) => (
            <div className="p-4 pb-24 animate-fade-in">
                <h2 className="text-lg font-black mb-4 px-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°</h2>
                <div className="space-y-3">
                    {records.map((r) => (
                        <div key={r.id} className="glass-panel p-4 rounded-3xl flex justify-between items-center relative group overflow-hidden"><div className="flex gap-4 items-center relative z-10"><div className={`w-12 h-12 rounded-2xl flex flex-col items-center justify-center text-[10px] font-black uppercase ${r.mode === 'aogh' ? 'bg-rose-500 text-white' : 'bg-purple-500 text-white'}`}><span>{r.mode}</span></div><div><p className="font-bold text-sm">{r.date}</p><div className="flex gap-2 text-[10px] opacity-60 mt-0.5"><span className="flex items-center gap-1"><SVGs.Spell className="w-3 h-3"/> {r.purpleStoneCount || 0}</span>{r.contMagicCount > 0 && <span className="flex items-center gap-1"><SVGs.Magic className="w-3 h-3"/> {r.contMagicCount}</span>}</div></div></div><div className="text-right relative z-10"><p className="font-black text-emerald-500 text-lg">{formatMoney(r.profit)}</p><div className="flex justify-end gap-3 mt-1"><button onClick={() => onEdit(r)} className="opacity-40 hover:opacity-100"><Icon name="Edit" size={14}/></button><button onClick={() => onDelete(r.id)} className="opacity-40 hover:opacity-100 hover:text-rose-500"><Icon name="Trash" size={14}/></button></div></div></div>
                    ))}
                    {records.length === 0 && <div className="text-center py-10 opacity-30 font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>}
                </div>
            </div>
        );

        const InventoryView = ({ records, prices, manualSales, onSell, goToTab }) => {
            const soldSpell = records.reduce((acc, r) => acc + (r.isSellingSpell ? Number(r.purpleStoneCount) : 0), 0);
            const totalSpell = records.reduce((acc, r) => acc + Number(r.purpleStoneCount || 0), 0);
            const stockSpell = Math.max(0, totalSpell - soldSpell);

            const soldMagic = records.reduce((acc, r) => acc + (r.isSellingMagic ? Number(r.contMagicCount) : 0), 0);
            const totalMagic = records.reduce((acc, r) => acc + Number(r.contMagicCount || 0), 0);
            const stockMagic = Math.max(0, totalMagic - soldMagic);

            const manualSoldSpell = manualSales.filter(s => s.item === 'spell').reduce((acc, s) => acc + Number(s.quantity || 0), 0);
            const manualSoldMagic = manualSales.filter(s => s.item === 'magic').reduce((acc, s) => acc + Number(s.quantity || 0), 0);

            const finalStockSpell = Math.max(0, stockSpell - manualSoldSpell);
            const finalStockMagic = Math.max(0, stockMagic - manualSoldMagic);
            
            const [analysisResult, setAnalysisResult] = useState(null);
            const [analyzing, setAnalyzing] = useState(false);
            const [usageInfo, setUsageInfo] = useState({ count: 0, remaining: 10 });
            const [hasCustomKey, setHasCustomKey] = useState(false);

            useEffect(() => {
                const checkAiQuota = () => {
                    const customKey = localStorage.getItem('ogh_gemini_key');
                    if (customKey) { setHasCustomKey(true); return; }
                    const today = new Date().toISOString().split('T')[0];
                    const usageData = JSON.parse(localStorage.getItem('ogh_ai_quota') || '{"date":"", "count":0}');
                    if (usageData.date !== today) { setUsageInfo({ count: 0, remaining: 10 }); } else { setUsageInfo({ count: usageData.count, remaining: 10 - usageData.count }); }
                };
                checkAiQuota();
            }, []);

            const incrementAiQuota = () => {
                const today = new Date().toISOString().split('T')[0];
                const usageData = JSON.parse(localStorage.getItem('ogh_ai_quota') || '{"date":"", "count":0}');
                let newCount = 1;
                if (usageData.date === today) { newCount = usageData.count + 1; }
                localStorage.setItem('ogh_ai_quota', JSON.stringify({ date: today, count: newCount }));
                setUsageInfo({ count: newCount, remaining: 10 - newCount });
            };

            const handleAnalysis = async () => {
                if (!hasCustomKey && usageInfo.remaining <= 0) { setAnalysisResult("QUOTA_EXCEEDED"); return; }
                setAnalyzing(true);
                const recent = records.slice(0, 10);
                const prompt = `Analyze these Ragnarok Online OGH stats for last 10 runs (JSON): ${JSON.stringify(recent)}. Current prices: Spell=${prices.purpleStonePrice}, Magic=${prices.contMagicPrice}. Analyze Drop Luck and Zeny Efficiency. Respond in Thai language, friendly tone, short and concise (max 2 sentences). Add emoji.`;
                const result = await callGemini(prompt);
                if (result && result !== "QUOTA_EXCEEDED" && result !== "INVALID_KEY" && result !== "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠" && !hasCustomKey) { incrementAiQuota(); }
                setAnalysisResult(result);
                setAnalyzing(false);
            };

            return (
                <div className="p-6 pb-24 animate-fade-in">
                    <h2 className="text-lg font-black mb-6">‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥</h2>
                    <div className="space-y-4">
                        <div className="glass-panel p-6 rounded-3xl flex items-center justify-between">
                            <div className="flex items-center gap-4"><div className="w-16 h-16 bg-purple-500/20 rounded-2xl flex items-center justify-center"><SVGs.Spell className="w-10 h-10"/></div><div><p className="text-xs opacity-50 font-bold uppercase">‡∏´‡∏¥‡∏ô‡∏°‡πà‡∏ß‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><p className="text-3xl font-black">{finalStockSpell}</p></div></div>
                            <div className="flex flex-col items-end gap-2"><div className="text-right"><p className="text-[10px] opacity-50 mb-1">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p><p className="text-sm font-bold text-purple-400">{formatMoney(finalStockSpell * prices.purpleStonePrice)} z</p></div><button onClick={() => onSell('spell', finalStockSpell)} className="bg-purple-500 hover:bg-purple-600 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg shadow-md transition-all active:scale-95">‡∏Ç‡∏≤‡∏¢</button></div>
                        </div>
                        <div className="glass-panel p-6 rounded-3xl flex items-center justify-between">
                            <div className="flex items-center gap-4"><div className="w-16 h-16 bg-rose-500/20 rounded-2xl flex items-center justify-center"><SVGs.Magic className="w-10 h-10"/></div><div><p className="text-xs opacity-50 font-bold uppercase">‡∏´‡∏¥‡∏ô‡πÅ‡∏î‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><p className="text-3xl font-black">{finalStockMagic}</p></div></div>
                            <div className="flex flex-col items-end gap-2"><div className="text-right"><p className="text-[10px] opacity-50 mb-1">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p><p className="text-sm font-bold text-rose-400">{formatMoney(finalStockMagic * prices.contMagicPrice)} z</p></div><button onClick={() => onSell('magic', finalStockMagic)} className="bg-rose-500 hover:bg-rose-600 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg shadow-md transition-all active:scale-95">‡∏Ç‡∏≤‡∏¢</button></div>
                        </div>
                    </div>
                    <div className="mt-8"><div className="glass-panel p-5 rounded-3xl relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="Sparkles" size={60} /></div><h3 className="text-sm font-black mb-2 flex items-center gap-2"><Icon name="Sparkles" size={16} className="text-yellow-400"/> AI Merchant Insight</h3>
                        {!analysisResult ? (
                            <div className="text-center py-4"><p className="text-xs opacity-60 mb-4">‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏ß‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p><button onClick={handleAnalysis} disabled={analyzing || (!hasCustomKey && usageInfo.remaining <= 0)} className={`bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-xs font-bold px-6 py-3 rounded-xl shadow-lg active:scale-95 transition-all flex items-center gap-2 mx-auto ${(!hasCustomKey && usageInfo.remaining <= 0) ? 'opacity-50 cursor-not-allowed' : ''}`}>{analyzing ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡πà‡∏≤‡∏¢‡πÄ‡∏ß‡∏ó‡∏¢‡πå..." : "‚ú® ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£"}</button>{!hasCustomKey && <p className="text-[10px] mt-2 opacity-40">‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: {usageInfo.remaining}/10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>}{hasCustomKey && <p className="text-[10px] mt-2 text-emerald-500 font-bold">Personal Key Active (Unlimited)</p>}</div>
                        ) : (
                            <div className="animate-fade-in">
                                {analysisResult === "QUOTA_EXCEEDED" ? (
                                    <div className="bg-rose-500/10 p-4 rounded-2xl border border-rose-500/20 text-center"><p className="text-rose-500 font-bold text-xs mb-2">‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ü‡∏£‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!</p><p className="text-[10px] opacity-70 mb-3">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà API Key ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î</p><button onClick={() => goToTab('settings')} className="bg-rose-500 text-white px-4 py-2 rounded-xl text-xs font-bold">‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key</button></div>
                                ) : analysisResult === "INVALID_KEY" ? (
                                     <div className="bg-rose-500/10 p-4 rounded-2xl border border-rose-500/20 text-center"><p className="text-rose-500 font-bold text-xs mb-2">API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!</p><p className="text-[10px] opacity-70 mb-3">Shared Key ‡∏≠‡∏≤‡∏à‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Key ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</p><div className="flex gap-2 justify-center"><button onClick={() => { localStorage.removeItem('ogh_gemini_key'); window.location.reload(); }} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-xl text-[10px] font-bold">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</button><button onClick={() => goToTab('settings')} className="bg-rose-500 text-white px-4 py-2 rounded-xl text-[10px] font-bold">‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key</button></div></div>
                                ) : (
                                    <div><p className="text-xs font-medium leading-relaxed bg-black/20 p-4 rounded-2xl border border-white/5">"{analysisResult}"</p><div className="flex justify-between items-center mt-3">{!hasCustomKey && <p className="text-[10px] opacity-40">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤: {usageInfo.remaining}/10</p>}<button onClick={() => setAnalysisResult(null)} className="text-[10px] font-bold opacity-50 hover:opacity-100 uppercase">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button></div></div>
                                )}
                            </div>
                        )}
                    </div></div>
                </div>
            );
        };

        const SettingsView = ({ uid, prices, theme, setTheme, setTargetUid, authError, showToast, db }) => {
            const [localPrices, setLocalPrices] = useState(prices);
            const [restoreCode, setRestoreCode] = useState('');
            const [localKey, setLocalKey] = useState('');
            const [showKeyGuide, setShowKeyGuide] = useState(false);
            const [showRestore, setShowRestore] = useState(false);
            const [saveStatus, setSaveStatus] = useState('idle');
            const [isDeleting, setIsDeleting] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [showCopyModal, setShowCopyModal] = useState(false);
            const [highlightKey, setHighlightKey] = useState(false); // To receive prop for highlight

            useEffect(() => { setLocalKey(localStorage.getItem('ogh_gemini_key') || ''); }, []);
            
            // Check if user came here because of missing key
            const isMissingKey = !localKey && !localStorage.getItem('ogh_gemini_key');

            const handleSavePrices = async () => {
                if(!uid) return;
                setSaveStatus('saving');
                const { doc, setDoc } = window.firebaseModules;
                await setDoc(doc(db, 'artifacts', 'ogh-tracker-v2', 'users', uid, 'config', 'prices'), localPrices, { merge: true });
                await new Promise(r => setTimeout(r, 500));
                setSaveStatus('success');
                setTimeout(() => setSaveStatus('idle'), 2000);
            };
            const handleRestore = () => { if(restoreCode.length < 5) return; localStorage.setItem('ogh_restore_uid', restoreCode); window.location.reload(); };
            const copyUid = () => { navigator.clipboard.writeText(uid); setShowCopyModal(true); };
            const saveApiKey = () => { localStorage.setItem('ogh_gemini_key', localKey); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Gemini API Key ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); window.location.reload(); };

            const deleteAllData = async () => { setShowDeleteConfirm(true); };
            
            const performDelete = async () => {
                setIsDeleting(true);
                const { collection, getDocs, deleteDoc, doc } = window.firebaseModules;
                try {
                    const recordsRef = collection(db, 'artifacts', 'ogh-tracker-v2', 'users', uid, 'records');
                    const recordsSnap = await getDocs(recordsRef);
                    const deleteRecordsPromises = recordsSnap.docs.map(d => deleteDoc(d.ref));
                    const salesRef = collection(db, 'artifacts', 'ogh-tracker-v2', 'users', uid, 'sales');
                    const salesSnap = await getDocs(salesRef);
                    const deleteSalesPromises = salesSnap.docs.map(d => deleteDoc(d.ref));
                    const statsRef = doc(db, 'artifacts', 'ogh-tracker-v2', 'users', uid, 'gamification', 'stats');
                    await deleteDoc(statsRef);
                    await Promise.all([...deleteRecordsPromises, ...deleteSalesPromises]);
                    showToast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                    setShowDeleteConfirm(false);
                    setTimeout(() => window.location.reload(), 1000);
                } catch(e) { console.error(e); alert("Error: " + e.message); } finally { setIsDeleting(false); }
            };

            const priceConfig = [ { key: 'purpleStonePrice', label: 'Coagulated Spell', icon: <SVGs.Spell className="w-4 h-4" /> }, { key: 'contMagicPrice', label: 'Contaminated Magic', icon: <SVGs.Magic className="w-4 h-4" /> }, { key: 'gumBoxPrice', label: 'Bubble Gum (Box)', icon: <SVGs.GumBox className="w-4 h-4" /> }, { key: 'silvervineBoxPrice', label: 'Silvervine (Box)', icon: <SVGs.SilvervineBox className="w-4 h-4" /> } ];

            return (
                <div className="p-6 pb-24 animate-fade-in space-y-8">
                    <h2 className="text-lg font-black">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
                    {authError && (<div className="bg-rose-500/10 border border-rose-500/30 p-4 rounded-2xl flex items-center gap-3 text-rose-500"><Icon name="AlertTriangle" size={24} /><div><p className="text-xs font-bold uppercase">Connection Error</p><p className="text-[10px] opacity-70 break-all">{authError}</p></div></div>)}
                    <div className="glass-panel p-5 rounded-3xl">
                        <div className="flex justify-between items-center mb-2"><p className="text-[10px] font-bold opacity-50 uppercase">User ID (Backup Code)</p><button onClick={() => setShowRestore(!showRestore)} className="text-[10px] text-blue-500 font-bold hover:underline flex items-center gap-1"><Icon name="RefreshCw" size={12} /> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)</button></div>
                        <div className="flex gap-2"><code className={`p-3 rounded-xl text-xs font-mono flex-1 overflow-hidden ${uid ? 'bg-black/20' : 'bg-amber-500/20 text-amber-500'}`}>{uid || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...'}</code>{uid ? <button onClick={copyUid} className="bg-slate-500/20 p-3 rounded-xl"><Icon name="Copy" size={16}/></button> : <button onClick={() => window.location.reload()} className="bg-slate-500/20 p-3 rounded-xl"><Icon name="RefreshCw" size={16}/></button>}</div>
                        {showRestore && (<div className="mt-3 p-4 rounded-2xl bg-slate-500/10 animate-fade-in"><p className="text-[10px] font-bold opacity-70 mb-2">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ UID ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</p><div className="flex gap-2"><input type="text" placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." value={restoreCode} onChange={e => setRestoreCode(e.target.value)} className="flex-1 bg-black/10 rounded-xl px-3 text-xs outline-none h-10" /><button onClick={handleRestore} className="px-4 bg-amber-500 hover:bg-amber-600 text-white rounded-xl text-[10px] font-bold">Restore</button></div></div>)}
                    </div>
                    
                    {/* Gemini API Key Section with Highlight Logic */}
                    <div className={`glass-panel p-5 rounded-3xl transition-all duration-500 ${isMissingKey ? 'border-rose-500 shadow-rose-500/50 ring-2 ring-rose-500' : ''}`}>
                        <div className="flex justify-between items-center mb-2"><p className={`text-[10px] font-bold opacity-50 uppercase ${isMissingKey ? 'text-rose-500' : ''}`}>Gemini API Key (Required for AI)</p><button onClick={() => setShowKeyGuide(!showKeyGuide)} className="text-[10px] text-blue-500 font-bold hover:underline flex items-center gap-1"><Icon name="HelpCircle" size={12} /> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö Key ‡∏ü‡∏£‡∏µ</button></div>
                        <div className="flex gap-2 mb-2"><input type="password" placeholder="Paste your API Key here..." value={localKey} onChange={e => setLocalKey(e.target.value)} className={`flex-1 ${theme === 'dark' ? 'bg-black/20' : 'bg-slate-100'} rounded-2xl px-4 text-xs outline-none h-10`} /><button onClick={saveApiKey} className="bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-3 rounded-xl text-[10px] font-bold shadow-lg">SAVE</button></div>
                        <p className={`text-[10px] opacity-40 ${isMissingKey ? 'text-rose-500 font-bold opacity-100' : ''}`}>{isMissingKey ? "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå" : "‡πÉ‡∏™‡πà Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI"}</p>
                        {showKeyGuide && (<div className={`mt-3 p-4 rounded-2xl text-xs ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-50'} animate-fade-in`}><ol className="list-decimal pl-4 space-y-2 opacity-80"><li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡πá‡∏ö <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-500 underline font-bold">Google AI Studio</a></li><li>‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Google Account</li><li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <span className="font-bold">Create API Key</span></li><li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <span className="font-bold">Create API key in new project</span></li><li>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ AIza...) ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</li></ol></div>)}
                    </div>
                    
                    <div className="space-y-4"><p className="text-xs font-bold opacity-50 uppercase">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏á (Market Prices)</p><div className="grid grid-cols-2 gap-4">{priceConfig.map(item => (<div key={item.key} className="glass-panel p-3 rounded-2xl"><div className="flex items-center gap-2 mb-2 opacity-70">{item.icon}<label className="text-[10px] font-bold uppercase truncate">{item.label}</label></div><input type="text" inputMode="numeric" value={localPrices[item.key] || ''} onChange={e => { const val = e.target.value; if (val === '' || /^\d*$/.test(val)) { setLocalPrices({...localPrices, [item.key]: val === '' ? '' : Number(val)}) } }} className="w-full bg-transparent font-bold outline-none" placeholder="0" /></div>))}</div><button onClick={handleSavePrices} disabled={saveStatus !== 'idle'} className={`w-full py-3 rounded-2xl text-xs font-bold flex items-center justify-center gap-2 transition-all ${saveStatus === 'success' ? 'bg-emerald-500 text-white' : 'bg-slate-800 text-white'}`}>{saveStatus === 'saving' && <Icon name="Loader" size={16} className="animate-spin"/>}{saveStatus === 'success' && <Icon name="Check" size={16}/>}{saveStatus === 'idle' && "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤"}{saveStatus === 'saving' && "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."}{saveStatus === 'success' && "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"}</button></div>
                    <div className="space-y-4 pt-4 border-t border-slate-500/20"><button onClick={deleteAllData} className="w-full py-3 bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white rounded-2xl text-xs font-bold flex items-center justify-center gap-2 transition-all"><Icon name="Trash" size={16}/> Delete All Data (‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</button><button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="w-full py-3 border border-slate-500/20 rounded-2xl text-xs font-bold flex items-center justify-center gap-2">{theme === 'dark' ? <Icon name="Sun" size={16}/> : <Icon name="Moon" size={16}/>} ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°</button></div>
                    {showDeleteConfirm && (<ConfirmModal title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?" message="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ" onConfirm={performDelete} onCancel={() => setShowDeleteConfirm(false)} isProcessing={isDeleting} />)}
                    {showCopyModal && <MessageModal title="Copied!" message="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å User ID ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß" onClose={() => setShowCopyModal(false)} icon="Check" color="emerald" />}
                    <div className="text-center opacity-30 text-[9px] font-bold mt-8 pb-4">{APP_VERSION}</div>
                </div>
            );
        };

        const ProfileView = ({ stats, records, db, uid, showToast, goToTab }) => {
            const [showClassChange, setShowClassChange] = useState(false);
            
            const nextLevelExp = getExpReq(stats.baseLv, 'base');
            const nextJobExp = getExpReq(stats.jobLv, 'job');
            const baseProgress = Math.min((stats.baseExp / nextLevelExp) * 100, 100);
            const jobProgress = Math.min((stats.jobExp / nextJobExp) * 100, 100);
            
            const handleClassChange = async (targetClass, cost) => {
                 if (stats.coins < cost) { alert("Coins ‡πÑ‡∏°‡πà‡∏û‡∏≠!"); return; }
                 const { doc, updateDoc } = window.firebaseModules;
                 const newStats = { ...stats, jobClass: targetClass, jobLv: 1, jobExp: 0, coins: stats.coins - cost };
                 if (targetClass === 'High Novice') { if(stats.baseLv < 99 || stats.jobLv < 50) return; newStats.baseLv = 1; newStats.baseExp = 0; newStats.isHighClass = true; newStats.zeny = stats.zeny - 1285000; }
                 await updateDoc(doc(db, 'artifacts', 'ogh-tracker-v2', 'users', uid, 'gamification', 'stats'), newStats);
                 showToast("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "success");
                 setShowClassChange(false);
            };

            const availableClasses = CLASS_TREE[stats.jobClass]?.next || [];
            const canChangeJob = (stats.jobClass === 'Novice' && stats.jobLv >= 10) || (stats.jobLv >= 40 && availableClasses.length > 0) || (stats.baseLv >= 99 && stats.jobLv >= 50 && !stats.isHighClass && stats.jobClass.includes('Knight'));

            return (
                <div className="p-6 pb-24 animate-fade-in space-y-6">
                    <header className="flex justify-between items-start">
                        <div><h2 className="text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">PROFILE</h2><p className="text-[10px] opacity-50 font-bold tracking-widest">{stats.isHighClass ? 'HIGH CLASS' : 'NORMAL CLASS'}</p></div>
                    </header>
                    <div className="glass-panel p-6 rounded-3xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="User" size={80} /></div>
                        <div className="flex items-center gap-4 mb-6 relative z-10">
                            <div className={`w-20 h-20 rounded-2xl flex items-center justify-center text-3xl font-black shadow-lg ${stats.isHighClass ? 'bg-gradient-to-tr from-amber-300 to-yellow-500 text-white' : 'bg-gradient-to-tr from-slate-700 to-slate-600 text-white'}`}>{stats.jobClass.substring(0, 2).toUpperCase()}</div>
                            <div><h3 className="text-xl font-black">{stats.jobClass}</h3><p className="text-xs opacity-60">Base Lv. {stats.baseLv} / Job Lv. {stats.jobLv}</p></div>
                        </div>
                        <div className="space-y-3 relative z-10">
                            <div><div className="flex justify-between text-[10px] font-bold mb-1 opacity-70"><span>Base EXP</span><span>{Math.floor(baseProgress)}%</span></div><div className="w-full h-2 bg-black/20 rounded-full overflow-hidden"><div className="h-full bg-amber-400 rounded-full progress-bar" style={{width: `${baseProgress}%`}}></div></div></div>
                            <div><div className="flex justify-between text-[10px] font-bold mb-1 opacity-70"><span>Job EXP</span><span>{Math.floor(jobProgress)}%</span></div><div className="w-full h-2 bg-black/20 rounded-full overflow-hidden"><div className="h-full bg-blue-400 rounded-full progress-bar" style={{width: `${jobProgress}%`}}></div></div></div>
                        </div>
                        {canChangeJob && (<button onClick={() => setShowClassChange(true)} className="mt-6 w-full py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl text-xs font-black shadow-lg active:scale-95 transition-all animate-pulse">CHANGE JOB AVAILABLE!</button>)}
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="glass-panel p-4 rounded-3xl flex flex-col items-center justify-center gap-2"><Icon name="Coins" size={24} className="text-amber-400" /><div><p className="text-2xl font-black text-amber-400">{stats.coins}</p><p className="text-[10px] opacity-50 font-bold text-center">OGH COINS</p></div></div>
                        <div className="glass-panel p-4 rounded-3xl flex flex-col items-center justify-center gap-2"><SVGs.Zeny className="text-2xl text-blue-400" /><div><p className="text-xl font-black text-blue-400">{formatMoney(stats.zeny)}</p><p className="text-[10px] opacity-50 font-bold text-center">E-ZENY</p></div></div>
                    </div>
                    {showClassChange && (<div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm" onClick={() => setShowClassChange(false)}><div className="bg-slate-900 border border-slate-700 p-6 rounded-3xl w-full max-w-sm" onClick={e => e.stopPropagation()}><h3 className="text-xl font-black mb-4">Class Change</h3><div className="space-y-3">{availableClasses.map(cls => (<button key={cls} onClick={() => handleClassChange(cls, 10)} className="w-full p-4 rounded-xl bg-slate-800 hover:bg-slate-700 text-left flex justify-between items-center"><span className="font-bold">{cls}</span><span className="text-xs text-amber-400 font-bold">10 Coins</span></button>))}</div></div></div>)}
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('home'); 
            const [records, setRecords] = useState([]);
            const [globalPrices, setGlobalPrices] = useState({ purpleStonePrice: 0, contMagicPrice: 0, gumBoxPrice: 0, silvervineBoxPrice: 0 });
            const [targetUid, setTargetUid] = useState(null);
            const [loading, setLoading] = useState(true);
            const [theme, setTheme] = useState('dark');
            const [editRecordId, setEditRecordId] = useState(null);
            const [authError, setAuthError] = useState(null);
            const [toast, setToast] = useState(null);
            const [rewardData, setRewardData] = useState(null);
            const [userStats, setUserStats] = useState(INITIAL_STATS);
            const [isSaving, setIsSaving] = useState(false);
            const [isFormValid, setIsFormValid] = useState(false); // Track form validity

            // Manual sales state
            const [manualSales, setManualSales] = useState([]);
            const [showSaleModal, setShowSaleModal] = useState(false);
            const [saleItem, setSaleItem] = useState(null);
            const [saleFormData, setSaleFormData] = useState({ quantity: "", price: "" });
            const [maxSaleQty, setMaxSaleQty] = useState(0);
            
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false); // For History delete
            const [deleteTargetId, setDeleteTargetId] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);

            const showToast = (message, type = 'success') => { setToast({ message, type }); };
            const goToTab = (tabName) => setActiveTab(tabName);

            useEffect(() => {
                const init = async () => {
                    if (!window.firebaseModules) { window.addEventListener('firebase-ready', init); return; }
                    const { initializeApp, getAuth, getFirestore, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.firebaseModules;
                    try {
                        const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MANUAL_FIREBASE_CONFIG;
                        const app = initializeApp(config);
                        auth = getAuth(app);
                        db = getFirestore(app);
                        const savedUid = localStorage.getItem('ogh_restore_uid');
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); }
                        onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            if(u) setTargetUid(savedUid || u.uid);
                            setLoading(false);
                        }, (error) => { console.error(error); setAuthError(error.message); setLoading(false); });
                    } catch(e) { console.error(e); setAuthError(e.message); setLoading(false); } 
                };
                init();
            }, []);

            useEffect(() => {
                if(!targetUid || !db) return;
                const { collection, onSnapshot, doc, query, orderBy } = window.firebaseModules;
                const q = query(collection(db, 'artifacts', 'ogh-tracker-v2', 'users', targetUid, 'records'), orderBy('timestamp', 'desc'));
                const unsubRecords = onSnapshot(q, snap => setRecords(snap.docs.map(d => ({...d.data(), id: d.id}))));
                const unsubConfig = onSnapshot(doc(db, 'artifacts', 'ogh-tracker-v2', 'users', targetUid, 'config', 'prices'), d => { if(d.exists()) setGlobalPrices(d.data()); });
                const unsubSales = onSnapshot(collection(db, 'artifacts', 'ogh-tracker-v2', 'users', targetUid, 'sales'), (snap) => setManualSales(snap.docs.map(d => ({ ...d.data(), id: d.id }))));
                const unsubStats = onSnapshot(doc(db, 'artifacts', 'ogh-tracker-v2', 'users', targetUid, 'gamification', 'stats'), d => { if(d.exists()) setUserStats(d.data()); else setUserStats(INITIAL_STATS); });
                return () => { unsubRecords(); unsubConfig(); unsubSales(); unsubStats(); };
            }, [targetUid]);

            useEffect(() => { document.body.className = theme; }, [theme]);

            const handleManualSellSubmit = async () => {
                const q = Number(saleFormData.quantity);
                const p = Number(saleFormData.price);
                if (isNaN(q) || q <= 0 || isNaN(p) || p < 0) return;
                const saleData = { item: saleItem, quantity: q, price: p, timestamp: Date.now() };
                if (db && targetUid) {
                    const { addDoc, collection } = window.firebaseModules;
                    await addDoc(collection(db, 'artifacts', 'ogh-tracker-v2', 'users', targetUid, 'sales'), saleData);
                    showToast("‡∏Ç‡∏≤‡∏¢‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                }
                setShowSaleModal(false);
                setSaleFormData({ quantity: "", price: "" });
            };
            
            const handleConfirmDeleteHistory = async () => {
                if(!deleteTargetId) return;
                setIsDeleting(true);
                const { deleteDoc, doc } = window.firebaseModules;
                try {
                     await deleteDoc(doc(db, 'artifacts', 'ogh-tracker-v2', 'users', targetUid, 'records', deleteTargetId)); 
                     showToast("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß");
                     setShowDeleteConfirm(false);
                     setDeleteTargetId(null);
                } catch(e) { console.error(e); } finally { setIsDeleting(false); }
            };

            if(loading) return <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white animate-pulse">Loading OGHza...</div>;

            return (
                <div className={`min-h-screen transition-colors duration-300 ${theme === 'dark' ? 'text-slate-100' : 'text-slate-900'}`}>
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    {rewardData && <RewardPopup data={rewardData} onClose={() => setRewardData(null)} />}
                    {showDeleteConfirm && <ConfirmModal title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?" message="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ" onConfirm={handleConfirmDeleteHistory} onCancel={() => { setShowDeleteConfirm(false); setDeleteTargetId(null); }} isProcessing={isDeleting} />}
                    {showSaleModal && (
                        <div className="fixed inset-0 z-[1000] flex items-center justify-center p-6 bg-black/80 backdrop-blur-xl animate-in fade-in duration-300" onClick={() => setShowSaleModal(false)}>
                            <div className={`max-w-md w-full p-8 rounded-[2.5rem] shadow-2xl border relative ${theme === 'dark' ? 'bg-slate-900 border-slate-800' : 'bg-white border-stone-200'}`} onClick={e => e.stopPropagation()}>
                                <button onClick={() => setShowSaleModal(false)} className={`absolute top-6 right-6 ${theme === 'dark' ? 'text-slate-500' : 'text-stone-400'}`}><Icon name="X" size={20} /></button>
                                <h2 className={`text-2xl font-black italic uppercase mb-6 ${theme === 'dark' ? 'text-white' : 'text-stone-800'}`}>‡∏Ç‡∏≤‡∏¢‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</h2>
                                <div className="space-y-4">
                                    <div className="flex justify-center mb-4">{saleItem === 'spell' ? <SVGs.Spell className="w-16 h-16 drop-shadow-xl" /> : <SVGs.Magic className="w-16 h-16 drop-shadow-xl" />}</div>
                                    <div className="space-y-2 text-left">
                                        <label className={`text-[10px] font-bold uppercase tracking-widest ${theme === 'dark' ? 'text-slate-400' : 'text-stone-500'}`}>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ç‡∏≤‡∏¢ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: {maxSaleQty})</label>
                                        <input 
                                            type="text" 
                                            inputMode="numeric" 
                                            value={saleFormData.quantity} 
                                            onChange={e => {
                                                const val = e.target.value;
                                                if (val === '' || /^\d*$/.test(val)) {
                                                    if (val !== '' && parseInt(val) > maxSaleQty) {
                                                        setSaleFormData(p => ({...p, quantity: maxSaleQty.toString()}));
                                                    } else {
                                                        setSaleFormData(p => ({...p, quantity: val}));
                                                    }
                                                }
                                            }}
                                            className={`w-full p-4 rounded-xl font-bold outline-none text-xl ${theme === 'dark' ? 'bg-slate-950 text-white' : 'bg-stone-100 text-stone-800'}`} 
                                        />
                                    </div>
                                    <div className="space-y-2 text-left">
                                        <label className={`text-[10px] font-bold uppercase tracking-widest ${theme === 'dark' ? 'text-slate-400' : 'text-stone-500'}`}>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô</label>
                                        <input 
                                            type="text" 
                                            inputMode="numeric" 
                                            value={saleFormData.price} 
                                            onFocus={(e) => {
                                                const defaultPrice = globalPrices[saleItem === 'spell' ? 'purpleStonePrice' : 'contMagicPrice'].toString();
                                                if(e.target.value === defaultPrice) setSaleFormData(p => ({...p, price: ''}));
                                            }}
                                            onChange={e => handleNumberInput(e, 'price', setSaleFormData)}
                                            className={`w-full p-4 rounded-xl font-bold outline-none text-xl ${theme === 'dark' ? 'bg-slate-950 text-white' : 'bg-stone-100 text-stone-800'}`} 
                                        />
                                    </div>
                                    <button onClick={handleManualSellSubmit} className="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-2xl font-black text-xs uppercase shadow-lg transition-all active:scale-95 mt-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-md mx-auto min-h-screen relative">
                        {/* PAGES */}
                        {activeTab === 'home' && <HomeView records={records} prices={globalPrices} userStats={userStats} goToTab={goToTab} />}
                        {activeTab === 'history' && <HistoryView records={records} onEdit={(r) => { setEditRecordId(r.id); setActiveTab('add'); }} onDelete={(id) => {
                             setDeleteTargetId(id);
                             setShowDeleteConfirm(true);
                        }} />}
                        {activeTab === 'inventory' && <InventoryView records={records} prices={globalPrices} manualSales={manualSales} onSell={(item, maxQty) => { setSaleItem(item); setMaxSaleQty(maxQty); setSaleFormData({ quantity: maxQty.toString(), price: globalPrices[item === 'spell' ? 'purpleStonePrice' : 'contMagicPrice'].toString() }); setShowSaleModal(true); }} goToTab={goToTab} />}
                        {activeTab === 'profile' && <ProfileView stats={userStats} records={records} db={db} uid={targetUid} showToast={showToast} goToTab={goToTab} />}
                        {activeTab === 'settings' && <SettingsView uid={targetUid} prices={globalPrices} theme={theme} setTheme={setTheme} setTargetUid={setTargetUid} authError={authError} showToast={showToast} db={db} />}
                        
                        {/* ADD PAGE */}
                        {activeTab === 'add' && (
                            <AddDataView 
                                onClose={() => setActiveTab('home')} 
                                targetUid={targetUid} 
                                db={db} 
                                prices={globalPrices} 
                                editRecord={records.find(r => r.id === editRecordId)} 
                                theme={theme} 
                                onSuccess={(reward) => { 
                                    showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); 
                                    if(reward) setRewardData(reward);
                                    setActiveTab('home'); 
                                }} 
                                userStats={userStats} 
                                allRecords={records} 
                                setGlobalIsSaving={setIsSaving}
                                setIsFormValid={setIsFormValid}
                            />
                        )}

                    </div>

                    {/* BOTTOM NAV - Hide when on Add page */}
                    {activeTab !== 'add' && (
                        <nav className={`fixed bottom-0 left-0 right-0 max-w-md mx-auto border-t pb-safe pt-2 px-4 flex justify-between items-center z-40 ${theme === 'dark' ? 'bg-slate-900/90 border-slate-800' : 'bg-white/90 border-slate-200'} backdrop-blur-md text-[9px] font-bold`}>
                            <NavButton icon="Home" label="‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å" active={activeTab === 'home'} onClick={() => setActiveTab('home')} />
                            <NavButton icon="History" label="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥" active={activeTab === 'history'} onClick={() => setActiveTab('history')} />
                            <div className="relative -top-6">
                                <button onClick={() => { setEditRecordId(null); setActiveTab('add'); setIsFormValid(false); }} className="w-14 h-14 rounded-full bg-gradient-to-tr from-purple-600 to-indigo-600 text-white shadow-lg shadow-purple-500/40 flex items-center justify-center transform transition-transform active:scale-95">
                                    <Icon name="Plus" size={28} />
                                </button>
                            </div>
                            <NavButton icon="Box" label="‡∏Ñ‡∏•‡∏±‡∏á" active={activeTab === 'inventory'} onClick={() => setActiveTab('inventory')} />
                            <NavButton icon="Settings" label="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" active={activeTab === 'settings'} onClick={() => setActiveTab('settings')} />
                        </nav>
                    )}

                    {/* BOTTOM NAV (ADD MODE) */}
                    {activeTab === 'add' && (
                        <nav className={`fixed bottom-0 left-0 right-0 max-w-md mx-auto border-t pb-safe pt-2 px-4 flex justify-between items-center z-40 ${theme === 'dark' ? 'bg-slate-900/90 border-slate-800' : 'bg-white/90 border-slate-200'} backdrop-blur-md text-[9px] font-bold`}>
                            <NavButton icon="Home" label="‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å" onClick={() => setActiveTab('home')} />
                            <NavButton icon="History" label="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥" onClick={() => setActiveTab('history')} />
                            <div className="relative -top-6">
                                <button 
                                    type="submit" 
                                    form="add-data-form" 
                                    disabled={!isFormValid || isSaving}
                                    className={`w-14 h-14 rounded-full flex items-center justify-center transform transition-transform active:scale-95 text-white ${!isFormValid || isSaving ? 'bg-slate-600' : 'bg-gradient-to-tr from-emerald-500 to-teal-500 shadow-lg shadow-emerald-500/40'}`}
                                >
                                    {isSaving ? <Icon name="Loader" size={24} className="animate-spin" /> : <Icon name="Save" size={24} />}
                                </button>
                            </div>
                            <NavButton icon="Box" label="‡∏Ñ‡∏•‡∏±‡∏á" onClick={() => setActiveTab('inventory')} />
                            <NavButton icon="Settings" label="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" onClick={() => setActiveTab('settings')} />
                        </nav>
                    )}
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>

